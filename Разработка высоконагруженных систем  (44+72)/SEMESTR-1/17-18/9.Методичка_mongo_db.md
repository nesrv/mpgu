# –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –ò–∑—É—á–µ–Ω–∏–µ mongodb

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ü–µ—Ä–µ–π—Ç–∏ –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞
```bash
cd LAB-REDIS-MONGO
```


### 2. –ü–æ–¥–Ω—è—Ç—å MongoDB –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
docker-compose.yml

```sh
services:
  mongodb:
    image: mongo:7
    env_file:
      - .env
    ports:
      - "27017:27017"
```


.env

```sh
MONGO_INITDB_ROOT_USERNAME=student
MONGO_INITDB_ROOT_PASSWORD=password

MONGODB_URL=mongodb://student:password@mongodb:27017/

```

```sh
docker-compose up --build -d
```

### 3. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–º—É –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É MongoDB Compass 

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞
1. –°–∫–∞—á–∞—Ç—å —Å https://github.com/mongodb-js/compass/releases/download/v1.48.2/mongodb-compass-1.48.2-win32-x64.msi

2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å MongoDB Compass

### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
**Connection String:**
```
mongodb://student:password@localhost:27017/
```


### 4. –®–ø–∞—Ä–≥–∞–ª–∫–∞ –ø–æ —Ä–∞–±–æ—Ç–µ –≤ MongoDB Compass

#### üìå –ù–∞–≤–∏–≥–∞—Ü–∏—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
1. **–í—ã–±–æ—Ä –ë–î:** –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å ‚Üí –í—ã–±—Ä–∞—Ç—å `library` (–∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É `+`)
2. **–í—ã–±–æ—Ä –∫–æ–ª–ª–µ–∫—Ü–∏–∏:** –ö–ª–∏–∫–Ω—É—Ç—å –Ω–∞ `authors` –∏–ª–∏ `books`
3. **–í–∫–ª–∞–¥–∫–∏:**
   - **Documents** ‚Äî –ø—Ä–æ—Å–º–æ—Ç—Ä/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
   - **Aggregations** ‚Äî –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ pipeline –∞–≥—Ä–µ–≥–∞—Ü–∏–∏
   - **Schema** ‚Äî –∞–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö
   - **Indexes** ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞–º–∏


```js
// MongoDB –ë—ã—Å—Ç—Ä–∞—è —à–ø–∞—Ä–≥–∞–ª–∫–∞

// === –ó–ê–ü–£–°–ö MONGOSH ===
// –ò–∑ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏:
// mongosh --username student --password password
// –ò–ª–∏ –∏–∑ Docker:
// docker-compose exec mongodb mongosh --username student --password password

// === –û–°–ù–û–í–ù–´–ï –ö–û–ú–ê–ù–î–´ ===
show dbs;              // –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
show collections;      // –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –≤ —Ç–µ–∫—É—â–µ–π –ë–î
db;                    // –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â—É—é –ë–î
help;                  // –°–ø—Ä–∞–≤–∫–∞
exit;                  // –í—ã—Ö–æ–¥

// === –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï ===
use library;           // –í—ã–±—Ä–∞—Ç—å/—Å–æ–∑–¥–∞—Ç—å –ë–î

// === CREATE (–°–æ–∑–¥–∞–Ω–∏–µ) ===
db.authors.insertOne({name: "–¢–æ–ª—Å—Ç–æ–π", birthYear: 1828});
db.authors.insertMany([
  {name: "–¢–æ–ª—Å—Ç–æ–π", birthYear: 1828},
  {name: "–î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π", birthYear: 1821}
]);

// === READ (–ß—Ç–µ–Ω–∏–µ) ===
db.authors.find();                              // –í—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
db.authors.findOne({name: "–¢–æ–ª—Å—Ç–æ–π"});          // –û–¥–∏–Ω –¥–æ–∫—É–º–µ–Ω—Ç
db.books.find({pages: {$gt: 500}});             // –ë–æ–ª—å—à–µ 500 —Å—Ç—Ä–∞–Ω–∏—Ü
db.books.find({genre: "—Ä–æ–º–∞–Ω"}).limit(5);       // –ü–µ—Ä–≤—ã–µ 5

// === UPDATE (–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ) ===
db.authors.updateOne(
  {name: "–¢–æ–ª—Å—Ç–æ–π"},                  // –§–∏–ª—å—Ç—Ä
  {$set: {country: "–†–æ—Å—Å–∏—è"}}         // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ
);
db.books.updateMany(
  {genre: "—Ä–æ–º–∞–Ω"},
  {$set: {category: "–∫–ª–∞—Å—Å–∏–∫–∞"}}
);

// === DELETE (–£–¥–∞–ª–µ–Ω–∏–µ) ===
db.authors.deleteOne({name: "–¢–æ–ª—Å—Ç–æ–π"});
db.books.deleteMany({pages: {$lt: 100}});

// === –û–ü–ï–†–ê–¢–û–†–´ –ó–ê–ü–†–û–°–û–í ===
{price: {$gt: 1000}}    // –ë–æ–ª—å—à–µ
{price: {$gte: 1000}}   // –ë–æ–ª—å—à–µ –∏–ª–∏ —Ä–∞–≤–Ω–æ
{price: {$lt: 1000}}    // –ú–µ–Ω—å—à–µ
{price: {$lte: 1000}}   // –ú–µ–Ω—å—à–µ –∏–ª–∏ —Ä–∞–≤–Ω–æ
{price: {$ne: 1000}}    // –ù–µ —Ä–∞–≤–Ω–æ

// –õ–æ–≥–∏—á–µ—Å–∫–∏–µ
{$and: [{pages: {$gt: 500}}, {genre: "—Ä–æ–º–∞–Ω"}]}
{$or: [{genre: "—Ä–æ–º–∞–Ω"}, {genre: "–ø–æ–≤–µ—Å—Ç—å"}]}

// –ú–∞—Å—Å–∏–≤—ã
{tags: {$in: ["–∫–ª–∞—Å—Å–∏–∫–∞", "—Ä–æ–º–∞–Ω"]}}      // –ï—Å—Ç—å –≤ –º–∞—Å—Å–∏–≤–µ
{tags: {$nin: ["—Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞"]}}            // –ù–µ—Ç –≤ –º–∞—Å—Å–∏–≤–µ

// === –ê–ì–†–ï–ì–ê–¶–ò–Ø ===

// –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞
db.books.aggregate([
  {
    $group: {
      _id: "$genre",              // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ –∂–∞–Ω—Ä—É
      count: {$sum: 1},           // –ü–æ–¥—Å—á–µ—Ç
      avgPages: {$avg: "$pages"}  // –°—Ä–µ–¥–Ω–µ–µ
    }
  }
]);

// –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏ –ª–∏–º–∏—Ç
db.books.aggregate([
  {$sort: {pages: -1}},  // -1 = —É–±—ã–≤–∞–Ω–∏–µ, 1 = –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏–µ
  {$limit: 5}
]);

// –ü—Ä–æ–µ–∫—Ü–∏—è (–≤—ã–±–æ—Ä –ø–æ–ª–µ–π)
db.books.aggregate([
  {
    $project: {
      title: 1,                    // –í–∫–ª—é—á–∏—Ç—å
      authorName: "$author.name",  // –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å
      _id: 0                       // –ò—Å–∫–ª—é—á–∏—Ç—å
    }
  }
]);

// Lookup (JOIN)
db.books.aggregate([
  {
    $lookup: {
      from: "authors",        // –ò–∑ –∫–∞–∫–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏
      localField: "authorId", // –ü–æ–ª–µ –≤ books
      foreignField: "_id",    // –ü–æ–ª–µ –≤ authors
      as: "author"            // –ò–º—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—è
    }
  },
  {$unwind: "$author"}  // –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –º–∞—Å—Å–∏–≤ –≤ –æ–±—ä–µ–∫—Ç
]);

// === –ü–û–õ–ï–ó–ù–´–ï –ö–û–ú–ê–ù–î–´ ===
db.books.countDocuments({genre: "—Ä–æ–º–∞–Ω"});  // –ü–æ–¥—Å—á–µ—Ç
db.books.distinct("genre");                 // –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
show collections;                           // –°–ø–∏—Å–æ–∫ –∫–æ–ª–ª–µ–∫—Ü–∏–π
db.books.drop();                            // –£–¥–∞–ª–∏—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é
```


### 4a. –†–∞–±–æ—Ç–∞ –≤ MONGODB COMPASS (GUI)

#### CREATE (–°–æ–∑–¥–∞–Ω–∏–µ)
1. –í—ã–±—Ä–∞—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, `authors`)
2. –ù–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É **INSERT DOCUMENT**
3. –í–≤–µ—Å—Ç–∏ JSON:
```json
{"name": "–¢–æ–ª—Å—Ç–æ–π", "birthYear": 1828, "country": "–†–æ—Å—Å–∏—è"}
{"name": "–ü—É—à–∫–∏–Ω", "birthYear": 1799, "country": "–†–æ—Å—Å–∏—è"}
```
4. –ù–∞–∂–∞—Ç—å **INSERT**

---

#### READ (–ß—Ç–µ–Ω–∏–µ)
1. –û—Ç–∫—Ä—ã—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é
2. –í –ø–æ–ª–µ **Filter** –≤–≤–µ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å:

**–ù–∞–π—Ç–∏ –ø–æ –¥—Ä**
```json
{"birthYear": "1928"}
```

**–° 1800 –≥–æ–¥–∞:**
```json
{"birthYear": {"$gt": 1800}}
{"pages": {"$gt": 500}}
```

**–° 1799 –≥–æ–¥–∞:**
```json
{"publishedYear": {"$gte": 1900}}
```

3. –ù–∞–∂–∞—Ç—å **FIND**

---

#### UPDATE (–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ)
1. –ù–∞–π—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç —á–µ—Ä–µ–∑ Filter
2. –ù–∞–≤–µ—Å—Ç–∏ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç ‚Üí –Ω–∞–∂–∞—Ç—å –∏–∫–æ–Ω–∫—É –∫–∞—Ä–∞–Ω–¥–∞—à–∞ ‚úèÔ∏è (Edit)
3. –ò–∑–º–µ–Ω–∏—Ç—å –ø–æ–ª—è –≤ JSON
4. –ù–∞–∂–∞—Ç—å **UPDATE**

---

#### DELETE (–£–¥–∞–ª–µ–Ω–∏–µ)
1. –ù–∞–π—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç
2. –ù–∞–≤–µ—Å—Ç–∏ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç ‚Üí –Ω–∞–∂–∞—Ç—å –∏–∫–æ–Ω–∫—É –∫–æ—Ä–∑–∏–Ω—ã üóëÔ∏è (Delete)
3. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ

---

#### AGGREGATIONS (–ê–≥—Ä–µ–≥–∞—Ü–∏—è)
1. –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É **Aggregations**
2. –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞–¥–∏–∏ pipeline:
   - **Stage 1:** `{"$match": {"genre": "—Ä–æ–º–∞–Ω"}}`
   - **Stage 2:** `{"$sort": {"pages": -1}}`
   - **Stage 3:** `{"$limit": 5}`
3. –ù–∞–∂–∞—Ç—å **RUN** –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

---

#### INDEXES (–ò–Ω–¥–µ–∫—Å—ã)
1. –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É **Indexes**
2. –ù–∞–∂–∞—Ç—å **CREATE INDEX**
3. –£–∫–∞–∑–∞—Ç—å –ø–æ–ª—è: `{"name": 1}` (1 = –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏–µ, -1 = —É–±—ã–≤–∞–Ω–∏–µ)
4. –î–∞—Ç—å –∏–º—è –∏–Ω–¥–µ–∫—Å—É
5. –ù–∞–∂–∞—Ç—å **CREATE**

---

#### SCHEMA (–°—Ö–µ–º–∞)
1. –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É **Schema**
2. –ù–∞–∂–∞—Ç—å **ANALYZE SCHEMA**
3. –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π

---

#### EXPORT/IMPORT

**Export:**
1. Collection ‚Üí **Export Collection**
2. –í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç (JSON/CSV)
3. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∞–π–ª

**Import:**
1. Collection ‚Üí **Import Data**
2. –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
3. –ù–∞–∂–∞—Ç—å **IMPORT**


## 5. –ü–æ–¥–Ω—è—Ç—å —Ñ–∞—Å—Ç–∞–ø–∏-—Å–µ—Ä–≤–µ—Ä

```py
from fastapi import FastAPI
from pymongo import MongoClient
import uvicorn

app = FastAPI()

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MongoDB
client = MongoClient("mongodb://student:password@localhost:27017/")
db = client.testdb

@app.get("/")
def root():
    return {"message": "MongoDB FastAPI Server"}

@app.get("/ping")
def ping_mongodb():
    try:
        client.admin.command('ping')
        return {"status": "success", "message": "MongoDB connected"}
    except Exception as e:
        return {"status": "error", "message": str(e)}

@app.get("/collections")
def list_collections():
    collections = db.list_collection_names()
    return {"collections": collections}

if __name__ == "__main__":
    uvicorn.run(app, host="127.0.0.1", port=8000)
```


### 6. –ù–∞–∫–∞—Ç–∏—Ç—å —Ñ–∏–∫—Å—Ç—É—Ä—É

[—Ñ–∏–∫—Å—Ç—É—Ä–∞](library.js)

### 7. –û—Ç—Ä–∞–±–æ—Ç–∞—Ç—å CRUDs

```py
from pymongo import MongoClient
from bson import ObjectId
from pydantic import BaseModel


# –ú–æ–¥–µ–ª–∏
class Author(BaseModel):
    name: str
    birthYear: int
    country: str

class Book(BaseModel):
    title: str
    authorId: str
    pages: int
    publishedYear: int
    genre: str

class Review(BaseModel):
    bookId: str
    rating: int
    comment: str
    reviewerName: str

# CRUD –¥–ª—è –∞–≤—Ç–æ—Ä–æ–≤
@app.get("/authors")
def get_authors():
    # –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ—Ö –∞–≤—Ç–æ—Ä–æ–≤ –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
    authors = list(db.authors.find())
    # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å ObjectId –≤ —Å—Ç—Ä–æ–∫—É –¥–ª—è JSON
    for author in authors:
        author["_id"] = str(author["_id"])
    return authors

@app.post("/authors")
def create_author(author: Author):
    # –í—Å—Ç–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –∞–≤—Ç–æ—Ä–∞ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é
    result = db.authors.insert_one(author.dict())
    return {"id": str(result.inserted_id)}

@app.get("/authors/{author_id}")
def get_author(author_id: str):
    # –ù–∞–π—Ç–∏ –∞–≤—Ç–æ—Ä–∞ –ø–æ ID
    try:
        author = db.authors.find_one({"_id": ObjectId(author_id)})
    except:
        raise HTTPException(status_code=400, detail="Invalid ObjectId format")
    if not author:
        raise HTTPException(status_code=404, detail="Author not found")
    author["_id"] = str(author["_id"])
    return author

# CRUD –¥–ª—è –∫–Ω–∏–≥
@app.get("/books")
def get_books():
    # –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∫–Ω–∏–≥–∏
    ...
    return books

@app.post("/books")
def create_book(book: Book):
    # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å authorId –∏–∑ —Å—Ç—Ä–æ–∫–∏ –≤ ObjectId
    ...
    # –í—Å—Ç–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é
    ...
    return {"id": str(result.inserted_id)}

@app.get("/books/{book_id}")
def get_book(book_id: str):
    # –ù–∞–π—Ç–∏ –∫–Ω–∏–≥—É –ø–æ ID
  ...
    return book

# CRUD –¥–ª—è –æ—Ç–∑—ã–≤–æ–≤
@app.get("/reviews")
def get_reviews():
    ...
    return reviews

@app.post("/reviews")
def create_review(review: Review):
   ...
    return {"id": str(result.inserted_id)}

@app.get("/reviews/book/{book_id}")
def get_book_reviews(book_id: str):
   ...
    return reviews

# –ê–≥—Ä–µ–≥–∞—Ü–∏—è: –∫–Ω–∏–≥–∏ —Å –∞–≤—Ç–æ—Ä–∞–º–∏
@app.get("/books-with-authors")
def get_books_with_authors():
    # Pipeline –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏
    pipeline = [
        {
            # $lookup - —Å–æ–µ–¥–∏–Ω—è–µ—Ç –∫–æ–ª–ª–µ–∫—Ü–∏–∏ books –∏ authors
            "$lookup": {
                "from": "authors",           # –ò–∑ –∫–∞–∫–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏
                "localField": "authorId",    # –ü–æ–ª–µ –≤ books
                "foreignField": "_id",       # –ü–æ–ª–µ –≤ authors
                "as": "author"               # –ò–º—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—è
            }
        },
        # $unwind - —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç –º–∞—Å—Å–∏–≤ author –≤ –æ–±—ä–µ–∫—Ç
        {"$unwind": "$author"}
    ]
    # –í—ã–ø–æ–ª–Ω–∏—Ç—å –∞–≥—Ä–µ–≥–∞—Ü–∏—é
    books = list(db.books.aggregate(pipeline))
    # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å ObjectId –≤ —Å—Ç—Ä–æ–∫—É
    for book in books:
        book["_id"] = str(book["_id"])
        book["authorId"] = str(book["authorId"])
        book["author"]["_id"] = str(book["author"]["_id"])
    return books

```

### 7. –û—Ç—Ä–∞–±–æ—Ç–∫–∞ –∞–≥—Ä–µ–≥–∞—Ü–∏–π –≤ MongoDB Compass Shell

> **–¶–µ–ª—å:** –ù–∞—É—á–∏—Ç—å—Å—è –ø–∏—Å–∞—Ç—å –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–≥—Ä–µ–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤ MongoDB Shell –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–Ω–æ—Å–æ–º –≤ FastAPI

#### –ö–∞–∫ –æ—Ç–∫—Ä—ã—Ç—å MongoDB Shell –≤ Compass:
1. –û—Ç–∫—Ä—ã—Ç—å MongoDB Compass
2. –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
3. –í–Ω–∏–∑—É –æ–∫–Ω–∞ –Ω–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É `>_MONGOSH` (MongoDB Shell)
4. –í—ã–±—Ä–∞—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö: `use library`

---

#### –ó–∞–¥–∞–Ω–∏–µ 1: –¢–æ–ø-5 —Å–∞–º—ã—Ö –¥–ª–∏–Ω–Ω—ã—Ö –∫–Ω–∏–≥

```js
// –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö
db.books.findOne()  // –°–º–æ—Ç—Ä–∏–º, –∫–∞–∫–∏–µ –ø–æ–ª—è –µ—Å—Ç—å –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏

// –®–∞–≥ 2: –ü—Ä–æ—Å—Ç–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏ –ª–∏–º–∏—Ç
db.books.find().sort({pages: -1}).limit(5)
// –†–µ–∑—É–ª—å—Ç–∞—Ç: 5 –∫–Ω–∏–≥, –Ω–æ –±–µ–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞–≤—Ç–æ—Ä–∞—Ö

// –®–∞–≥ 3: –î–æ–±–∞–≤–ª—è–µ–º –∞–≥—Ä–µ–≥–∞—Ü–∏—é —Å $lookup
db.books.aggregate([
  {$sort: {pages: -1}},
  {$limit: 5},
  {
    $lookup: {
      from: "authors",
      localField: "authorId",
      foreignField: "_id",
      as: "author"
    }
  }
])
// –†–µ–∑—É–ª—å—Ç–∞—Ç: author —Ç–µ–ø–µ—Ä—å –º–∞—Å—Å–∏–≤ [{}], –Ω—É–∂–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å

// –®–∞–≥ 4: –î–æ–±–∞–≤–ª—è–µ–º $unwind
db.books.aggregate([
  {$sort: {pages: -1}},
  {$limit: 5},
  {
    $lookup: {
      from: "authors",
      localField: "authorId",
      foreignField: "_id",
      as: "author"
    }
  },
  {$unwind: "$author"}
])
// –†–µ–∑—É–ª—å—Ç–∞—Ç: author —Ç–µ–ø–µ—Ä—å –æ–±—ä–µ–∫—Ç {}, –Ω–æ –º–Ω–æ–≥–æ –ª–∏—à–Ω–∏—Ö –ø–æ–ª–µ–π

// –®–∞–≥ 5: –î–æ–±–∞–≤–ª—è–µ–º $project –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø–æ–ª–µ–π
db.books.aggregate([
  {$sort: {pages: -1}},
  {$limit: 5},
  {
    $lookup: {
      from: "authors",
      localField: "authorId",
      foreignField: "_id",
      as: "author"
    }
  },
  {$unwind: "$author"},
  {
    $project: {
      title: 1,
      pages: 1,
      authorName: "$author.name",
      publishedYear: 1
    }
  }
])
// ‚úÖ –ì–æ—Ç–æ–≤–æ! –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å –≤ FastAPI
```

---

#### –ó–∞–¥–∞–Ω–∏–µ 2: –°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥ –∫–∞–∂–¥–æ–π –∫–Ω–∏–≥–∏

```js
// –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—Ç–∑—ã–≤–æ–≤
db.reviews.findOne()

// –®–∞–≥ 2: –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –æ—Ç–∑—ã–≤—ã –ø–æ bookId
db.reviews.aggregate([
  {
    $group: {
      _id: "$bookId",
      avgRating: {$avg: "$rating"},
      reviewCount: {$sum: 1}
    }
  }
])
// –†–µ–∑—É–ª—å—Ç–∞—Ç: –µ—Å—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, –Ω–æ –Ω–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–π –∫–Ω–∏–≥

// –®–∞–≥ 3: –î–æ–±–∞–≤–ª—è–µ–º $lookup –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π
db.reviews.aggregate([
  {
    $group: {
      _id: "$bookId",
      avgRating: {$avg: "$rating"},
      reviewCount: {$sum: 1}
    }
  },
  {
    $lookup: {
      from: "books",
      localField: "_id",
      foreignField: "_id",
      as: "book"
    }
  },
  {$unwind: "$book"}
])

// –®–∞–≥ 4: –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—ã–≤–æ–¥ –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º
db.reviews.aggregate([
  {
    $group: {
      _id: "$bookId",
      avgRating: {$avg: "$rating"},
      reviewCount: {$sum: 1}
    }
  },
  {
    $lookup: {
      from: "books",
      localField: "_id",
      foreignField: "_id",
      as: "book"
    }
  },
  {$unwind: "$book"},
  {
    $project: {
      title: "$book.title",
      avgRating: {$round: ["$avgRating", 2]},
      reviewCount: 1
    }
  },
  {$sort: {avgRating: -1}}
])
// ‚úÖ –ì–æ—Ç–æ–≤–æ!
```

---

#### –ó–∞–¥–∞–Ω–∏–µ 3: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∞–≤—Ç–æ—Ä–∞–º

```js
// –®–∞–≥ 1: –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∫–Ω–∏–≥–∏ –ø–æ authorId
db.books.aggregate([
  {
    $group: {
      _id: "$authorId",
      bookCount: {$sum: 1},
      totalPages: {$sum: "$pages"},
      avgPages: {$avg: "$pages"}
    }
  }
])
// –†–µ–∑—É–ª—å—Ç–∞—Ç: —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –µ—Å—Ç—å, –Ω–æ –Ω–µ—Ç –∏–º–µ–Ω –∞–≤—Ç–æ—Ä–æ–≤

// –®–∞–≥ 2: –î–æ–±–∞–≤–ª—è–µ–º –∏–º–µ–Ω–∞ –∞–≤—Ç–æ—Ä–æ–≤ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º
db.books.aggregate([
  {
    $group: {
      _id: "$authorId",
      bookCount: {$sum: 1},
      totalPages: {$sum: "$pages"},
      avgPages: {$avg: "$pages"}
    }
  },
  {
    $lookup: {
      from: "authors",
      localField: "_id",
      foreignField: "_id",
      as: "author"
    }
  },
  {$unwind: "$author"},
  {
    $project: {
      authorName: "$author.name",
      bookCount: 1,
      totalPages: 1,
      avgPages: {$round: ["$avgPages", 0]}
    }
  },
  {$sort: {bookCount: -1}}
])
// ‚úÖ –ì–æ—Ç–æ–≤–æ!
```

---

#### –ó–∞–¥–∞–Ω–∏–µ 4: –ö–Ω–∏–≥–∏ –ø–æ –∂–∞–Ω—Ä–∞–º

```js
// –®–∞–≥ 1: –ü—Ä–æ—Å—Ç–∞—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞
db.books.aggregate([
  {
    $group: {
      _id: "$genre",
      count: {$sum: 1}
    }
  }
])
// –†–µ–∑—É–ª—å—Ç–∞—Ç: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–Ω–∏–≥ –ø–æ –∂–∞–Ω—Ä–∞–º

// –®–∞–≥ 2: –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–Ω–∏–≥ –∏ —Å—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–∞–Ω–∏—Ü
db.books.aggregate([
  {
    $group: {
      _id: "$genre",
      count: {$sum: 1},
      books: {$push: "$title"},      // –°–æ–±–∏—Ä–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –≤ –º–∞—Å—Å–∏–≤
      avgPages: {$avg: "$pages"}
    }
  },
  {$sort: {count: -1}}
])
// ‚úÖ –ì–æ—Ç–æ–≤–æ! –í–∏–¥–∏–º –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –∂–∞–Ω—Ä—ã –∏ —Å–ø–∏—Å–æ–∫ –∫–Ω–∏–≥ –≤ –∫–∞–∂–¥–æ–º
```

---

#### –ó–∞–¥–∞–Ω–∏–µ 5: –ü–æ–∏—Å–∫ –∫–Ω–∏–≥ –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω—É –ª–µ—Ç

```js
// –®–∞–≥ 1: –ü—Ä–æ—Å—Ç–æ–π —Ñ–∏–ª—å—Ç—Ä
db.books.find({
  publishedYear: {$gte: 1850, $lte: 1900}
})
// –†–µ–∑—É–ª—å—Ç–∞—Ç: –∫–Ω–∏–≥–∏ –Ω–∞–π–¥–µ–Ω—ã, –Ω–æ –±–µ–∑ –∞–≤—Ç–æ—Ä–æ–≤

// –®–∞–≥ 2: –ü–µ—Ä–µ–≤–æ–¥–∏–º –≤ –∞–≥—Ä–µ–≥–∞—Ü–∏—é —Å $match
db.books.aggregate([
  {
    $match: {
      publishedYear: {$gte: 1850, $lte: 1900}
    }
  }
])

// –®–∞–≥ 3: –î–æ–±–∞–≤–ª—è–µ–º –∞–≤—Ç–æ—Ä–æ–≤ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º
db.books.aggregate([
  {
    $match: {
      publishedYear: {$gte: 1850, $lte: 1900}
    }
  },
  {
    $lookup: {
      from: "authors",
      localField: "authorId",
      foreignField: "_id",
      as: "author"
    }
  },
  {$unwind: "$author"},
  {
    $project: {
      title: 1,
      authorName: "$author.name",
      publishedYear: 1,
      genre: 1
    }
  },
  {$sort: {publishedYear: 1}}
])
// ‚úÖ –ì–æ—Ç–æ–≤–æ! –ú–µ–Ω—è–µ–º –≥–æ–¥—ã –≤ $match –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤
```

---

#### –ö–Ω–∏–≥–∏ –±–µ–∑ –æ—Ç–∑—ã–≤–æ–≤

```js
// –®–∞–≥ 1: –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º –æ—Ç–∑—ã–≤—ã –∫ –∫–Ω–∏–≥–∞–º
db.books.aggregate([
  {
    $lookup: {
      from: "reviews",
      localField: "_id",
      foreignField: "bookId",
      as: "reviews"
    }
  }
])
// –†–µ–∑—É–ª—å—Ç–∞—Ç: —É –∫–∞–∂–¥–æ–π –∫–Ω–∏–≥–∏ –µ—Å—Ç—å –ø–æ–ª–µ reviews (–º–∞—Å—Å–∏–≤)

// –®–∞–≥ 2: –§–∏–ª—å—Ç—Ä—É–µ–º –∫–Ω–∏–≥–∏ —Å –ø—É—Å—Ç—ã–º –º–∞—Å—Å–∏–≤–æ–º –æ—Ç–∑—ã–≤–æ–≤
db.books.aggregate([
  {
    $lookup: {
      from: "reviews",
      localField: "_id",
      foreignField: "bookId",
      as: "reviews"
    }
  },
  {
    $match: {
      reviews: {$size: 0}  // –†–∞–∑–º–µ—Ä –º–∞—Å—Å–∏–≤–∞ = 0
    }
  }
])

// –®–∞–≥ 3: –î–æ–±–∞–≤–ª—è–µ–º –∞–≤—Ç–æ—Ä–æ–≤ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º
db.books.aggregate([
  {
    $lookup: {
      from: "reviews",
      localField: "_id",
      foreignField: "bookId",
      as: "reviews"
    }
  },
  {
    $match: {
      reviews: {$size: 0}
    }
  },
  {
    $lookup: {
      from: "authors",
      localField: "authorId",
      foreignField: "_id",
      as: "author"
    }
  },
  {$unwind: "$author"},
  {
    $project: {
      title: 1,
      authorName: "$author.name",
      publishedYear: 1
    }
  }
])
// ‚úÖ –ì–æ—Ç–æ–≤–æ! –ù–∞—à–ª–∏ –∫–Ω–∏–≥–∏, –∫–æ—Ç–æ—Ä—ã–º –Ω—É–∂–Ω—ã –æ—Ç–∑—ã–≤—ã
```

---

### üí° –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏:

```js
// –ü–æ–¥—Å—á–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
db.books.countDocuments()

// –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–µ—Ä–≤—ã—Ö N –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
db.books.find().limit(3)

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ–¥–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞
db.books.findOne()

// –û—á–∏—Å—Ç–∫–∞ —ç–∫—Ä–∞–Ω–∞
cls  // –∏–ª–∏ clear

// –ö—Ä–∞—Å–∏–≤—ã–π –≤—ã–≤–æ–¥
db.books.find().pretty()

// –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
db.books.find({genre: "—Ä–æ–º–∞–Ω"}).explain("executionStats")
```

---

### 8. –°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞

```py
# –ó–∞–¥–∞–Ω–∏–µ 1: –¢–æ–ø-5 —Å–∞–º—ã—Ö –¥–ª–∏–Ω–Ω—ã—Ö –∫–Ω–∏–≥
@app.get("/books/longest")
def get_longest_books():
    """–ù–∞–π—Ç–∏ 5 —Å–∞–º—ã—Ö –¥–ª–∏–Ω–Ω—ã—Ö –∫–Ω–∏–≥ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –∞–≤—Ç–æ—Ä–∞—Ö"""
    pipeline = [
       # –®–∞–≥ 1: –°–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ –∫–Ω–∏–≥–∏ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Å—Ç—Ä–∞–Ω–∏—Ü (–æ—Ç –±–æ–ª—å—à–µ–≥–æ –∫ –º–µ–Ω—å—à–µ–º—É)
        ...,  # -1 = –ø–æ —É–±—ã–≤–∞–Ω–∏—é (DESC)
        
        # –®–∞–≥ 2: –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 5 –∫–Ω–∏–≥ –ø–æ—Å–ª–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        ...,
        
        # –®–∞–≥ 3: –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–≤—Ç–æ—Ä–∞—Ö (–∞–Ω–∞–ª–æ–≥ JOIN –≤ SQL)
       ...,
        
        # –®–∞–≥ 4: –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –º–∞—Å—Å–∏–≤ author –≤ –æ–±—ä–µ–∫—Ç (–∏–∑ [{}] –≤ {})
        ...,
        
        # –®–∞–≥ 5: –í—ã–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –æ—Ç–≤–µ—Ç–∞
        ...
    ]
    return list(db.books.aggregate(pipeline))

# –ó–∞–¥–∞–Ω–∏–µ 2: –°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥ –∫–∞–∂–¥–æ–π –∫–Ω–∏–≥–∏
@app.get("/books/ratings")
def get_books_ratings():
    """–ü–æ–ª—É—á–∏—Ç—å —Å—Ä–µ–¥–Ω—é—é –æ—Ü–µ–Ω–∫—É –¥–ª—è –∫–∞–∂–¥–æ–π –∫–Ω–∏–≥–∏"""
    pipeline = [
        # –®–∞–≥ 1: –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –æ—Ç–∑—ã–≤—ã –ø–æ bookId –∏ —Å—á–∏—Ç–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        # –®–∞–≥ 2: –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–Ω–∏–≥–µ –ø–æ –µ—ë ID
        # –®–∞–≥ 3: –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –º–∞—Å—Å–∏–≤ book –≤ –æ–±—ä–µ–∫—Ç
        # –®–∞–≥ 4: –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—Ç–≤–µ—Ç–∞
        # –®–∞–≥ 5: –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Å—Ä–µ–¥–Ω–µ–º—É —Ä–µ–π—Ç–∏–Ω–≥—É (–ª—É—á—à–∏–µ –∫–Ω–∏–≥–∏ —Å–≤–µ—Ä—Ö—É)       
    ]
    return list(db.reviews.aggregate(pipeline))

# –ó–∞–¥–∞–Ω–∏–µ 3: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∞–≤—Ç–æ—Ä–∞–º
@app.get("/authors/stats")
def get_authors_stats():
    """–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–Ω–∏–≥ –∏ –æ–±—â–µ–µ —á–∏—Å–ª–æ —Å—Ç—Ä–∞–Ω–∏—Ü –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–≤—Ç–æ—Ä–∞"""
   ...
    return list(db.books.aggregate(pipeline))

# –ó–∞–¥–∞–Ω–∏–µ 4: –ö–Ω–∏–≥–∏ –ø–æ –∂–∞–Ω—Ä–∞–º
@app.get("/books/by-genre")
def get_books_by_genre():
    """–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∫–Ω–∏–≥ –ø–æ –∂–∞–Ω—Ä–∞–º —Å –ø–æ–¥—Å—á–µ—Ç–æ–º"""
   ...
    return list(db.books.aggregate(pipeline))

# –ó–∞–¥–∞–Ω–∏–µ 5: –ü–æ–∏—Å–∫ –∫–Ω–∏–≥ –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω—É –ª–µ—Ç
@app.get("/books/by-years/{start_year}/{end_year}")
def get_books_by_years(start_year: int, end_year: int):
    """–ù–∞–π—Ç–∏ –∫–Ω–∏–≥–∏, –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ –≤ –∑–∞–¥–∞–Ω–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ –ª–µ—Ç"""
   ...
    return list(db.books.aggregate(pipeline))

# –ó–∞–¥–∞–Ω–∏–µ 6: –°–∞–º—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ—Ü–µ–Ω–∑–µ–Ω—Ç
@app.get("/reviewers/top")
def get_top_reviewers():
    """–ù–∞–π—Ç–∏ —Å–∞–º—ã—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–µ—Ü–µ–Ω–∑–µ–Ω—Ç–æ–≤"""
   ...
    return list(db.reviews.aggregate(pipeline))

# –ó–∞–¥–∞–Ω–∏–µ 7:: –ö–Ω–∏–≥–∏ –±–µ–∑ –æ—Ç–∑—ã–≤–æ–≤
@app.get("/books/no-reviews")
def get_books_without_reviews():
    """–ù–∞–π—Ç–∏ –∫–Ω–∏–≥–∏, —É –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤"""
   ...
    return list(db.books.aggregate(pipeline))

```