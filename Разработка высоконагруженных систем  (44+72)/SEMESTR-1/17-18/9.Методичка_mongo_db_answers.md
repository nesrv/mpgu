# Ð›Ð°Ð±Ð¾Ñ€Ð°Ñ‚Ð¾Ñ€Ð½Ð°Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ð° Ð˜Ð·ÑƒÑ‡ÐµÐ½Ð¸Ðµ mongodb

## ðŸš€ Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ ÑÑ‚Ð°Ñ€Ñ‚

### 1. ÐŸÐµÑ€ÐµÐ¹Ñ‚Ð¸ Ð² Ð¿Ð°Ð¿ÐºÑƒ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
```bash
cd LAB-REDIS-MONGO
```


### 2. ÐŸÐ¾Ð´Ð½ÑÑ‚ÑŒ MongoDB Ð² ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ðµ
docker-compose.yml

```sh
services:
  mongodb:
    image: mongo:7
    env_file:
      - .env
    ports:
      - "27017:27017"
```


.env

```sh
MONGO_INITDB_ROOT_USERNAME=student
MONGO_INITDB_ROOT_PASSWORD=password

MONGODB_URL=mongodb://student:password@mongodb:27017/

```

```sh
docker-compose up --build -d
```

### 3. ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Ð³Ñ€Ð°Ñ„Ð¸Ñ‡ÐµÑÐºÐ¾Ð¼Ñƒ Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÑƒ MongoDB Compass 

### Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°
1. Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ñ https://github.com/mongodb-js/compass/releases/download/v1.48.2/mongodb-compass-1.48.2-win32-x64.msi

2. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ MongoDB Compass

### ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ
**Connection String:**
```
mongodb://student:password@localhost:27017/
```


### 4. Ð¨Ð¿Ð°Ñ€Ð³Ð°Ð»ÐºÐ° Ð¿Ð¾ Ñ€Ð°Ð±Ð¾Ñ‚Ðµ Ð² MongoDB Compass

#### ðŸ“Œ ÐÐ°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ñ Ð² Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÐµ
1. **Ð’Ñ‹Ð±Ð¾Ñ€ Ð‘Ð”:** Ð›ÐµÐ²Ð°Ñ Ð¿Ð°Ð½ÐµÐ»ÑŒ â†’ Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ `library` (Ð¸Ð»Ð¸ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ñ‡ÐµÑ€ÐµÐ· ÐºÐ½Ð¾Ð¿ÐºÑƒ `+`)
2. **Ð’Ñ‹Ð±Ð¾Ñ€ ÐºÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¸:** ÐšÐ»Ð¸ÐºÐ½ÑƒÑ‚ÑŒ Ð½Ð° `authors` Ð¸Ð»Ð¸ `books`
3. **Ð’ÐºÐ»Ð°Ð´ÐºÐ¸:**
   - **Documents** â€” Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€/Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð²
   - **Aggregations** â€” Ð¿Ð¾ÑÑ‚Ñ€Ð¾ÐµÐ½Ð¸Ðµ pipeline Ð°Ð³Ñ€ÐµÐ³Ð°Ñ†Ð¸Ð¸
   - **Schema** â€” Ð°Ð½Ð°Ð»Ð¸Ð· ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
   - **Indexes** â€” ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¸Ð½Ð´ÐµÐºÑÐ°Ð¼Ð¸


```js
// MongoDB Ð‘Ñ‹ÑÑ‚Ñ€Ð°Ñ ÑˆÐ¿Ð°Ñ€Ð³Ð°Ð»ÐºÐ°

// === Ð—ÐÐŸÐ£Ð¡Ðš MONGOSH ===
// Ð˜Ð· ÐºÐ¾Ð¼Ð°Ð½Ð´Ð½Ð¾Ð¹ ÑÑ‚Ñ€Ð¾ÐºÐ¸:
// mongosh --username student --password password
// Ð˜Ð»Ð¸ Ð¸Ð· Docker:
// docker-compose exec mongodb mongosh --username student --password password

// === ÐžÐ¡ÐÐžÐ’ÐÐ«Ð• ÐšÐžÐœÐÐÐ”Ð« ===
show dbs;              // ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð²ÑÐµ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
show collections;      // ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÐºÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¸ Ð² Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ Ð‘Ð”
db;                    // ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ñ‚ÐµÐºÑƒÑ‰ÑƒÑŽ Ð‘Ð”
help;                  // Ð¡Ð¿Ñ€Ð°Ð²ÐºÐ°
exit;                  // Ð’Ñ‹Ñ…Ð¾Ð´

// === ÐŸÐžÐ”ÐšÐ›Ð®Ð§Ð•ÐÐ˜Ð• ===
use library;           // Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ/ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð‘Ð”

// === CREATE (Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ) ===
db.authors.insertOne({name: "Ð¢Ð¾Ð»ÑÑ‚Ð¾Ð¹", birthYear: 1828});
db.authors.insertMany([
  {name: "Ð¢Ð¾Ð»ÑÑ‚Ð¾Ð¹", birthYear: 1828},
  {name: "Ð”Ð¾ÑÑ‚Ð¾ÐµÐ²ÑÐºÐ¸Ð¹", birthYear: 1821}
]);

// === READ (Ð§Ñ‚ÐµÐ½Ð¸Ðµ) ===
db.authors.find();                              // Ð’ÑÐµ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹
db.authors.findOne({name: "Ð¢Ð¾Ð»ÑÑ‚Ð¾Ð¹"});          // ÐžÐ´Ð¸Ð½ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚
db.books.find({pages: {$gt: 500}});             // Ð‘Ð¾Ð»ÑŒÑˆÐµ 500 ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†
db.books.find({genre: "Ñ€Ð¾Ð¼Ð°Ð½"}).limit(5);       // ÐŸÐµÑ€Ð²Ñ‹Ðµ 5

// === UPDATE (ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ) ===
db.authors.updateOne(
  {name: "Ð¢Ð¾Ð»ÑÑ‚Ð¾Ð¹"},                  // Ð¤Ð¸Ð»ÑŒÑ‚Ñ€
  {$set: {country: "Ð Ð¾ÑÑÐ¸Ñ"}}         // ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ
);
db.books.updateMany(
  {genre: "Ñ€Ð¾Ð¼Ð°Ð½"},
  {$set: {category: "ÐºÐ»Ð°ÑÑÐ¸ÐºÐ°"}}
);

// === DELETE (Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ) ===
db.authors.deleteOne({name: "Ð¢Ð¾Ð»ÑÑ‚Ð¾Ð¹"});
db.books.deleteMany({pages: {$lt: 100}});

// === ÐžÐŸÐ•Ð ÐÐ¢ÐžÐ Ð« Ð—ÐÐŸÐ ÐžÐ¡ÐžÐ’ ===
{price: {$gt: 1000}}    // Ð‘Ð¾Ð»ÑŒÑˆÐµ
{price: {$gte: 1000}}   // Ð‘Ð¾Ð»ÑŒÑˆÐµ Ð¸Ð»Ð¸ Ñ€Ð°Ð²Ð½Ð¾
{price: {$lt: 1000}}    // ÐœÐµÐ½ÑŒÑˆÐµ
{price: {$lte: 1000}}   // ÐœÐµÐ½ÑŒÑˆÐµ Ð¸Ð»Ð¸ Ñ€Ð°Ð²Ð½Ð¾
{price: {$ne: 1000}}    // ÐÐµ Ñ€Ð°Ð²Ð½Ð¾

// Ð›Ð¾Ð³Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ
{$and: [{pages: {$gt: 500}}, {genre: "Ñ€Ð¾Ð¼Ð°Ð½"}]}
{$or: [{genre: "Ñ€Ð¾Ð¼Ð°Ð½"}, {genre: "Ð¿Ð¾Ð²ÐµÑÑ‚ÑŒ"}]}

// ÐœÐ°ÑÑÐ¸Ð²Ñ‹
{tags: {$in: ["ÐºÐ»Ð°ÑÑÐ¸ÐºÐ°", "Ñ€Ð¾Ð¼Ð°Ð½"]}}      // Ð•ÑÑ‚ÑŒ Ð² Ð¼Ð°ÑÑÐ¸Ð²Ðµ
{tags: {$nin: ["Ñ„Ð°Ð½Ñ‚Ð°ÑÑ‚Ð¸ÐºÐ°"]}}            // ÐÐµÑ‚ Ð² Ð¼Ð°ÑÑÐ¸Ð²Ðµ

// === ÐÐ“Ð Ð•Ð“ÐÐ¦Ð˜Ð¯ ===

// Ð“Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ°
db.books.aggregate([
  {
    $group: {
      _id: "$genre",              // Ð“Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ð¾ Ð¶Ð°Ð½Ñ€Ñƒ
      count: {$sum: 1},           // ÐŸÐ¾Ð´ÑÑ‡ÐµÑ‚
      avgPages: {$avg: "$pages"}  // Ð¡Ñ€ÐµÐ´Ð½ÐµÐµ
    }
  }
]);

// Ð¡Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²ÐºÐ° Ð¸ Ð»Ð¸Ð¼Ð¸Ñ‚
db.books.aggregate([
  {$sort: {pages: -1}},  // -1 = ÑƒÐ±Ñ‹Ð²Ð°Ð½Ð¸Ðµ, 1 = Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚Ð°Ð½Ð¸Ðµ
  {$limit: 5}
]);

// ÐŸÑ€Ð¾ÐµÐºÑ†Ð¸Ñ (Ð²Ñ‹Ð±Ð¾Ñ€ Ð¿Ð¾Ð»ÐµÐ¹)
db.books.aggregate([
  {
    $project: {
      title: 1,                    // Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ
      authorName: "$author.name",  // ÐŸÐµÑ€ÐµÐ¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ñ‚ÑŒ
      _id: 0                       // Ð˜ÑÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ
    }
  }
]);

// Lookup (JOIN)
db.books.aggregate([
  {
    $lookup: {
      from: "authors",        // Ð˜Ð· ÐºÐ°ÐºÐ¾Ð¹ ÐºÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¸
      localField: "authorId", // ÐŸÐ¾Ð»Ðµ Ð² books
      foreignField: "_id",    // ÐŸÐ¾Ð»Ðµ Ð² authors
      as: "author"            // Ð˜Ð¼Ñ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð¿Ð¾Ð»Ñ
    }
  },
  {$unwind: "$author"}  // Ð Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ Ð¼Ð°ÑÑÐ¸Ð² Ð² Ð¾Ð±ÑŠÐµÐºÑ‚
]);

// === ÐŸÐžÐ›Ð•Ð—ÐÐ«Ð• ÐšÐžÐœÐÐÐ”Ð« ===
db.books.countDocuments({genre: "Ñ€Ð¾Ð¼Ð°Ð½"});  // ÐŸÐ¾Ð´ÑÑ‡ÐµÑ‚
db.books.distinct("genre");                 // Ð£Ð½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ
show collections;                           // Ð¡Ð¿Ð¸ÑÐ¾Ðº ÐºÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¹
db.books.drop();                            // Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ ÐºÐ¾Ð»Ð»ÐµÐºÑ†Ð¸ÑŽ

// ========================================
// === MONGODB COMPASS (GUI) ===
// ========================================

// === CREATE (Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ) ===
// 1. Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ ÐºÐ¾Ð»Ð»ÐµÐºÑ†Ð¸ÑŽ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, authors)
// 2. ÐÐ°Ð¶Ð°Ñ‚ÑŒ ÐºÐ½Ð¾Ð¿ÐºÑƒ "INSERT DOCUMENT"
// 3. Ð’Ð²ÐµÑÑ‚Ð¸ JSON:
//    {"name": "Ð¢Ð¾Ð»ÑÑ‚Ð¾Ð¹", "birthYear": 1828, "country": "Ð Ð¾ÑÑÐ¸Ñ"}
// 4. ÐÐ°Ð¶Ð°Ñ‚ÑŒ "INSERT"

// === READ (Ð§Ñ‚ÐµÐ½Ð¸Ðµ) ===
// 1. ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ ÐºÐ¾Ð»Ð»ÐµÐºÑ†Ð¸ÑŽ
// 2. Ð’ Ð¿Ð¾Ð»Ðµ Filter Ð²Ð²ÐµÑÑ‚Ð¸ Ð·Ð°Ð¿Ñ€Ð¾Ñ:
//    {"genre": "Ñ€Ð¾Ð¼Ð°Ð½"}                    // ÐÐ°Ð¹Ñ‚Ð¸ Ð¿Ð¾ Ð¶Ð°Ð½Ñ€Ñƒ
//    {"pages": {"$gt": 500}}               // Ð‘Ð¾Ð»ÑŒÑˆÐµ 500 ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†
//    {"publishedYear": {"$gte": 1900}}    // Ð¡ 1900 Ð³Ð¾Ð´Ð°
// 3. ÐÐ°Ð¶Ð°Ñ‚ÑŒ "FIND"

// === UPDATE (ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ) ===
// 1. ÐÐ°Ð¹Ñ‚Ð¸ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚ Ñ‡ÐµÑ€ÐµÐ· Filter
// 2. ÐÐ°Ð²ÐµÑÑ‚Ð¸ Ð½Ð° Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚ â†’ Ð½Ð°Ð¶Ð°Ñ‚ÑŒ Ð¸ÐºÐ¾Ð½ÐºÑƒ ÐºÐ°Ñ€Ð°Ð½Ð´Ð°ÑˆÐ° (Edit)
// 3. Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð»Ñ Ð² JSON
// 4. ÐÐ°Ð¶Ð°Ñ‚ÑŒ "UPDATE"

// === DELETE (Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ) ===
// 1. ÐÐ°Ð¹Ñ‚Ð¸ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚
// 2. ÐÐ°Ð²ÐµÑÑ‚Ð¸ Ð½Ð° Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚ â†’ Ð½Ð°Ð¶Ð°Ñ‚ÑŒ Ð¸ÐºÐ¾Ð½ÐºÑƒ ÐºÐ¾Ñ€Ð·Ð¸Ð½Ñ‹ (Delete)
// 3. ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¸Ñ‚ÑŒ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ

// === AGGREGATIONS (ÐÐ³Ñ€ÐµÐ³Ð°Ñ†Ð¸Ñ) ===
// 1. ÐŸÐµÑ€ÐµÐ¹Ñ‚Ð¸ Ð½Ð° Ð²ÐºÐ»Ð°Ð´ÐºÑƒ "Aggregations"
// 2. Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ð´Ð¸Ð¸ pipeline:
//    Stage 1: {"$match": {"genre": "Ñ€Ð¾Ð¼Ð°Ð½"}}
//    Stage 2: {"$sort": {"pages": -1}}
//    Stage 3: {"$limit": 5}
// 3. ÐÐ°Ð¶Ð°Ñ‚ÑŒ "RUN" Ð´Ð»Ñ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð° Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð°

// === INDEXES (Ð˜Ð½Ð´ÐµÐºÑÑ‹) ===
// 1. ÐŸÐµÑ€ÐµÐ¹Ñ‚Ð¸ Ð½Ð° Ð²ÐºÐ»Ð°Ð´ÐºÑƒ "Indexes"
// 2. ÐÐ°Ð¶Ð°Ñ‚ÑŒ "CREATE INDEX"
// 3. Ð£ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¿Ð¾Ð»Ñ: {"name": 1}  // 1 = Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚Ð°Ð½Ð¸Ðµ, -1 = ÑƒÐ±Ñ‹Ð²Ð°Ð½Ð¸Ðµ
// 4. Ð”Ð°Ñ‚ÑŒ Ð¸Ð¼Ñ Ð¸Ð½Ð´ÐµÐºÑÑƒ
// 5. ÐÐ°Ð¶Ð°Ñ‚ÑŒ "CREATE"

// === SCHEMA (Ð¡Ñ…ÐµÐ¼Ð°) ===
// 1. ÐŸÐµÑ€ÐµÐ¹Ñ‚Ð¸ Ð½Ð° Ð²ÐºÐ»Ð°Ð´ÐºÑƒ "Schema"
// 2. ÐÐ°Ð¶Ð°Ñ‚ÑŒ "ANALYZE SCHEMA"
// 3. ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ñ‚Ð¸Ð¿Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¸ Ñ€Ð°ÑÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ð¹

// === EXPORT/IMPORT ===
// Export:
// 1. Collection â†’ Export Collection
// 2. Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ (JSON/CSV)
// 3. Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ñ„Ð°Ð¹Ð»
//
// Import:
// 1. Collection â†’ Import Data
// 2. Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ñ„Ð°Ð¹Ð»
// 3. ÐÐ°Ð¶Ð°Ñ‚ÑŒ "IMPORT"
```

## 5. ÐŸÐ¾Ð´Ð½ÑÑ‚ÑŒ Ñ„Ð°ÑÑ‚Ð°Ð¿Ð¸-ÑÐµÑ€Ð²ÐµÑ€

```py
from fastapi import FastAPI
from pymongo import MongoClient
import uvicorn

app = FastAPI()

# ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº MongoDB
client = MongoClient("mongodb://student:password@localhost:27017/")
db = client.testdb

@app.get("/")
def root():
    return {"message": "MongoDB FastAPI Server"}

@app.get("/ping")
def ping_mongodb():
    try:
        client.admin.command('ping')
        return {"status": "success", "message": "MongoDB connected"}
    except Exception as e:
        return {"status": "error", "message": str(e)}

@app.get("/collections")
def list_collections():
    collections = db.list_collection_names()
    return {"collections": collections}

if __name__ == "__main__":
    uvicorn.run(app, host="127.0.0.1", port=8000)
```


### 6. ÐÐ°ÐºÐ°Ñ‚Ð¸Ñ‚ÑŒ Ñ„Ð¸ÐºÑÑ‚ÑƒÑ€Ñƒ

[Ñ„Ð¸ÐºÑÑ‚ÑƒÑ€Ð°](library.js)

### 7. ÐžÑ‚Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ CRUDs

```py
from pymongo import MongoClient
from bson import ObjectId
from pydantic import BaseModel


# ÐœÐ¾Ð´ÐµÐ»Ð¸
class Author(BaseModel):
    name: str
    birthYear: int
    country: str

class Book(BaseModel):
    title: str
    authorId: str
    pages: int
    publishedYear: int
    genre: str

class Review(BaseModel):
    bookId: str
    rating: int
    comment: str
    reviewerName: str

# CRUD Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ñ€Ð¾Ð²
@app.get("/authors")
def get_authors():
    # ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð²ÑÐµÑ… Ð°Ð²Ñ‚Ð¾Ñ€Ð¾Ð² Ð¸Ð· ÐºÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¸
    authors = list(db.authors.find())
    # ÐŸÑ€ÐµÐ¾Ð±Ñ€Ð°Ð·Ð¾Ð²Ð°Ñ‚ÑŒ ObjectId Ð² ÑÑ‚Ñ€Ð¾ÐºÑƒ Ð´Ð»Ñ JSON
    for author in authors:
        author["_id"] = str(author["_id"])
    return authors

@app.post("/authors")
def create_author(author: Author):
    # Ð’ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð°Ð²Ñ‚Ð¾Ñ€Ð° Ð² ÐºÐ¾Ð»Ð»ÐµÐºÑ†Ð¸ÑŽ
    result = db.authors.insert_one(author.dict())
    return {"id": str(result.inserted_id)}

@app.get("/authors/{author_id}")
def get_author(author_id: str):
    # ÐÐ°Ð¹Ñ‚Ð¸ Ð°Ð²Ñ‚Ð¾Ñ€Ð° Ð¿Ð¾ ID
    try:
        author = db.authors.find_one({"_id": ObjectId(author_id)})
    except:
        raise HTTPException(status_code=400, detail="Invalid ObjectId format")
    if not author:
        raise HTTPException(status_code=404, detail="Author not found")
    author["_id"] = str(author["_id"])
    return author

# CRUD Ð´Ð»Ñ ÐºÐ½Ð¸Ð³
@app.get("/books")
def get_books():
    books = list(db.books.find())
    for book in books:
        book["_id"] = str(book["_id"])
        book["authorId"] = str(book["authorId"])
    return books

@app.post("/books")
def create_book(book: Book):
    book_dict = book.dict()
    book_dict["authorId"] = ObjectId(book_dict["authorId"])
    result = db.books.insert_one(book_dict)
    return {"id": str(result.inserted_id)}

@app.get("/books/{book_id}")
def get_book(book_id: str):
    try:
        book = db.books.find_one({"_id": ObjectId(book_id)})
    except:
        raise HTTPException(status_code=400, detail="Invalid ObjectId format")
    if not book:
        raise HTTPException(status_code=404, detail="Book not found")
    book["_id"] = str(book["_id"])
    book["authorId"] = str(book["authorId"])
    return book

# CRUD Ð´Ð»Ñ Ð¾Ñ‚Ð·Ñ‹Ð²Ð¾Ð²
@app.get("/reviews")
def get_reviews():
    reviews = list(db.reviews.find())
    for review in reviews:
        review["_id"] = str(review["_id"])
        review["bookId"] = str(review["bookId"])
    return reviews

@app.post("/reviews")
def create_review(review: Review):
    review_dict = review.dict()
    review_dict["bookId"] = ObjectId(review_dict["bookId"])
    result = db.reviews.insert_one(review_dict)
    return {"id": str(result.inserted_id)}

@app.get("/reviews/book/{book_id}")
def get_book_reviews(book_id: str):
    try:
        reviews = list(db.reviews.find({"bookId": ObjectId(book_id)}))
    except:
        raise HTTPException(status_code=400, detail="Invalid ObjectId format")
    for review in reviews:
        review["_id"] = str(review["_id"])
        review["bookId"] = str(review["bookId"])
    return reviews

# ÐÐ³Ñ€ÐµÐ³Ð°Ñ†Ð¸Ñ: ÐºÐ½Ð¸Ð³Ð¸ Ñ Ð°Ð²Ñ‚Ð¾Ñ€Ð°Ð¼Ð¸
@app.get("/books-with-authors")
def get_books_with_authors():
    # Pipeline Ð´Ð»Ñ Ð°Ð³Ñ€ÐµÐ³Ð°Ñ†Ð¸Ð¸
    pipeline = [
        {
            # $lookup - ÑÐ¾ÐµÐ´Ð¸Ð½ÑÐµÑ‚ ÐºÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¸ books Ð¸ authors
            "$lookup": {
                "from": "authors",           # Ð˜Ð· ÐºÐ°ÐºÐ¾Ð¹ ÐºÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¸
                "localField": "authorId",    # ÐŸÐ¾Ð»Ðµ Ð² books
                "foreignField": "_id",       # ÐŸÐ¾Ð»Ðµ Ð² authors
                "as": "author"               # Ð˜Ð¼Ñ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð¿Ð¾Ð»Ñ
            }
        },
        # $unwind - Ñ€Ð°Ð·Ð²Ð¾Ñ€Ð°Ñ‡Ð¸Ð²Ð°ÐµÑ‚ Ð¼Ð°ÑÑÐ¸Ð² author Ð² Ð¾Ð±ÑŠÐµÐºÑ‚
        {"$unwind": "$author"}
    ]
    # Ð’Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ Ð°Ð³Ñ€ÐµÐ³Ð°Ñ†Ð¸ÑŽ
    books = list(db.books.aggregate(pipeline))
    # ÐŸÑ€ÐµÐ¾Ð±Ñ€Ð°Ð·Ð¾Ð²Ð°Ñ‚ÑŒ ObjectId Ð² ÑÑ‚Ñ€Ð¾ÐºÑƒ
    for book in books:
        book["_id"] = str(book["_id"])
        book["authorId"] = str(book["authorId"])
        book["author"]["_id"] = str(book["author"]["_id"])
    return books

```

### 7. ÐžÑ‚Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð°Ð³Ñ€ÐµÐ³Ð°Ñ†Ð¸Ð¹ Ð² MongoDB Compass Shell

> **Ð¦ÐµÐ»ÑŒ:** ÐÐ°ÑƒÑ‡Ð¸Ñ‚ÑŒÑÑ Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ð¸ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð°Ð³Ñ€ÐµÐ³Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ð² MongoDB Shell Ð¿ÐµÑ€ÐµÐ´ Ð¿ÐµÑ€ÐµÐ½Ð¾ÑÐ¾Ð¼ Ð² FastAPI

#### ÐšÐ°Ðº Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚ÑŒ MongoDB Shell Ð² Compass:
1. ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ MongoDB Compass
2. ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒÑÑ Ðº Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…
3. Ð’Ð½Ð¸Ð·Ñƒ Ð¾ÐºÐ½Ð° Ð½Ð°Ð¶Ð°Ñ‚ÑŒ ÐºÐ½Ð¾Ð¿ÐºÑƒ `>_MONGOSH` (MongoDB Shell)
4. Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ…: `use library`

---

#### Ð—Ð°Ð´Ð°Ð½Ð¸Ðµ 1: Ð¢Ð¾Ð¿-5 ÑÐ°Ð¼Ñ‹Ñ… Ð´Ð»Ð¸Ð½Ð½Ñ‹Ñ… ÐºÐ½Ð¸Ð³

```js
// Ð¨Ð°Ð³ 1: ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ…
db.books.findOne()  // Ð¡Ð¼Ð¾Ñ‚Ñ€Ð¸Ð¼, ÐºÐ°ÐºÐ¸Ðµ Ð¿Ð¾Ð»Ñ ÐµÑÑ‚ÑŒ Ð² ÐºÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¸

// Ð¨Ð°Ð³ 2: ÐŸÑ€Ð¾ÑÑ‚Ð°Ñ ÑÐ¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²ÐºÐ° Ð¸ Ð»Ð¸Ð¼Ð¸Ñ‚
db.books.find().sort({pages: -1}).limit(5)
// Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚: 5 ÐºÐ½Ð¸Ð³, Ð½Ð¾ Ð±ÐµÐ· Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾Ð± Ð°Ð²Ñ‚Ð¾Ñ€Ð°Ñ…

// Ð¨Ð°Ð³ 3: Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð°Ð³Ñ€ÐµÐ³Ð°Ñ†Ð¸ÑŽ Ñ $lookup
db.books.aggregate([
  {$sort: {pages: -1}},
  {$limit: 5},
  {
    $lookup: {
      from: "authors",
      localField: "authorId",
      foreignField: "_id",
      as: "author"
    }
  }
])
// Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚: author Ñ‚ÐµÐ¿ÐµÑ€ÑŒ Ð¼Ð°ÑÑÐ¸Ð² [{}], Ð½ÑƒÐ¶Ð½Ð¾ Ñ€Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ

// Ð¨Ð°Ð³ 4: Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ $unwind
db.books.aggregate([
  {$sort: {pages: -1}},
  {$limit: 5},
  {
    $lookup: {
      from: "authors",
      localField: "authorId",
      foreignField: "_id",
      as: "author"
    }
  },
  {$unwind: "$author"}
])
// Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚: author Ñ‚ÐµÐ¿ÐµÑ€ÑŒ Ð¾Ð±ÑŠÐµÐºÑ‚ {}, Ð½Ð¾ Ð¼Ð½Ð¾Ð³Ð¾ Ð»Ð¸ÑˆÐ½Ð¸Ñ… Ð¿Ð¾Ð»ÐµÐ¹

// Ð¨Ð°Ð³ 5: Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ $project Ð´Ð»Ñ Ð²Ñ‹Ð±Ð¾Ñ€Ð° Ð¿Ð¾Ð»ÐµÐ¹
db.books.aggregate([
  {$sort: {pages: -1}},
  {$limit: 5},
  {
    $lookup: {
      from: "authors",
      localField: "authorId",
      foreignField: "_id",
      as: "author"
    }
  },
  {$unwind: "$author"},
  {
    $project: {
      title: 1,
      pages: 1,
      authorName: "$author.name",
      publishedYear: 1
    }
  }
])
// âœ… Ð“Ð¾Ñ‚Ð¾Ð²Ð¾! Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿ÐµÑ€ÐµÐ½Ð¾ÑÐ¸Ñ‚ÑŒ Ð² FastAPI
```

---

#### Ð—Ð°Ð´Ð°Ð½Ð¸Ðµ 2: Ð¡Ñ€ÐµÐ´Ð½Ð¸Ð¹ Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³ ÐºÐ°Ð¶Ð´Ð¾Ð¹ ÐºÐ½Ð¸Ð³Ð¸

```js
// Ð¨Ð°Ð³ 1: ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ð¾Ñ‚Ð·Ñ‹Ð²Ð¾Ð²
db.reviews.findOne()

// Ð¨Ð°Ð³ 2: Ð“Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð¾Ñ‚Ð·Ñ‹Ð²Ñ‹ Ð¿Ð¾ bookId
db.reviews.aggregate([
  {
    $group: {
      _id: "$bookId",
      avgRating: {$avg: "$rating"},
      reviewCount: {$sum: 1}
    }
  }
])
// Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚: ÐµÑÑ‚ÑŒ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°, Ð½Ð¾ Ð½ÐµÑ‚ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ð¹ ÐºÐ½Ð¸Ð³

// Ð¨Ð°Ð³ 3: Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ $lookup Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ð¹
db.reviews.aggregate([
  {
    $group: {
      _id: "$bookId",
      avgRating: {$avg: "$rating"},
      reviewCount: {$sum: 1}
    }
  },
  {
    $lookup: {
      from: "books",
      localField: "_id",
      foreignField: "_id",
      as: "book"
    }
  },
  {$unwind: "$book"}
])

// Ð¨Ð°Ð³ 4: Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð²Ñ‹Ð²Ð¾Ð´ Ð¸ ÑÐ¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼
db.reviews.aggregate([
  {
    $group: {
      _id: "$bookId",
      avgRating: {$avg: "$rating"},
      reviewCount: {$sum: 1}
    }
  },
  {
    $lookup: {
      from: "books",
      localField: "_id",
      foreignField: "_id",
      as: "book"
    }
  },
  {$unwind: "$book"},
  {
    $project: {
      title: "$book.title",
      avgRating: {$round: ["$avgRating", 2]},
      reviewCount: 1
    }
  },
  {$sort: {avgRating: -1}}
])
// âœ… Ð“Ð¾Ñ‚Ð¾Ð²Ð¾!
```

---

#### Ð—Ð°Ð´Ð°Ð½Ð¸Ðµ 3: Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¿Ð¾ Ð°Ð²Ñ‚Ð¾Ñ€Ð°Ð¼

```js
// Ð¨Ð°Ð³ 1: Ð“Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ½Ð¸Ð³Ð¸ Ð¿Ð¾ authorId
db.books.aggregate([
  {
    $group: {
      _id: "$authorId",
      bookCount: {$sum: 1},
      totalPages: {$sum: "$pages"},
      avgPages: {$avg: "$pages"}
    }
  }
])
// Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚: ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° ÐµÑÑ‚ÑŒ, Ð½Ð¾ Ð½ÐµÑ‚ Ð¸Ð¼ÐµÐ½ Ð°Ð²Ñ‚Ð¾Ñ€Ð¾Ð²

// Ð¨Ð°Ð³ 2: Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¸Ð¼ÐµÐ½Ð° Ð°Ð²Ñ‚Ð¾Ñ€Ð¾Ð² Ð¸ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÐ¼
db.books.aggregate([
  {
    $group: {
      _id: "$authorId",
      bookCount: {$sum: 1},
      totalPages: {$sum: "$pages"},
      avgPages: {$avg: "$pages"}
    }
  },
  {
    $lookup: {
      from: "authors",
      localField: "_id",
      foreignField: "_id",
      as: "author"
    }
  },
  {$unwind: "$author"},
  {
    $project: {
      authorName: "$author.name",
      bookCount: 1,
      totalPages: 1,
      avgPages: {$round: ["$avgPages", 0]}
    }
  },
  {$sort: {bookCount: -1}}
])
// âœ… Ð“Ð¾Ñ‚Ð¾Ð²Ð¾!
```

---

#### Ð—Ð°Ð´Ð°Ð½Ð¸Ðµ 4: ÐšÐ½Ð¸Ð³Ð¸ Ð¿Ð¾ Ð¶Ð°Ð½Ñ€Ð°Ð¼

```js
// Ð¨Ð°Ð³ 1: ÐŸÑ€Ð¾ÑÑ‚Ð°Ñ Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ°
db.books.aggregate([
  {
    $group: {
      _id: "$genre",
      count: {$sum: 1}
    }
  }
])
// Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚: ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÐºÐ½Ð¸Ð³ Ð¿Ð¾ Ð¶Ð°Ð½Ñ€Ð°Ð¼

// Ð¨Ð°Ð³ 2: Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº ÐºÐ½Ð¸Ð³ Ð¸ ÑÑ€ÐµÐ´Ð½ÐµÐµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†
db.books.aggregate([
  {
    $group: {
      _id: "$genre",
      count: {$sum: 1},
      books: {$push: "$title"},      // Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ Ð² Ð¼Ð°ÑÑÐ¸Ð²
      avgPages: {$avg: "$pages"}
    }
  },
  {$sort: {count: -1}}
])
// âœ… Ð“Ð¾Ñ‚Ð¾Ð²Ð¾! Ð’Ð¸Ð´Ð¸Ð¼ Ð¿Ð¾Ð¿ÑƒÐ»ÑÑ€Ð½Ñ‹Ðµ Ð¶Ð°Ð½Ñ€Ñ‹ Ð¸ ÑÐ¿Ð¸ÑÐ¾Ðº ÐºÐ½Ð¸Ð³ Ð² ÐºÐ°Ð¶Ð´Ð¾Ð¼
```

---

#### Ð—Ð°Ð´Ð°Ð½Ð¸Ðµ 5: ÐŸÐ¾Ð¸ÑÐº ÐºÐ½Ð¸Ð³ Ð¿Ð¾ Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½Ñƒ Ð»ÐµÑ‚

```js
// Ð¨Ð°Ð³ 1: ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€
db.books.find({
  publishedYear: {$gte: 1850, $lte: 1900}
})
// Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚: ÐºÐ½Ð¸Ð³Ð¸ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹, Ð½Ð¾ Ð±ÐµÐ· Ð°Ð²Ñ‚Ð¾Ñ€Ð¾Ð²

// Ð¨Ð°Ð³ 2: ÐŸÐµÑ€ÐµÐ²Ð¾Ð´Ð¸Ð¼ Ð² Ð°Ð³Ñ€ÐµÐ³Ð°Ñ†Ð¸ÑŽ Ñ $match
db.books.aggregate([
  {
    $match: {
      publishedYear: {$gte: 1850, $lte: 1900}
    }
  }
])

// Ð¨Ð°Ð³ 3: Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ñ€Ð¾Ð² Ð¸ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÐ¼
db.books.aggregate([
  {
    $match: {
      publishedYear: {$gte: 1850, $lte: 1900}
    }
  },
  {
    $lookup: {
      from: "authors",
      localField: "authorId",
      foreignField: "_id",
      as: "author"
    }
  },
  {$unwind: "$author"},
  {
    $project: {
      title: 1,
      authorName: "$author.name",
      publishedYear: 1,
      genre: 1
    }
  },
  {$sort: {publishedYear: 1}}
])
// âœ… Ð“Ð¾Ñ‚Ð¾Ð²Ð¾! ÐœÐµÐ½ÑÐµÐ¼ Ð³Ð¾Ð´Ñ‹ Ð² $match Ð´Ð»Ñ Ñ€Ð°Ð·Ð½Ñ‹Ñ… Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½Ð¾Ð²
```

---

#### Ð‘Ð¾Ð½ÑƒÑ: ÐšÐ½Ð¸Ð³Ð¸ Ð±ÐµÐ· Ð¾Ñ‚Ð·Ñ‹Ð²Ð¾Ð²

```js
// Ð¨Ð°Ð³ 1: ÐŸÑ€Ð¸ÑÐ¾ÐµÐ´Ð¸Ð½ÑÐµÐ¼ Ð¾Ñ‚Ð·Ñ‹Ð²Ñ‹ Ðº ÐºÐ½Ð¸Ð³Ð°Ð¼
db.books.aggregate([
  {
    $lookup: {
      from: "reviews",
      localField: "_id",
      foreignField: "bookId",
      as: "reviews"
    }
  }
])
// Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚: Ñƒ ÐºÐ°Ð¶Ð´Ð¾Ð¹ ÐºÐ½Ð¸Ð³Ð¸ ÐµÑÑ‚ÑŒ Ð¿Ð¾Ð»Ðµ reviews (Ð¼Ð°ÑÑÐ¸Ð²)

// Ð¨Ð°Ð³ 2: Ð¤Ð¸Ð»ÑŒÑ‚Ñ€ÑƒÐµÐ¼ ÐºÐ½Ð¸Ð³Ð¸ Ñ Ð¿ÑƒÑÑ‚Ñ‹Ð¼ Ð¼Ð°ÑÑÐ¸Ð²Ð¾Ð¼ Ð¾Ñ‚Ð·Ñ‹Ð²Ð¾Ð²
db.books.aggregate([
  {
    $lookup: {
      from: "reviews",
      localField: "_id",
      foreignField: "bookId",
      as: "reviews"
    }
  },
  {
    $match: {
      reviews: {$size: 0}  // Ð Ð°Ð·Ð¼ÐµÑ€ Ð¼Ð°ÑÑÐ¸Ð²Ð° = 0
    }
  }
])

// Ð¨Ð°Ð³ 3: Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ñ€Ð¾Ð² Ð¸ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÐ¼
db.books.aggregate([
  {
    $lookup: {
      from: "reviews",
      localField: "_id",
      foreignField: "bookId",
      as: "reviews"
    }
  },
  {
    $match: {
      reviews: {$size: 0}
    }
  },
  {
    $lookup: {
      from: "authors",
      localField: "authorId",
      foreignField: "_id",
      as: "author"
    }
  },
  {$unwind: "$author"},
  {
    $project: {
      title: 1,
      authorName: "$author.name",
      publishedYear: 1
    }
  }
])
// âœ… Ð“Ð¾Ñ‚Ð¾Ð²Ð¾! ÐÐ°ÑˆÐ»Ð¸ ÐºÐ½Ð¸Ð³Ð¸, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¼ Ð½ÑƒÐ¶Ð½Ñ‹ Ð¾Ñ‚Ð·Ñ‹Ð²Ñ‹
```

---

### ðŸ’¡ ÐŸÐ¾Ð»ÐµÐ·Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð´Ð»Ñ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¸:

```js
// ÐŸÐ¾Ð´ÑÑ‡ÐµÑ‚ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð² Ð² ÐºÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¸
db.books.countDocuments()

// ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ð¿ÐµÑ€Ð²Ñ‹Ñ… N Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð²
db.books.find().limit(3)

// ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°
db.books.findOne()

// ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÑÐºÑ€Ð°Ð½Ð°
cls  // Ð¸Ð»Ð¸ clear

// ÐšÑ€Ð°ÑÐ¸Ð²Ñ‹Ð¹ Ð²Ñ‹Ð²Ð¾Ð´
db.books.find().pretty()

// ÐžÐ±ÑŠÑÑÐ½ÐµÐ½Ð¸Ðµ Ð¿Ð»Ð°Ð½Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°
db.books.find({genre: "Ñ€Ð¾Ð¼Ð°Ð½"}).explain("executionStats")
```

---

### 8. Ð¡Ð°Ð¼Ð¾ÑÑ‚Ð¾ÑÑ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ð°

```py
# Ð—Ð°Ð´Ð°Ð½Ð¸Ðµ 1: Ð¢Ð¾Ð¿-5 ÑÐ°Ð¼Ñ‹Ñ… Ð´Ð»Ð¸Ð½Ð½Ñ‹Ñ… ÐºÐ½Ð¸Ð³
@app.get("/books/longest")
def get_longest_books():
    """ÐÐ°Ð¹Ñ‚Ð¸ 5 ÑÐ°Ð¼Ñ‹Ñ… Ð´Ð»Ð¸Ð½Ð½Ñ‹Ñ… ÐºÐ½Ð¸Ð³ Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÐµÐ¹ Ð¾Ð± Ð°Ð²Ñ‚Ð¾Ñ€Ð°Ñ…"""
    pipeline = [
        # Ð¨Ð°Ð³ 1: Ð¡Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð²ÑÐµ ÐºÐ½Ð¸Ð³Ð¸ Ð¿Ð¾ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ñƒ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ† (Ð¾Ñ‚ Ð±Ð¾Ð»ÑŒÑˆÐµÐ³Ð¾ Ðº Ð¼ÐµÐ½ÑŒÑˆÐµÐ¼Ñƒ)
        {"$sort": {"pages": -1}},  # -1 = Ð¿Ð¾ ÑƒÐ±Ñ‹Ð²Ð°Ð½Ð¸ÑŽ (DESC)
        
        # Ð¨Ð°Ð³ 2: Ð‘ÐµÑ€ÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿ÐµÑ€Ð²Ñ‹Ðµ 5 ÐºÐ½Ð¸Ð³ Ð¿Ð¾ÑÐ»Ðµ ÑÐ¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²ÐºÐ¸
        {"$limit": 5},
        
        # Ð¨Ð°Ð³ 3: ÐŸÑ€Ð¸ÑÐ¾ÐµÐ´Ð¸Ð½ÑÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾Ð± Ð°Ð²Ñ‚Ð¾Ñ€Ð°Ñ… (Ð°Ð½Ð°Ð»Ð¾Ð³ JOIN Ð² SQL)
        {
            "$lookup": {
                "from": "authors",           # Ð˜Ð· ÐºÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¸ authors
                "localField": "authorId",    # ÐŸÐ¾Ð»Ðµ authorId Ð² books
                "foreignField": "_id",       # ÐŸÐ¾Ð»Ðµ _id Ð² authors
                "as": "author"               # Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð² Ð¿Ð¾Ð»Ðµ author (Ð¼Ð°ÑÑÐ¸Ð²)
            }
        },
        
        # Ð¨Ð°Ð³ 4: Ð Ð°Ð·Ð²Ð¾Ñ€Ð°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð¼Ð°ÑÑÐ¸Ð² author Ð² Ð¾Ð±ÑŠÐµÐºÑ‚ (Ð¸Ð· [{}] Ð² {})
        {"$unwind": "$author"},
        
        # Ð¨Ð°Ð³ 5: Ð’Ñ‹Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½ÑƒÐ¶Ð½Ñ‹Ðµ Ð¿Ð¾Ð»Ñ Ð´Ð»Ñ Ð¾Ñ‚Ð²ÐµÑ‚Ð°
        {
            "$project": {
                "title": 1,                      # Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð»Ðµ title
                "pages": 1,                      # Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð»Ðµ pages
                "authorName": "$author.name",    # Ð’Ð·ÑÑ‚ÑŒ Ð¸Ð¼Ñ Ð°Ð²Ñ‚Ð¾Ñ€Ð° Ð¸Ð· Ð²Ð»Ð¾Ð¶ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð¾Ð±ÑŠÐµÐºÑ‚Ð°
                "publishedYear": 1               # Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ð³Ð¾Ð´ Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ð¸
            }
        }
    ]
    return list(db.books.aggregate(pipeline))

# Ð—Ð°Ð´Ð°Ð½Ð¸Ðµ 2: Ð¡Ñ€ÐµÐ´Ð½Ð¸Ð¹ Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³ ÐºÐ°Ð¶Ð´Ð¾Ð¹ ÐºÐ½Ð¸Ð³Ð¸
@app.get("/books/ratings")
def get_books_ratings():
    """ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÑ€ÐµÐ´Ð½ÑŽÑŽ Ð¾Ñ†ÐµÐ½ÐºÑƒ Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð¹ ÐºÐ½Ð¸Ð³Ð¸"""
    pipeline = [
        # Ð¨Ð°Ð³ 1: Ð“Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð¾Ñ‚Ð·Ñ‹Ð²Ñ‹ Ð¿Ð¾ bookId Ð¸ ÑÑ‡Ð¸Ñ‚Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ
        {
            "$group": {
                "_id": "$bookId",                    # Ð“Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ð¾ ID ÐºÐ½Ð¸Ð³Ð¸
                "avgRating": {"$avg": "$rating"},    # Ð¡Ñ€ÐµÐ´Ð½Ð¸Ð¹ Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³
                "reviewCount": {"$sum": 1}           # ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¾Ñ‚Ð·Ñ‹Ð²Ð¾Ð² (ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð¾Ñ‚Ð·Ñ‹Ð² = +1)
            }
        },
        
        # Ð¨Ð°Ð³ 2: ÐŸÑ€Ð¸ÑÐ¾ÐµÐ´Ð¸Ð½ÑÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ ÐºÐ½Ð¸Ð³Ðµ Ð¿Ð¾ ÐµÑ‘ ID
        {
            "$lookup": {
                "from": "books",              # Ð˜Ð· ÐºÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¸ books
                "localField": "_id",          # _id Ð¸Ð· Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð° Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ¸ (ÑÑ‚Ð¾ bookId)
                "foreignField": "_id",        # _id Ð² ÐºÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¸ books
                "as": "book"                  # Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð² Ð¿Ð¾Ð»Ðµ book
            }
        },
        
        # Ð¨Ð°Ð³ 3: Ð Ð°Ð·Ð²Ð¾Ñ€Ð°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð¼Ð°ÑÑÐ¸Ð² book Ð² Ð¾Ð±ÑŠÐµÐºÑ‚
        {"$unwind": "$book"},
        
        # Ð¨Ð°Ð³ 4: Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ð¸Ñ‚Ð¾Ð³Ð¾Ð²ÑƒÑŽ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ð¾Ñ‚Ð²ÐµÑ‚Ð°
        {
            "$project": {
                "title": "$book.title",                      # ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ ÐºÐ½Ð¸Ð³Ð¸
                "avgRating": {"$round": ["$avgRating", 2]},  # ÐžÐºÑ€ÑƒÐ³Ð»ÑÐµÐ¼ Ð´Ð¾ 2 Ð·Ð½Ð°ÐºÐ¾Ð²
                "reviewCount": 1                             # ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¾Ñ‚Ð·Ñ‹Ð²Ð¾Ð²
            }
        },
        
        # Ð¨Ð°Ð³ 5: Ð¡Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ð¾ ÑÑ€ÐµÐ´Ð½ÐµÐ¼Ñƒ Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³Ñƒ (Ð»ÑƒÑ‡ÑˆÐ¸Ðµ ÐºÐ½Ð¸Ð³Ð¸ ÑÐ²ÐµÑ€Ñ…Ñƒ)
        {"$sort": {"avgRating": -1}}
    ]
    return list(db.reviews.aggregate(pipeline))

# Ð—Ð°Ð´Ð°Ð½Ð¸Ðµ 3: Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¿Ð¾ Ð°Ð²Ñ‚Ð¾Ñ€Ð°Ð¼
@app.get("/authors/stats")
def get_authors_stats():
    """ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÐºÐ½Ð¸Ð³ Ð¸ Ð¾Ð±Ñ‰ÐµÐµ Ñ‡Ð¸ÑÐ»Ð¾ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ† Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð°Ð²Ñ‚Ð¾Ñ€Ð°"""
    pipeline = [
        # Ð¨Ð°Ð³ 1: Ð“Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ½Ð¸Ð³Ð¸ Ð¿Ð¾ authorId Ð¸ ÑÑ‡Ð¸Ñ‚Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ
        {
            "$group": {
                "_id": "$authorId",                   # Ð“Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ð¾ ID Ð°Ð²Ñ‚Ð¾Ñ€Ð°
                "bookCount": {"$sum": 1},             # ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÐºÐ½Ð¸Ð³ (ÐºÐ°Ð¶Ð´Ð°Ñ ÐºÐ½Ð¸Ð³Ð° = +1)
                "totalPages": {"$sum": "$pages"},     # Ð¡ÑƒÐ¼Ð¼Ð° Ð²ÑÐµÑ… ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†
                "avgPages": {"$avg": "$pages"}        # Ð¡Ñ€ÐµÐ´Ð½ÐµÐµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†
            }
        },
        
        # Ð¨Ð°Ð³ 2: ÐŸÑ€Ð¸ÑÐ¾ÐµÐ´Ð¸Ð½ÑÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾Ð± Ð°Ð²Ñ‚Ð¾Ñ€Ðµ
        {
            "$lookup": {
                "from": "authors",
                "localField": "_id",          # _id Ð¸Ð· Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ¸ (authorId)
                "foreignField": "_id",        # _id Ð² ÐºÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¸ authors
                "as": "author"
            }
        },
        
        # Ð¨Ð°Ð³ 3: Ð Ð°Ð·Ð²Ð¾Ñ€Ð°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð¼Ð°ÑÑÐ¸Ð² author
        {"$unwind": "$author"},
        
        # Ð¨Ð°Ð³ 4: Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ð¾Ñ‚Ð²ÐµÑ‚Ð°
        {
            "$project": {
                "authorName": "$author.name",              # Ð˜Ð¼Ñ Ð°Ð²Ñ‚Ð¾Ñ€Ð°
                "bookCount": 1,                            # ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÐºÐ½Ð¸Ð³
                "totalPages": 1,                           # Ð’ÑÐµÐ³Ð¾ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†
                "avgPages": {"$round": ["$avgPages", 0]}   # Ð¡Ñ€ÐµÐ´Ð½ÐµÐµ (Ð¾ÐºÑ€ÑƒÐ³Ð»ÐµÐ½Ð¾)
            }
        },
        
        # Ð¨Ð°Ð³ 5: Ð¡Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ð¾ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ñƒ ÐºÐ½Ð¸Ð³ (ÑÐ°Ð¼Ñ‹Ðµ Ð¿Ð»Ð¾Ð´Ð¾Ð²Ð¸Ñ‚Ñ‹Ðµ Ð°Ð²Ñ‚Ð¾Ñ€Ñ‹ ÑÐ²ÐµÑ€Ñ…Ñƒ)
        {"$sort": {"bookCount": -1}}
    ]
    return list(db.books.aggregate(pipeline))

# Ð—Ð°Ð´Ð°Ð½Ð¸Ðµ 4: ÐšÐ½Ð¸Ð³Ð¸ Ð¿Ð¾ Ð¶Ð°Ð½Ñ€Ð°Ð¼
@app.get("/books/by-genre")
def get_books_by_genre():
    """Ð“Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ° ÐºÐ½Ð¸Ð³ Ð¿Ð¾ Ð¶Ð°Ð½Ñ€Ð°Ð¼ Ñ Ð¿Ð¾Ð´ÑÑ‡ÐµÑ‚Ð¾Ð¼"""
    pipeline = [
        # Ð¨Ð°Ð³ 1: Ð“Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ½Ð¸Ð³Ð¸ Ð¿Ð¾ Ð¶Ð°Ð½Ñ€Ñƒ
        {
            "$group": {
                "_id": "$genre",                      # Ð“Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ð¾ Ð¶Ð°Ð½Ñ€Ñƒ
                "count": {"$sum": 1},                 # ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÐºÐ½Ð¸Ð³ Ð² Ð¶Ð°Ð½Ñ€Ðµ
                "books": {"$push": "$title"},         # Ð¡Ð¾Ð±Ñ€Ð°Ñ‚ÑŒ Ð²ÑÐµ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ Ð² Ð¼Ð°ÑÑÐ¸Ð²
                "avgPages": {"$avg": "$pages"}        # Ð¡Ñ€ÐµÐ´Ð½ÐµÐµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ† Ð² Ð¶Ð°Ð½Ñ€Ðµ
            }
        },
        
        # Ð¨Ð°Ð³ 2: Ð¡Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ð¾ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ñƒ ÐºÐ½Ð¸Ð³ (Ð¿Ð¾Ð¿ÑƒÐ»ÑÑ€Ð½Ñ‹Ðµ Ð¶Ð°Ð½Ñ€Ñ‹ ÑÐ²ÐµÑ€Ñ…Ñƒ)
        {"$sort": {"count": -1}}
    ]
    # Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚: [{"_id": "Ñ€Ð¾Ð¼Ð°Ð½", "count": 15, "books": [...], "avgPages": 450}, ...]
    return list(db.books.aggregate(pipeline))

# Ð—Ð°Ð´Ð°Ð½Ð¸Ðµ 5: ÐŸÐ¾Ð¸ÑÐº ÐºÐ½Ð¸Ð³ Ð¿Ð¾ Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½Ñƒ Ð»ÐµÑ‚
@app.get("/books/by-years/{start_year}/{end_year}")
def get_books_by_years(start_year: int, end_year: int):
    """ÐÐ°Ð¹Ñ‚Ð¸ ÐºÐ½Ð¸Ð³Ð¸, Ð¾Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð² Ð·Ð°Ð´Ð°Ð½Ð½Ð¾Ð¼ Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½Ðµ Ð»ÐµÑ‚"""
    pipeline = [
        # Ð¨Ð°Ð³ 1: Ð¤Ð¸Ð»ÑŒÑ‚Ñ€ÑƒÐµÐ¼ ÐºÐ½Ð¸Ð³Ð¸ Ð¿Ð¾ Ð³Ð¾Ð´Ñƒ Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ð¸ (Ð°Ð½Ð°Ð»Ð¾Ð³ WHERE Ð² SQL)
        {
            "$match": {
                "publishedYear": {
                    "$gte": start_year,  # Greater Than or Equal (>=)
                    "$lte": end_year     # Less Than or Equal (<=)
                }
            }
        },
        
        # Ð¨Ð°Ð³ 2: ÐŸÑ€Ð¸ÑÐ¾ÐµÐ´Ð¸Ð½ÑÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾Ð± Ð°Ð²Ñ‚Ð¾Ñ€Ð°Ñ…
        {
            "$lookup": {
                "from": "authors",
                "localField": "authorId",
                "foreignField": "_id",
                "as": "author"
            }
        },
        
        # Ð¨Ð°Ð³ 3: Ð Ð°Ð·Ð²Ð¾Ñ€Ð°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð¼Ð°ÑÑÐ¸Ð² author
        {"$unwind": "$author"},
        
        # Ð¨Ð°Ð³ 4: Ð’Ñ‹Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð½ÑƒÐ¶Ð½Ñ‹Ðµ Ð¿Ð¾Ð»Ñ
        {
            "$project": {
                "title": 1,
                "authorName": "$author.name",
                "publishedYear": 1,
                "genre": 1
            }
        },
        
        # Ð¨Ð°Ð³ 5: Ð¡Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ð¾ Ð³Ð¾Ð´Ñƒ (Ð¾Ñ‚ ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ðº Ð½Ð¾Ð²Ñ‹Ð¼)
        {"$sort": {"publishedYear": 1}}  # 1 = Ð¿Ð¾ Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚Ð°Ð½Ð¸ÑŽ (ASC)
    ]
    # ÐŸÑ€Ð¸Ð¼ÐµÑ€: /books/by-years/1850/1900 Ð²ÐµÑ€Ð½ÐµÑ‚ ÐºÐ½Ð¸Ð³Ð¸ Ñ 1850 Ð¿Ð¾ 1900 Ð³Ð¾Ð´
    return list(db.books.aggregate(pipeline))

# Ð‘Ð¾Ð½ÑƒÑ: Ð¡Ð°Ð¼Ñ‹Ð¹ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ð¹ Ñ€ÐµÑ†ÐµÐ½Ð·ÐµÐ½Ñ‚
@app.get("/reviewers/top")
def get_top_reviewers():
    """ÐÐ°Ð¹Ñ‚Ð¸ ÑÐ°Ð¼Ñ‹Ñ… Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ñ€ÐµÑ†ÐµÐ½Ð·ÐµÐ½Ñ‚Ð¾Ð²"""
    pipeline = [
        # Ð¨Ð°Ð³ 1: Ð“Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð¾Ñ‚Ð·Ñ‹Ð²Ñ‹ Ð¿Ð¾ Ð¸Ð¼ÐµÐ½Ð¸ Ñ€ÐµÑ†ÐµÐ½Ð·ÐµÐ½Ñ‚Ð°
        {
            "$group": {
                "_id": "$reviewerName",              # Ð“Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ð¾ Ð¸Ð¼ÐµÐ½Ð¸
                "reviewCount": {"$sum": 1},          # ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¾Ñ‚Ð·Ñ‹Ð²Ð¾Ð²
                "avgRating": {"$avg": "$rating"}     # Ð¡Ñ€ÐµÐ´Ð½ÑÑ Ð¾Ñ†ÐµÐ½ÐºÐ°, ÐºÐ¾Ñ‚Ð¾Ñ€ÑƒÑŽ ÑÑ‚Ð°Ð²Ð¸Ñ‚ Ñ€ÐµÑ†ÐµÐ½Ð·ÐµÐ½Ñ‚
            }
        },
        
        # Ð¨Ð°Ð³ 2: Ð¡Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ð¾ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ñƒ Ð¾Ñ‚Ð·Ñ‹Ð²Ð¾Ð² (ÑÐ°Ð¼Ñ‹Ðµ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ðµ ÑÐ²ÐµÑ€Ñ…Ñƒ)
        {"$sort": {"reviewCount": -1}},
        
        # Ð¨Ð°Ð³ 3: Ð‘ÐµÑ€ÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‚Ð¾Ð¿-5
        {"$limit": 5}
    ]
    # Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚: [{"_id": "Ð˜Ð²Ð°Ð½", "reviewCount": 25, "avgRating": 4.2}, ...]
    return list(db.reviews.aggregate(pipeline))

# Ð‘Ð¾Ð½ÑƒÑ: ÐšÐ½Ð¸Ð³Ð¸ Ð±ÐµÐ· Ð¾Ñ‚Ð·Ñ‹Ð²Ð¾Ð²
@app.get("/books/no-reviews")
def get_books_without_reviews():
    """ÐÐ°Ð¹Ñ‚Ð¸ ÐºÐ½Ð¸Ð³Ð¸, Ñƒ ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ñ… Ð½ÐµÑ‚ Ð¾Ñ‚Ð·Ñ‹Ð²Ð¾Ð²"""
    pipeline = [
        # Ð¨Ð°Ð³ 1: ÐŸÑ€Ð¸ÑÐ¾ÐµÐ´Ð¸Ð½ÑÐµÐ¼ Ð¾Ñ‚Ð·Ñ‹Ð²Ñ‹ Ðº ÐºÐ°Ð¶Ð´Ð¾Ð¹ ÐºÐ½Ð¸Ð³Ðµ
        {
            "$lookup": {
                "from": "reviews",           # Ð˜Ð· ÐºÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¸ reviews
                "localField": "_id",         # _id ÐºÐ½Ð¸Ð³Ð¸
                "foreignField": "bookId",    # bookId Ð² Ð¾Ñ‚Ð·Ñ‹Ð²Ð°Ñ…
                "as": "reviews"              # Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð² Ð¿Ð¾Ð»Ðµ reviews (Ð¼Ð°ÑÑÐ¸Ð²)
            }
        },
        
        # Ð¨Ð°Ð³ 2: Ð¤Ð¸Ð»ÑŒÑ‚Ñ€ÑƒÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐºÐ½Ð¸Ð³Ð¸ Ñ Ð¿ÑƒÑÑ‚Ñ‹Ð¼ Ð¼Ð°ÑÑÐ¸Ð²Ð¾Ð¼ Ð¾Ñ‚Ð·Ñ‹Ð²Ð¾Ð²
        {
            "$match": {
                "reviews": {"$size": 0}      # Ð Ð°Ð·Ð¼ÐµÑ€ Ð¼Ð°ÑÑÐ¸Ð²Ð° = 0 (Ð½ÐµÑ‚ Ð¾Ñ‚Ð·Ñ‹Ð²Ð¾Ð²)
            }
        },
        
        # Ð¨Ð°Ð³ 3: ÐŸÑ€Ð¸ÑÐ¾ÐµÐ´Ð¸Ð½ÑÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾Ð± Ð°Ð²Ñ‚Ð¾Ñ€Ðµ
        {
            "$lookup": {
                "from": "authors",
                "localField": "authorId",
                "foreignField": "_id",
                "as": "author"
            }
        },
        
        # Ð¨Ð°Ð³ 4: Ð Ð°Ð·Ð²Ð¾Ñ€Ð°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð¼Ð°ÑÑÐ¸Ð² author
        {"$unwind": "$author"},
        
        # Ð¨Ð°Ð³ 5: Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ð¾Ñ‚Ð²ÐµÑ‚
        {
            "$project": {
                "title": 1,
                "authorName": "$author.name",
                "publishedYear": 1
            }
        }
    ]
    # ÐŸÐ¾Ð»ÐµÐ·Ð½Ð¾ Ð´Ð»Ñ Ð¿Ð¾Ð¸ÑÐºÐ° Ð½ÐµÐ¿Ð¾Ð¿ÑƒÐ»ÑÑ€Ð½Ñ‹Ñ… ÐºÐ½Ð¸Ð³ Ð¸Ð»Ð¸ Ð½Ð¾Ð²Ñ‹Ñ… Ð¿Ð¾ÑÑ‚ÑƒÐ¿Ð»ÐµÐ½Ð¸Ð¹
    return list(db.books.aggregate(pipeline))

```