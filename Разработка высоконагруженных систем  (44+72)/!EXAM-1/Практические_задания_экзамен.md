# Практические задания для экзамена

## Задание 1: FastAPI + SQLAlchemy - CRUD API для блога

Создайте REST API для блога с использованием FastAPI и SQLAlchemy:

**Требования:**
- Модели: User, Post, Comment
- Эндпоинты: создание/чтение/обновление/удаление постов
- Связи: один пользователь - много постов, один пост - много комментариев
- Pydantic схемы для валидации
- Асинхронные операции с БД

**Критерии оценки:**
- Правильная структура моделей SQLAlchemy
- Использование async/await
- Валидация через Pydantic
- Обработка ошибок

---

## Задание 2: PostgreSQL - Оконные функции для аналитики продаж

Дана таблица `orders(id, product_id, user_id, amount, order_date)`.

**Напишите запросы:**
1. Нарастающий итог продаж по дням
2. Топ-3 товара по продажам в каждом месяце (RANK)
3. Скользящее среднее за последние 7 дней
4. Процент каждого заказа от дневной суммы

**Критерии оценки:**
- Корректное использование PARTITION BY, ORDER BY
- Применение LAG/LEAD для сравнения периодов
- Оптимизация запросов

---

## Задание 3: PostgreSQL - Функции и процедуры

Создайте:
1. **Функцию** `calculate_discount(user_id, amount)` - возвращает скидку на основе истории покупок
2. **Процедуру** `process_monthly_report()` - агрегирует данные за месяц в отдельную таблицу
3. **Триггер** - автоматически обновляет поле `updated_at` при изменении записи

**Критерии оценки:**
- Правильный синтаксис PL/pgSQL
- Обработка исключений
- Использование транзакций

---

## Задание 4: PostgreSQL - Полнотекстовый поиск

Реализуйте поиск по статьям блога:

**Требования:**
1. Создать GIN индекс для полнотекстового поиска
2. Поиск с ранжированием результатов (ts_rank)
3. Поддержка морфологии (русский язык)
4. Подсветка найденных фрагментов (ts_headline)

**Критерии оценки:**
- Настройка tsvector и tsquery
- Производительность поиска
- Релевантность результатов

---

## Задание 5: Redis - Кэширование и Rate Limiting

Реализуйте в FastAPI:

**Задачи:**
1. Кэширование результатов API запросов (TTL 5 минут)
2. Rate limiting - максимум 10 запросов в минуту на пользователя
3. Счетчик просмотров статей (INCR)
4. Список последних просмотренных статей (LIST)

**Критерии оценки:**
- Правильное использование Redis команд
- Middleware для rate limiting
- Обработка истечения TTL

---

## Задание 6: MongoDB - Агрегация данных

Дана коллекция `products` с полями: `name, category, price, tags, reviews`.

**Напишите агрегации:**
1. Средняя цена по категориям
2. Топ-5 товаров с лучшими отзывами
3. Количество товаров по тегам ($unwind)
4. Товары с ценой выше средней в своей категории

**Критерии оценки:**
- Использование $match, $group, $project
- Оптимизация pipeline
- Работа с массивами

---

## Задание 7: MongoDB + FastAPI - API для каталога

Создайте API для каталога товаров:

**Требования:**
- CRUD операции через Motor (async MongoDB driver)
- Фильтрация по категориям и ценовому диапазону
- Пагинация результатов
- Поиск по названию (regex)

**Критерии оценки:**
- Асинхронная работа с MongoDB
- Эффективные запросы
- Валидация данных

---

## Задание 8: OpenSearch - Настройка индекса и поиск

Создайте индекс для поиска по товарам:

**Требования:**
1. Mapping с полями: title (text), description (text), price (float), category (keyword)
2. Полнотекстовый поиск с фильтрами
3. Агрегация по категориям (buckets)
4. Автодополнение (completion suggester)

**Критерии оценки:**
- Правильная настройка mapping
- Использование bool queries
- Релевантность поиска

---

## Задание 9: OpenSearch + FastAPI - Поисковый API

Реализуйте поисковый API:

**Требования:**
- Эндпоинт `/search?q=...&category=...&min_price=...`
- Подсветка найденных слов (highlight)
- Фасетный поиск (aggregations)
- Сортировка по релевантности и цене

**Критерии оценки:**
- Интеграция с OpenSearch
- Обработка сложных запросов
- Производительность

---

## Задание 10: FastAPI + GraphQL - Схема для блога

Создайте GraphQL API:

**Требования:**
1. Типы: User, Post, Comment
2. Queries: user(id), posts(limit, offset), post(id)
3. Mutations: createPost, updatePost, deletePost
4. Nested queries: post { author { name } comments { text } }

**Критерии оценки:**
- Правильная структура схемы
- Resolvers для связанных данных
- N+1 problem решение (DataLoader)

---

## Задание 11: GraphQL Subscriptions - Реалтайм уведомления

Реализуйте подписки:

**Требования:**
1. Subscription `newPost` - уведомление о новых постах
2. Subscription `commentAdded(postId)` - новые комментарии к посту
3. WebSocket соединение
4. Фильтрация событий

**Критерии оценки:**
- Работа с WebSocket
- Pub/Sub паттерн
- Управление подписками

---

## Задание 12: Комплексное - FastAPI + PostgreSQL + Redis + OpenSearch

Создайте API для интернет-магазина:

**Архитектура:**
- PostgreSQL - основные данные (товары, заказы, пользователи)
- Redis - кэш, сессии, корзина
- OpenSearch - поиск по каталогу

**Функционал:**
1. Регистрация/авторизация (JWT в Redis)
2. Каталог с поиском (OpenSearch)
3. Корзина (Redis Hash)
4. Оформление заказа (PostgreSQL транзакция)
5. История заказов с аналитикой (оконные функции)

**Критерии оценки:**
- Интеграция всех компонентов
- Транзакции и консистентность
- Производительность

---

## Задание 13: PostgreSQL - Процедура для отчета с оконными функциями

Создайте процедуру `generate_sales_report(start_date, end_date)`:

**Требования:**
1. Использует оконные функции для расчета:
   - Нарастающий итог по дням
   - Ранг товаров по продажам
   - Процент от общей суммы
2. Сохраняет результат в таблицу `reports`
3. Возвращает статистику

**Критерии оценки:**
- Сложные оконные функции
- Оптимизация запросов
- Обработка ошибок

---

## Задание 14: MongoDB + Redis - Кэширование агрегаций

Реализуйте систему кэширования:

**Требования:**
1. Сложная агрегация в MongoDB (статистика по категориям)
2. Кэширование результата в Redis (TTL 10 минут)
3. Инвалидация кэша при изменении данных
4. Middleware для автоматического кэширования

**Критерии оценки:**
- Стратегия кэширования
- Инвалидация кэша
- Производительность

---

## Задание 15: Полный стек - Микросервисная архитектура

Создайте 3 микросервиса:

**Сервисы:**
1. **Auth Service** (FastAPI + PostgreSQL + Redis)
   - Регистрация, авторизация, JWT
2. **Product Service** (FastAPI + MongoDB + OpenSearch)
   - CRUD товаров, поиск
3. **Order Service** (FastAPI + PostgreSQL)
   - Создание заказов, история

**Требования:**
- GraphQL Gateway для объединения сервисов
- Redis для межсервисного кэша
- Docker Compose для запуска

**Критерии оценки:**
- Архитектура микросервисов
- Взаимодействие сервисов
- Масштабируемость
