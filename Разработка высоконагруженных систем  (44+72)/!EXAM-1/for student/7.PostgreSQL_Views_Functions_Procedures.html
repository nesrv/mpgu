<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–∞–∫—Ç–∏–∫–∞: PostgreSQL Views, Functions, Procedures</title>
    <style media="print">
        body { font-family: Arial, sans-serif; font-size: 12px; }
        .container { box-shadow: none; background: white; }
        .header { background: white !important; color: black !important; }
        .save-btn { display: none !important; }
        .section { page-break-inside: avoid; }
        input, textarea { border: 1px solid #ccc; background: white; color: black; }
        .code-block { background: white !important; color: black !important; border: 1px solid #ccc; }
    </style>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            margin-top: 20px;
            margin-bottom: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .header {
            text-align: center;
            padding: 30px 0;
            background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%);
            color: white;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .student-info {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #4A90E2;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #4A90E2;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        .form-group textarea {
            min-height: auto;
            resize: vertical;
        }

        .section textarea.code-textarea {
            min-height: 300px;
        }

        .code-textarea {
            font-family: 'Courier New', monospace;
            background: #2d3748;
            color: #e2e8f0;
            white-space: pre;
            tab-size: 4;
        }

        .code-editor-wrapper {
            position: relative;
        }

        .code-highlight {
            display: none;
        }

        .section {
            margin-bottom: 40px;
            padding: 25px;
            background: #fff;
            border-left: 5px solid #4A90E2;
            border-radius: 0 10px 10px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section h2 {
            color: #4A90E2;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .section h3 {
            color: #357ABD;
            margin: 20px 0 10px 0;
            font-size: 1.3em;
        }

        .section h4 {
            color: #555;
            margin: 15px 0 10px 0;
            font-size: 1.1em;
        }

        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            white-space: pre;
        }

        .code-block .keyword { color: #ff79c6; font-weight: bold; }
        .code-block .string { color: #f1fa8c; }
        .code-block .function { color: #50fa7b; }
        .code-block .class { color: #8be9fd; }
        .code-block .decorator { color: #ff79c6; }
        .code-block .comment { color: #6272a4; font-style: italic; }
        .code-block .number { color: #bd93f9; }
        .code-block .operator { color: #ff79c6; }

        .checkbox-item {
            margin: 15px 0;
            padding: 15px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .checkbox-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .checkbox-item input[type="checkbox"] {
            appearance: none;
            width: 24px;
            height: 24px;
            border: 3px solid white;
            border-radius: 6px;
            margin-right: 15px;
            cursor: pointer;
            position: relative;
            background: transparent;
            transition: all 0.3s;
        }

        .checkbox-item input[type="checkbox"]:checked {
            background: white;
        }

        .checkbox-item input[type="checkbox"]:checked::after {
            content: '‚úì';
            position: absolute;
            top: -2px;
            left: 4px;
            font-size: 18px;
            color: #667eea;
            font-weight: bold;
        }

        .checkbox-item label {
            color: white;
            font-weight: 500;
            cursor: pointer;
            user-select: none;
        }

        .save-btn {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 10px;
            cursor: pointer;
            display: block;
            margin: 30px auto;
            transition: transform 0.3s;
        }

        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
        }

        ul {
            list-style: none;
            padding-left: 0;
        }

        ul li {
            padding: 8px 0 8px 30px;
            position: relative;
        }

        ul li::before {
            content: '‚ñ∏';
            position: absolute;
            left: 0;
            color: #4A90E2;
            font-size: 18px;
            font-weight: bold;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        table th, table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        table th {
            background: #4A90E2;
            color: white;
        }

        table tr:nth-child(even) {
            background: #f8f9fa;
        }

        @media (max-width: 768px) {
            .student-info {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üóÑÔ∏è –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞–±–æ—Ç–∞</h1>
            <h2>PostgreSQL: Views, Functions, Procedures</h2>
            <p>–ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è —Ä–∞–±–æ—Ç–∞ —Å PostgreSQL –≤ —Å—Ä–µ–¥–µ FastAPI</p>
        </div>

        <div class="student-info">
            <div class="form-group">
                <label for="student-name">–§–ò–û —Å—Ç—É–¥–µ–Ω—Ç–∞:</label>
                <input type="text" id="student-name" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á">
            </div>
            <div class="form-group">
                <label for="group">–ì—Ä—É–ø–ø–∞:</label>
                <input type="text" id="group" placeholder="–ò–°–¢-401">
            </div>
            <div class="form-group">
                <label for="date">–î–∞—Ç–∞:</label>
                <input type="date" id="date">
            </div>
        </div>

        <div class="section">
            <h2>üéØ –¶–µ–ª—å —Ä–∞–±–æ—Ç—ã</h2>
            <p>–ò–∑—É—á–∏—Ç—å –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ PostgreSQL (Views, Materialized Views, Cursors, Functions, Procedures) –∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –∏—Ö —Å FastAPI —á–µ—Ä–µ–∑ SQLAlchemy –∏ raw SQL.</p>
            <p>–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ —É—Å–∫–æ—Ä–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –±—ç–∫–µ–Ω–¥–∞ –∑–∞ —Å—á–µ—Ç –ø–µ—Ä–µ–Ω–æ—Å–∞ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.</p>
            
            <h3>–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</h3>
            <p>4 –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏—Ö —á–∞—Å–∞</p>
            
            <h3>–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞</h3>
            <ul>
                <li>–ó–∞–ø—É—Å—Ç–∏—Ç–µ PostgreSQL –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ</li>
                <li>–°–æ–∑–¥–∞–π—Ç–µ –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –ë–î –∏–∑ seed_data.sql</li>
            </ul>
        </div>

        <div class="section">
            <h2>3. –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (Views)</h2>
            
            <h3>3.1 –°–æ–∑–¥–∞—Ç—å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ active_students_view –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</h3>
            <div class="code-block"><span class="keyword">CREATE VIEW</span> active_students_view <span class="keyword">AS</span>
<span class="keyword">SELECT</span> 
    id,
    name,
    email,
    created_at
<span class="keyword">FROM</span> students
<span class="keyword">WHERE</span> status <span class="operator">=</span> <span class="string">'active'</span>;</div>

            <h4>–†–µ–∑—É–ª—å—Ç–∞—Ç:</h4>
            <table>
                <tr>
                    <th>id</th>
                    <th>name</th>
                    <th>email</th>
                    <th>created_at</th>
                </tr>
                <tr>
                    <td>1</td>
                    <td>–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤</td>
                    <td>ivan.ivanov@example.com</td>
                    <td>2025-12-01 22:20:47.421411</td>
                </tr>
                <tr>
                    <td>2</td>
                    <td>–ú–∞—Ä–∏—è –ü–µ—Ç—Ä–æ–≤–∞</td>
                    <td>maria.petrova@example.com</td>
                    <td>2025-12-01 22:20:47.421411</td>
                </tr>
                <tr>
                    <td>3</td>
                    <td>–ê–ª–µ–∫—Å–µ–π –°–∏–¥–æ—Ä–æ–≤</td>
                    <td>alexey.sidorov@example.com</td>
                    <td>2025-12-01 22:20:47.421411</td>
                </tr>
                <tr>
                    <td>5</td>
                    <td>–î–º–∏—Ç—Ä–∏–π –í–æ–ª–∫–æ–≤</td>
                    <td>dmitry.volkov@example.com</td>
                    <td>2025-12-01 22:20:47.421411</td>
                </tr>
                <tr>
                    <td>6</td>
                    <td>–ê–Ω–Ω–∞ –°–º–∏—Ä–Ω–æ–≤–∞</td>
                    <td>anna.smirnova@example.com</td>
                    <td>2025-12-01 22:20:47.421411</td>
                </tr>
                <tr>
                    <td>7</td>
                    <td>–°–µ—Ä–≥–µ–π –õ–µ–±–µ–¥–µ–≤</td>
                    <td>sergey.lebedev@example.com</td>
                    <td>2025-12-01 22:20:47.421411</td>
                </tr>
            </table>

            <h3>3.2 –°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ view top_students_view —Å —Ç–æ–ø-5 —Å—Ç—É–¥–µ–Ω—Ç–∞–º–∏ –ø–æ —Å—Ä–µ–¥–Ω–µ–º—É –±–∞–ª–ª—É</h3>
            <div class="code-block"><span class="keyword">CREATE VIEW</span> top_students_view <span class="keyword">AS</span>
<span class="keyword">SELECT</span> 
   <span class="comment">...</span>
<span class="keyword">FROM</span> 
    <span class="comment">...</span>
<span class="keyword">JOIN</span> 
    <span class="comment">...</span>
<span class="keyword">GROUP</span> <span class="comment">...</span>
<span class="keyword">ORDER</span> <span class="comment">...</span>
<span class="keyword">LIMIT</span> <span class="number">5</span>;

<span class="comment">-- –ü—Ä–æ–≤–µ—Ä–∫–∞:</span>
<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> top_students_view;</div>

            <h4>–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</h4>
            <table>
                <tr>
                    <th>id</th>
                    <th>name</th>
                    <th>email</th>
                    <th>avg_grade</th>
                    <th>courses_count</th>
                </tr>
                <tr>
                    <td>5</td>
                    <td>–î–º–∏—Ç—Ä–∏–π –í–æ–ª–∫–æ–≤</td>
                    <td>dmitry.volkov@example.com</td>
                    <td>4.83</td>
                    <td>6</td>
                </tr>
                <tr>
                    <td>2</td>
                    <td>–ú–∞—Ä–∏—è –ü–µ—Ç—Ä–æ–≤–∞</td>
                    <td>maria.petrova@example.com</td>
                    <td>4.75</td>
                    <td>4</td>
                </tr>
                <tr>
                    <td>1</td>
                    <td>–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤</td>
                    <td>ivan.ivanov@example.com</td>
                    <td>4.63</td>
                    <td>4</td>
                </tr>
                <tr>
                    <td>6</td>
                    <td>–ê–Ω–Ω–∞ –°–º–∏—Ä–Ω–æ–≤–∞</td>
                    <td>anna.smirnova@example.com</td>
                    <td>4.50</td>
                    <td>3</td>
                </tr>
                <tr>
                    <td>7</td>
                    <td>–°–µ—Ä–≥–µ–π –õ–µ–±–µ–¥–µ–≤</td>
                    <td>sergey.lebedev@example.com</td>
                    <td>4.17</td>
                    <td>3</td>
                </tr>
            </table>

            <div class="form-group">
                <label>–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ:</label>
                <textarea class="code-textarea"></textarea>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" id="task3-2">
                <label for="task3-2">–ó–∞–¥–∞–Ω–∏–µ 3.2 –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</label>
            </div>

            <h3>3.3 –°–æ–∑–¥–∞–π—Ç–µ materialized view course_statistics_mv —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –ø–æ –∫–∞–∂–¥–æ–º—É –∫—É—Ä—Å—É</h3>
            <p>–¢—Ä–µ–±—É–µ—Ç—Å—è: –Ω–∞–∑–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤, —Å—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª, –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–ª</p>

            <h4>–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</h4>
            <table>
                <tr>
                    <th>id</th>
                    <th>title</th>
                    <th>students_count</th>
                    <th>avg_grade</th>
                    <th>min_grade</th>
                    <th>max_grade</th>
                </tr>
                <tr>
                    <td>4</td>
                    <td>–ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</td>
                    <td>4</td>
                    <td>4.63</td>
                    <td>4</td>
                    <td>5</td>
                </tr>
                <tr>
                    <td>3</td>
                    <td>–ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ</td>
                    <td>6</td>
                    <td>4.50</td>
                    <td>4</td>
                    <td>5</td>
                </tr>
                <tr>
                    <td>5</td>
                    <td>–ê–ª–≥–æ—Ä–∏—Ç–º—ã –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö</td>
                    <td>3</td>
                    <td>4.50</td>
                    <td>4</td>
                    <td>5</td>
                </tr>
                <tr>
                    <td>6</td>
                    <td>–í–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞</td>
                    <td>4</td>
                    <td>4.25</td>
                    <td>3</td>
                    <td>5</td>
                </tr>
                <tr>
                    <td>1</td>
                    <td>–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞</td>
                    <td>6</td>
                    <td>4.17</td>
                    <td>3</td>
                    <td>5</td>
                </tr>
                <tr>
                    <td>2</td>
                    <td>–§–∏–∑–∏–∫–∞</td>
                    <td>4</td>
                    <td>4.13</td>
                    <td>3.5</td>
                    <td>5</td>
                </tr>
            </table>

            <div class="form-group">
                <label>–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ:</label>
                <textarea class="code-textarea"></textarea>
            </div>

            <h4>–ó–∞–¥–∞—á–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:</h4>
            <ul>
                <li>–ò–∑–º–µ–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–µ</li>
                <li>–í—ã–ø–æ–ª–Ω–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å</li>
                <li>–û–±–Ω–æ–≤–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å</li>
            </ul>

            <div class="checkbox-item">
                <input type="checkbox" id="task3-3">
                <label for="task3-3">–ó–∞–¥–∞–Ω–∏–µ 3.3 –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</label>
            </div>
        </div>

        <div class="section">
            <h2>4. –ü—Ä–æ—Ü–µ–¥—É—Ä—ã (Procedures)</h2>
            
            <h3>4.1 –°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—É add_student –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞</h3>
            <div class="code-block"><span class="keyword">CREATE OR REPLACE PROCEDURE</span> <span class="function">add_student</span>(
    p_name <span class="class">VARCHAR</span>,
    p_email <span class="class">VARCHAR</span>,
    p_status <span class="class">VARCHAR</span> <span class="keyword">DEFAULT</span> <span class="string">'active'</span>
)
<span class="keyword">LANGUAGE</span> sql
<span class="keyword">AS</span> $$
    <span class="keyword">INSERT INTO</span> students (name, email, status)
    <span class="keyword">VALUES</span> (p_name, p_email, p_status);
$$;

<span class="comment">-- –í—ã–∑–æ–≤:</span>
<span class="keyword">CALL</span> <span class="function">add_student</span>(<span class="string">'–ü–µ—Ç—Ä –ü–µ—Ç—Ä–æ–≤'</span>, <span class="string">'petr.petrov@example.com'</span>, <span class="string">'active'</span>);</div>

            <h3>4.2 –°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—É add_grade –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ü–µ–Ω–∫–∏ —Å—Ç—É–¥–µ–Ω—Ç—É –ø–æ –∫—É—Ä—Å—É</h3>
            <div class="code-block"><span class="keyword">CREATE OR REPLACE PROCEDURE</span> <span class="function">add_grade</span>(
  <span class="comment">...</span>
)
<span class="keyword">LANGUAGE</span> sql
<span class="keyword">AS</span> $$
    <span class="keyword">INSERT INTO</span> grades <span class="comment">...</span>
    <span class="keyword">VALUES</span> <span class="comment">...</span>
$$;

<span class="comment">-- –í—ã–∑–æ–≤:</span>
<span class="keyword">CALL</span> <span class="function">add_grade</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">4.5</span>);</div>

            <div class="form-group">
                <label>–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ:</label>
                <textarea class="code-textarea"></textarea>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" id="task4-2">
                <label for="task4-2">–ó–∞–¥–∞–Ω–∏–µ 4.2 –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</label>
            </div>

            <h3>4.3 –°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—É delete_inactive_students –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –±–µ–∑ –æ—Ü–µ–Ω–æ–∫</h3>
            <div class="code-block"><span class="keyword">CREATE OR REPLACE PROCEDURE</span> <span class="function">delete_inactive_students</span>()
<span class="keyword">LANGUAGE</span> sql
<span class="keyword">AS</span> $$
   <span class="comment">...</span>
$$;

<span class="comment">-- –í—ã–∑–æ–≤:</span>
<span class="keyword">CALL</span> <span class="function">delete_inactive_students</span>();</div>

            <div class="form-group">
                <label>–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ:</label>
                <textarea class="code-textarea"></textarea>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" id="task4-3">
                <label for="task4-3">–ó–∞–¥–∞–Ω–∏–µ 4.3 –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</label>
            </div>
        </div>

        <div class="section">
            <h2>5. –§—É–Ω–∫—Ü–∏–∏ (Functions)</h2>
            
            <h3>5.1 –°–æ–∑–¥–∞–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é get_student_avg_grade, –∫–æ—Ç–æ—Ä–∞—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª —Å—Ç—É–¥–µ–Ω—Ç–∞ –ø–æ –µ–≥–æ ID</h3>
            <div class="code-block"><span class="keyword">CREATE OR REPLACE FUNCTION</span> <span class="function">get_student_avg_grade</span>(p_student_id <span class="class">INT</span>)
<span class="keyword">RETURNS</span> <span class="class">NUMERIC</span>
<span class="keyword">LANGUAGE</span> sql
<span class="keyword">AS</span> $$
    <span class="keyword">SELECT</span> <span class="function">COALESCE</span>(<span class="function">ROUND</span>(<span class="function">AVG</span>(grade)::<span class="class">numeric</span>, <span class="number">2</span>), <span class="number">0</span>)
    <span class="keyword">FROM</span> grades
    <span class="keyword">WHERE</span> student_id <span class="operator">=</span> p_student_id;
$$;

<span class="comment">-- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:</span>
<span class="keyword">SELECT</span> name, <span class="function">get_student_avg_grade</span>(id) <span class="keyword">as</span> avg_grade
<span class="keyword">FROM</span> students;</div>

            <h3>5.2 –°–æ–∑–¥–∞–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é count_student_courses, –∫–æ—Ç–æ—Ä–∞—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫—É—Ä—Å–æ–≤ —Å—Ç—É–¥–µ–Ω—Ç–∞</h3>
            <div class="code-block"><span class="keyword">CREATE OR REPLACE FUNCTION</span> <span class="function">count_student_courses</span>(p_student_id <span class="class">INT</span>)
<span class="keyword">RETURNS</span> <span class="class">BIGINT</span>
<span class="keyword">LANGUAGE</span> sql
<span class="keyword">AS</span> $$
   <span class="comment">...</span>
$$;

<span class="comment">-- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:</span>
<span class="keyword">SELECT</span> name, <span class="function">count_student_courses</span>(id) <span class="keyword">as</span> courses_count
<span class="keyword">FROM</span> students;</div>

            <div class="form-group">
                <label>–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ:</label>
                <textarea class="code-textarea"></textarea>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" id="task5-2">
                <label for="task5-2">–ó–∞–¥–∞–Ω–∏–µ 5.2 –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</label>
            </div>

            <h3>5.3 –°–æ–∑–¥–∞–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é get_grade_status, –∫–æ—Ç–æ—Ä–∞—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –æ—Ü–µ–Ω–∫–∏</h3>
            <p>'–û—Ç–ª–∏—á–Ω–æ' (>=4.5), '–•–æ—Ä–æ—à–æ' (>=3.5), '–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ' (<3.5)</p>

            <h4>–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</h4>
            <table>
                <tr>
                    <th>student_id</th>
                    <th>course_id</th>
                    <th>grade</th>
                    <th>status</th>
                </tr>
                <tr>
                    <td>1</td>
                    <td>1</td>
                    <td>5</td>
                    <td>–û—Ç–ª–∏—á–Ω–æ</td>
                </tr>
                <tr>
                    <td>1</td>
                    <td>2</td>
                    <td>4.5</td>
                    <td>–û—Ç–ª–∏—á–Ω–æ</td>
                </tr>
                <tr>
                    <td>1</td>
                    <td>3</td>
                    <td>5</td>
                    <td>–û—Ç–ª–∏—á–Ω–æ</td>
                </tr>
                <tr>
                    <td>1</td>
                    <td>4</td>
                    <td>4</td>
                    <td>–•–æ—Ä–æ—à–æ</td>
                </tr>
                <tr>
                    <td>2</td>
                    <td>1</td>
                    <td>4.5</td>
                    <td>–û—Ç–ª–∏—á–Ω–æ</td>
                </tr>
            </table>

            <div class="code-block"><span class="keyword">CREATE OR REPLACE FUNCTION</span> <span class="function">get_grade_status</span>(p_grade <span class="class">REAL</span>)
<span class="keyword">RETURNS</span> <span class="class">TEXT</span>
<span class="keyword">LANGUAGE</span> sql
<span class="keyword">IMMUTABLE</span>
<span class="keyword">AS</span> $$
    <span class="keyword">SELECT CASE</span>
       <span class="comment">...</span>
    <span class="keyword">END</span>;
$$;

<span class="comment">-- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:</span>

<span class="comment">-- –ü—Ä–æ—Å—Ç–æ–π –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏</span>
<span class="keyword">SELECT</span> <span class="function">get_grade_status</span>(<span class="number">4.8</span>);  <span class="comment">-- –†–µ–∑—É–ª—å—Ç–∞—Ç: '–û—Ç–ª–∏—á–Ω–æ'</span>
<span class="keyword">SELECT</span> <span class="function">get_grade_status</span>(<span class="number">4.0</span>);  <span class="comment">-- –†–µ–∑—É–ª—å—Ç–∞—Ç: '–•–æ—Ä–æ—à–æ'</span>

<span class="comment">-- –ü—Ä–∏–º–µ—Ä —Å —Ç–∞–±–ª–∏—Ü–µ–π –æ—Ü–µ–Ω–æ–∫</span>
<span class="keyword">SELECT</span> 
    student_id,
    course_id,
    grade,
    <span class="function">get_grade_status</span>(grade) <span class="keyword">AS</span> status
<span class="keyword">FROM</span> grades
<span class="keyword">LIMIT</span> <span class="number">5</span>;

<span class="comment">-- –µ—â–µ –ø—Ä–∏–º–µ—Ä</span>
<span class="keyword">SELECT</span> 
    s.name, 
    c.title, 
    g.grade, 
    <span class="function">get_grade_status</span>(g.grade) <span class="keyword">as</span> status
<span class="keyword">FROM</span> grades g
<span class="keyword">JOIN</span> students s <span class="keyword">ON</span> g.student_id <span class="operator">=</span> s.id
<span class="keyword">JOIN</span> courses c <span class="keyword">ON</span> g.course_id <span class="operator">=</span> c.id
<span class="keyword">LIMIT</span> <span class="number">5</span>;</div>

            <div class="form-group">
                <label>–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ:</label>
                <textarea class="code-textarea"></textarea>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" id="task5-3">
                <label for="task5-3">–ó–∞–¥–∞–Ω–∏–µ 5.3 –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</label>
            </div>

            <h3>5.4 –°–æ–∑–¥–∞–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é calculate_course_discount, –∫–æ—Ç–æ—Ä–∞—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ü–µ–Ω—É –∫—É—Ä—Å–∞ —Å–æ —Å–∫–∏–¥–∫–æ–π</h3>
            <p>–°–∫–∏–¥–∫–∞ 10% –µ—Å–ª–∏ credits >= 4, –∏–Ω–∞—á–µ –±–µ–∑ —Å–∫–∏–¥–∫–∏. –ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞: 1000 –∑–∞ credit</p>

            <h4>–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</h4>
            <table>
                <tr>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞</th>
                    <th>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–µ—Å)</th>
                    <th>–°—Ç–æ–∏–º–æ—Å—Ç—å (—Ä—É–±)</th>
                    <th>–°–∫–∏–¥–∫–∞ 10% (—Ä—É–±)</th>
                </tr>
                <tr>
                    <td>–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞</td>
                    <td>4</td>
                    <td>4000</td>
                    <td>3600.0</td>
                </tr>
                <tr>
                    <td>–§–∏–∑–∏–∫–∞</td>
                    <td>3</td>
                    <td>3000</td>
                    <td>3000</td>
                </tr>
                <tr>
                    <td>–ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ</td>
                    <td>5</td>
                    <td>5000</td>
                    <td>4500.0</td>
                </tr>
                <tr>
                    <td>–ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</td>
                    <td>4</td>
                    <td>4000</td>
                    <td>3600.0</td>
                </tr>
                <tr>
                    <td>–ê–ª–≥–æ—Ä–∏—Ç–º—ã –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö</td>
                    <td>4</td>
                    <td>4000</td>
                    <td>3600.0</td>
                </tr>
                <tr>
                    <td>–í–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞</td>
                    <td>3</td>
                    <td>3000</td>
                    <td>3000</td>
                </tr>
            </table>

            <div class="code-block"><span class="keyword">CREATE OR REPLACE FUNCTION</span> <span class="function">calculate_course_discount</span>(p_course_id <span class="class">INT</span>)
<span class="keyword">RETURNS</span> <span class="class">NUMERIC</span>
<span class="keyword">LANGUAGE</span> sql
<span class="keyword">STABLE</span>
<span class="keyword">AS</span> $$
   <span class="comment">...</span>
$$;

<span class="comment">-- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:</span>
<span class="keyword">SELECT</span> 
    title, 
    credits,
    credits <span class="operator">*</span> <span class="number">1000</span> <span class="keyword">as</span> original_price,
    <span class="function">calculate_course_discount</span>(id) <span class="keyword">as</span> discounted_price
<span class="keyword">FROM</span> courses;</div>

            <div class="form-group">
                <label>–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ:</label>
                <textarea class="code-textarea"></textarea>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" id="task5-4">
                <label for="task5-4">–ó–∞–¥–∞–Ω–∏–µ 5.4 –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</label>
            </div>

            <h3>5.5* –°–æ–∑–¥–∞–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é get_course_students, –∫–æ—Ç–æ—Ä–∞—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –∫—É—Ä—Å–∞</h3>

            <h4>–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</h4>
            <table>
                <tr>
                    <th>id</th>
                    <th>–ò–º—è</th>
                    <th>Email</th>
                    <th>–û—Ü–µ–Ω–∫–∞</th>
                </tr>
                <tr>
                    <td>1</td>
                    <td>–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤</td>
                    <td>ivan.ivanov@example.com</td>
                    <td>5</td>
                </tr>
                <tr>
                    <td>5</td>
                    <td>–î–º–∏—Ç—Ä–∏–π –í–æ–ª–∫–æ–≤</td>
                    <td>dmitry.volkov@example.com</td>
                    <td>5</td>
                </tr>
                <tr>
                    <td>2</td>
                    <td>–ú–∞—Ä–∏—è –ü–µ—Ç—Ä–æ–≤–∞</td>
                    <td>maria.petrova@example.com</td>
                    <td>4.5</td>
                </tr>
                <tr>
                    <td>7</td>
                    <td>–°–µ—Ä–≥–µ–π –õ–µ–±–µ–¥–µ–≤</td>
                    <td>sergey.lebedev@example.com</td>
                    <td>4</td>
                </tr>
                <tr>
                    <td>8</td>
                    <td>–û–ª—å–≥–∞ –ù–æ–≤–∏–∫–æ–≤–∞</td>
                    <td>olga.novikova@example.com</td>
                    <td>3.5</td>
                </tr>
                <tr>
                    <td>4</td>
                    <td>–ï–ª–µ–Ω–∞ –ö–æ–∑–ª–æ–≤–∞</td>
                    <td>elena.kozlova@example.com</td>
                    <td>3</td>
                </tr>
            </table>

            <div class="code-block"><span class="keyword">CREATE OR REPLACE FUNCTION</span> <span class="function">get_course_students</span>(p_course_id <span class="class">INT</span>)
<span class="keyword">RETURNS TABLE</span>(
    student_id <span class="class">INT</span>,
    student_name <span class="class">VARCHAR</span>,
    student_email <span class="class">VARCHAR</span>,
    grade <span class="class">REAL</span>
)
<span class="keyword">LANGUAGE</span> sql
<span class="keyword">AS</span> $$
  <span class="comment">...</span>
$$;

<span class="comment">-- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:</span>
<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="function">get_course_students</span>(<span class="number">1</span>);</div>

            <div class="form-group">
                <label>–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ:</label>
                <textarea class="code-textarea"></textarea>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" id="task5-5">
                <label for="task5-5">–ó–∞–¥–∞–Ω–∏–µ 5.5 –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</label>
            </div>
        </div>

        <div class="section">
            <h2>üìã –†–∞–±–æ—Ç–∞ —Å —Ö—Ä–∞–Ω–∏–º—ã–º–∏ –≤ –ë–î –æ–±—ä–µ–∫—Ç–∞–º–∏ —á–µ—Ä–µ–∑ FastAPI</h2>
            
            <h3>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞</h3>
            <div class="code-block">lab-postgres/
‚îú‚îÄ‚îÄ main.py              <span class="comment"># FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</span>
‚îú‚îÄ‚îÄ database.py          <span class="comment"># –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î</span>
‚îú‚îÄ‚îÄ models.py            <span class="comment"># SQLAlchemy –º–æ–¥–µ–ª–∏</span>
‚îú‚îÄ‚îÄ schemas.py           <span class="comment"># Pydantic —Å—Ö–µ–º—ã</span>
‚îú‚îÄ‚îÄ init_db.sql          <span class="comment"># SQL –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏</span>
‚îî‚îÄ‚îÄ requirements.txt     <span class="comment"># –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏</span></div>

            <h3>–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π</h3>
            <div class="code-block">pip install fastapi uvicorn sqlalchemy psycopg2-binary</div>
        </div>

        <div class="section">
            <h2>üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞</h2>
            
            <h3>database.py</h3>
            <div class="code-block"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine, text
<span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker, DeclarativeBase

<span class="class">DATABASE_URL</span> <span class="operator">=</span> <span class="string">"postgresql://user:password@localhost/lab_db"</span>

engine <span class="operator">=</span> <span class="function">create_engine</span>(<span class="class">DATABASE_URL</span>)
<span class="class">SessionLocal</span> <span class="operator">=</span> <span class="function">sessionmaker</span>(autocommit<span class="operator">=</span><span class="keyword">False</span>, autoflush<span class="operator">=</span><span class="keyword">False</span>, bind<span class="operator">=</span>engine)

<span class="keyword">class</span> <span class="class">Base</span>(<span class="class">DeclarativeBase</span>):
    <span class="keyword">pass</span>

<span class="keyword">def</span> <span class="function">get_db</span>():
    db <span class="operator">=</span> <span class="function">SessionLocal</span>()
    <span class="keyword">try</span>:
        <span class="keyword">yield</span> db
    <span class="keyword">finally</span>:
        db.<span class="function">close</span>()</div>

            <h3>models.py</h3>
            <div class="code-block"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> String, Float, DateTime, ForeignKey
<span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> Mapped, mapped_column, relationship
<span class="keyword">from</span> database <span class="keyword">import</span> Base
<span class="keyword">from</span> datetime <span class="keyword">import</span> datetime

<span class="keyword">class</span> <span class="class">Student</span>(<span class="class">Base</span>):
    __tablename__ <span class="operator">=</span> <span class="string">"students"</span>
    
    id: <span class="class">Mapped</span>[<span class="class">int</span>] <span class="operator">=</span> <span class="function">mapped_column</span>(primary_key<span class="operator">=</span><span class="keyword">True</span>, index<span class="operator">=</span><span class="keyword">True</span>)
    name: <span class="class">Mapped</span>[<span class="class">str</span>] <span class="operator">=</span> <span class="function">mapped_column</span>(<span class="class">String</span>(<span class="number">100</span>))
    email: <span class="class">Mapped</span>[<span class="class">str</span>] <span class="operator">=</span> <span class="function">mapped_column</span>(<span class="class">String</span>(<span class="number">100</span>), unique<span class="operator">=</span><span class="keyword">True</span>)
    status: <span class="class">Mapped</span>[<span class="class">str</span>] <span class="operator">=</span> <span class="function">mapped_column</span>(<span class="class">String</span>(<span class="number">20</span>), default<span class="operator">=</span><span class="string">'active'</span>)
    created_at: <span class="class">Mapped</span>[datetime] <span class="operator">=</span> <span class="function">mapped_column</span>(<span class="class">DateTime</span>, default<span class="operator">=</span>datetime.utcnow)
    
    grades: <span class="class">Mapped</span>[<span class="class">list</span>[<span class="string">"Grade"</span>]] <span class="operator">=</span> <span class="function">relationship</span>(back_populates<span class="operator">=</span><span class="string">"student"</span>)

<span class="keyword">class</span> <span class="class">Course</span>(<span class="class">Base</span>):
    __tablename__ <span class="operator">=</span> <span class="string">"courses"</span>
    
    id: <span class="class">Mapped</span>[<span class="class">int</span>] <span class="operator">=</span> <span class="function">mapped_column</span>(primary_key<span class="operator">=</span><span class="keyword">True</span>, index<span class="operator">=</span><span class="keyword">True</span>)
    title: <span class="class">Mapped</span>[<span class="class">str</span>] <span class="operator">=</span> <span class="function">mapped_column</span>(<span class="class">String</span>(<span class="number">200</span>))
    credits: <span class="class">Mapped</span>[<span class="class">int</span>] <span class="operator">=</span> <span class="function">mapped_column</span>(default<span class="operator">=</span><span class="number">3</span>)
    
    grades: <span class="class">Mapped</span>[<span class="class">list</span>[<span class="string">"Grade"</span>]] <span class="operator">=</span> <span class="function">relationship</span>(back_populates<span class="operator">=</span><span class="string">"course"</span>)

<span class="keyword">class</span> <span class="class">Grade</span>(<span class="class">Base</span>):
    __tablename__ <span class="operator">=</span> <span class="string">"grades"</span>
    
    id: <span class="class">Mapped</span>[<span class="class">int</span>] <span class="operator">=</span> <span class="function">mapped_column</span>(primary_key<span class="operator">=</span><span class="keyword">True</span>, index<span class="operator">=</span><span class="keyword">True</span>)
    student_id: <span class="class">Mapped</span>[<span class="class">int</span>] <span class="operator">=</span> <span class="function">mapped_column</span>(<span class="function">ForeignKey</span>(<span class="string">"students.id"</span>))
    course_id: <span class="class">Mapped</span>[<span class="class">int</span>] <span class="operator">=</span> <span class="function">mapped_column</span>(<span class="function">ForeignKey</span>(<span class="string">"courses.id"</span>))
    grade: <span class="class">Mapped</span>[<span class="class">float</span>] <span class="operator">=</span> <span class="function">mapped_column</span>(<span class="class">Float</span>)
    
    student: <span class="class">Mapped</span>[<span class="string">"Student"</span>] <span class="operator">=</span> <span class="function">relationship</span>(back_populates<span class="operator">=</span><span class="string">"grades"</span>)
    course: <span class="class">Mapped</span>[<span class="string">"Course"</span>] <span class="operator">=</span> <span class="function">relationship</span>(back_populates<span class="operator">=</span><span class="string">"grades"</span>)</div>

            <h3>schemas.py</h3>
            <div class="code-block"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, ConfigDict
<span class="keyword">from</span> datetime <span class="keyword">import</span> datetime

<span class="keyword">class</span> <span class="class">StudentBase</span>(<span class="class">BaseModel</span>):
    name: <span class="class">str</span>
    email: <span class="class">str</span>
    status: <span class="class">str</span> <span class="operator">=</span> <span class="string">'active'</span>

<span class="keyword">class</span> <span class="class">StudentResponse</span>(<span class="class">StudentBase</span>):
    id: <span class="class">int</span>
    created_at: datetime
    
    model_config <span class="operator">=</span> <span class="function">ConfigDict</span>(from_attributes<span class="operator">=</span><span class="keyword">True</span>)

<span class="keyword">class</span> <span class="class">GradeResponse</span>(<span class="class">BaseModel</span>):
    student_id: <span class="class">int</span>
    course_id: <span class="class">int</span>
    grade: <span class="class">float</span>
    
    model_config <span class="operator">=</span> <span class="function">ConfigDict</span>(from_attributes<span class="operator">=</span><span class="keyword">True</span>)

<span class="keyword">class</span> <span class="class">SQLQuery</span>(<span class="class">BaseModel</span>):
    query: <span class="class">str</span></div>

            <h3>main.py</h3>
            <div class="code-block"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Depends, UploadFile, File
<span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> Session
<span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> text, MetaData, Table, select
<span class="keyword">from</span> database <span class="keyword">import</span> get_db, engine
<span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel
<span class="keyword">from</span> schemas <span class="keyword">import</span> SQLQuery

app <span class="operator">=</span> <span class="function">FastAPI</span>()

<span class="decorator">@app.get</span>(<span class="string">"/"</span>)
<span class="keyword">def</span> <span class="function">root</span>():
    <span class="keyword">return</span> {<span class="string">"message"</span>: <span class="string">"Lab PostgreSQL API is running"</span>}

<span class="keyword">def</span> <span class="function">get_active_students_table</span>():
    metadata <span class="operator">=</span> <span class="function">MetaData</span>()
    <span class="keyword">return</span> <span class="function">Table</span>(<span class="string">'active_students_view'</span>, metadata, autoload_with<span class="operator">=</span>engine)


<span class="decorator">@app.post</span>(<span class="string">"/sql/file"</span>, summary<span class="operator">=</span><span class="string">"Execute SQL from file"</span>, description<span class="operator">=</span><span class="string">"Upload and execute SQL file"</span>)
<span class="keyword">async def</span> <span class="function">execute_sql_file</span>(file: <span class="class">UploadFile</span> <span class="operator">=</span> <span class="function">File</span>(...), db: <span class="class">Session</span> <span class="operator">=</span> <span class="function">Depends</span>(get_db)):
    <span class="keyword">try</span>:
        content <span class="operator">=</span> <span class="keyword">await</span> file.<span class="function">read</span>()
        sql_query <span class="operator">=</span> content.<span class="function">decode</span>(<span class="string">'utf-8'</span>)
        
        <span class="comment"># –í—ã–ø–æ–ª–Ω—è–µ–º –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∏–∑ —Ñ–∞–π–ª–∞</span>
        result <span class="operator">=</span> db.<span class="function">execute</span>(<span class="function">text</span>(sql_query))
        db.<span class="function">commit</span>()       
       
        <span class="keyword">return</span> {<span class="string">"status"</span>: <span class="string">"success"</span>, <span class="string">"message"</span>: <span class="string">"SQL file executed successfully"</span>}
    <span class="keyword">except</span> <span class="class">Exception</span> <span class="keyword">as</span> e:
        db.<span class="function">rollback</span>()
        <span class="keyword">return</span> {<span class="string">"status"</span>: <span class="string">"error"</span>, <span class="string">"message"</span>: <span class="function">str</span>(e)}</div>
        </div>

        <div class="section">
            <h2>–ü—Ä–∏–º–µ—Ä –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</h2>
            
            <h3>–ß–µ—Ä–µ–∑ raw SQL</h3>
            <div class="code-block"><span class="comment"># main.py</span>

<span class="decorator">@app.get</span>(<span class="string">"/students/active/raw"</span>)
<span class="keyword">def</span> <span class="function">get_active_students_raw</span>(db: <span class="class">Session</span> <span class="operator">=</span> <span class="function">Depends</span>(get_db)):
    <span class="string">"""–ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ raw SQL"""</span>
    result <span class="operator">=</span> db.<span class="function">execute</span>(<span class="function">text</span>(<span class="string">"SELECT * FROM active_students_view"</span>))
    students <span class="operator">=</span> [<span class="function">dict</span>(row._mapping) <span class="keyword">for</span> row <span class="keyword">in</span> result]
    <span class="keyword">return</span> {<span class="string">"method"</span>: <span class="string">"raw_sql"</span>, <span class="string">"count"</span>: <span class="function">len</span>(students), <span class="string">"data"</span>: students}</div>

            <h3>–ß–µ—Ä–µ–∑ SQLAlchemy</h3>
            <div class="code-block"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Table, MetaData, select
<span class="keyword">from</span> database <span class="keyword">import</span> engine

<span class="comment"># –û—Ç—Ä–∞–∂–∞–µ–º view –∫–∞–∫ —Ç–∞–±–ª–∏—Ü—É</span>
metadata <span class="operator">=</span> <span class="function">MetaData</span>()
active_students_table <span class="operator">=</span> <span class="function">Table</span>(<span class="string">'active_students_view'</span>, metadata, autoload_with<span class="operator">=</span>engine)

<span class="decorator">@app.get</span>(<span class="string">"/students/active/sqlalchemy"</span>)
<span class="keyword">def</span> <span class="function">get_active_students_sqlalchemy</span>(db: <span class="class">Session</span> <span class="operator">=</span> <span class="function">Depends</span>(get_db)):
    <span class="string">"""–ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ SQLAlchemy"""</span>
    stmt <span class="operator">=</span> <span class="function">select</span>(active_students_table)
    result <span class="operator">=</span> db.<span class="function">execute</span>(stmt)
    students <span class="operator">=</span> [<span class="function">dict</span>(row._mapping) <span class="keyword">for</span> row <span class="keyword">in</span> result]
    <span class="keyword">return</span> {<span class="string">"method"</span>: <span class="string">"sqlalchemy"</span>, <span class="string">"count"</span>: <span class="function">len</span>(students), <span class="string">"data"</span>: students}</div>
        </div>

        <div class="section">
            <h2>–°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞</h2>
            <p>–°–¥–µ–ª–∞—Ç—å —Ä–µ—à–µ–Ω–∏—è —á–µ—Ä–µ–∑ raw sql –∏ sqlalchemy</p>
            
            <h3>–≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è top_students_view</h3>
            <div class="code-block"><span class="comment"># —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è top_students_view</span>
<span class="decorator">@app.get</span>(<span class="string">"/students/top/raw"</span>)


top_students_table <span class="operator">=</span> <span class="function">Table</span>(<span class="string">'top_students_view'</span>, metadata, autoload_with<span class="operator">=</span>engine)

<span class="decorator">@app.get</span>(<span class="string">"/students/top/sqlalchemy"</span>)</div>

            <div class="form-group">
                <label>–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ:</label>
                <textarea class="code-textarea"></textarea>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" id="task-top-students">
                <label for="task-top-students">–≠–Ω–¥–ø–æ–∏–Ω—Ç top_students –≤—ã–ø–æ–ª–Ω–µ–Ω</label>
            </div>

            <h3>–≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è course_statistics_mv</h3>
            <div class="code-block"><span class="comment"># —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è course_statistics_mv</span>
<span class="decorator">@app.get</span>(<span class="string">"/courses/statistics/raw"</span>)


course_stats_table <span class="operator">=</span> <span class="function">Table</span>(<span class="string">'course_statistics_mv'</span>, metadata, autoload_with<span class="operator">=</span>engine)

<span class="decorator">@app.get</span>(<span class="string">"/courses/statistics/sqlalchemy"</span>)</div>

            <div class="form-group">
                <label>–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ:</label>
                <textarea class="code-textarea"></textarea>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" id="task-course-stats">
                <label for="task-course-stats">–≠–Ω–¥–ø–æ–∏–Ω—Ç course_statistics –≤—ã–ø–æ–ª–Ω–µ–Ω</label>
            </div>

            <h3>–≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è add_student</h3>
            <div class="code-block"><span class="comment"># —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è add_student</span>
<span class="decorator">@app.post</span>(<span class="string">"/students/add/raw"</span>)</div>

            <div class="form-group">
                <label>–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ:</label>
                <textarea class="code-textarea"></textarea>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" id="task-add-student">
                <label for="task-add-student">–≠–Ω–¥–ø–æ–∏–Ω—Ç add_student –≤—ã–ø–æ–ª–Ω–µ–Ω</label>
            </div>

            <h3>–≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è delete_inactive_students</h3>
            <div class="code-block"><span class="comment"># —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è delete_inactive_students</span>
<span class="decorator">@app.delete</span>(<span class="string">"/students/inactive/raw"</span>)</div>

            <div class="form-group">
                <label>–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ:</label>
                <textarea class="code-textarea"></textarea>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" id="task-delete-inactive">
                <label for="task-delete-inactive">–≠–Ω–¥–ø–æ–∏–Ω—Ç delete_inactive_students –≤—ã–ø–æ–ª–Ω–µ–Ω</label>
            </div>

            <h3>–≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è get_student_avg_grade</h3>
            <div class="code-block"><span class="comment"># —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è get_student_avg_grade</span>
<span class="decorator">@app.get</span>(<span class="string">"/students/{student_id}/avg-grade/raw"</span>)</div>

            <div class="form-group">
                <label>–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ:</label>
                <textarea class="code-textarea"></textarea>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" id="task-avg-grade">
                <label for="task-avg-grade">–≠–Ω–¥–ø–æ–∏–Ω—Ç get_student_avg_grade –≤—ã–ø–æ–ª–Ω–µ–Ω</label>
            </div>

            <h3>–≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è count_student_courses</h3>
            <div class="code-block"><span class="comment"># —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è count_student_courses</span>
<span class="decorator">@app.get</span>(<span class="string">"/students/{student_id}/courses-count/raw"</span>)</div>

            <div class="form-group">
                <label>–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ:</label>
                <textarea class="code-textarea"></textarea>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" id="task-count-courses">
                <label for="task-count-courses">–≠–Ω–¥–ø–æ–∏–Ω—Ç count_student_courses –≤—ã–ø–æ–ª–Ω–µ–Ω</label>
            </div>

            <h3>–≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è get_grade_status</h3>
            <div class="code-block"><span class="comment"># —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è get_grade_status</span>
<span class="decorator">@app.get</span>(<span class="string">"/grades/status/raw"</span>)</div>

            <div class="form-group">
                <label>–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ:</label>
                <textarea class="code-textarea"></textarea>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" id="task-grade-status">
                <label for="task-grade-status">–≠–Ω–¥–ø–æ–∏–Ω—Ç get_grade_status –≤—ã–ø–æ–ª–Ω–µ–Ω</label>
            </div>

            <h3>–≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è calculate_course_discount</h3>
            <div class="code-block"><span class="comment"># —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è calculate_course_discount</span>
<span class="decorator">@app.get</span>(<span class="string">"/courses/{course_id}/discount/raw"</span>)</div>

            <div class="form-group">
                <label>–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ:</label>
                <textarea class="code-textarea"></textarea>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" id="task-discount">
                <label for="task-discount">–≠–Ω–¥–ø–æ–∏–Ω—Ç calculate_course_discount –≤—ã–ø–æ–ª–Ω–µ–Ω</label>
            </div>

            <h3>–≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è get_course_students</h3>
            <div class="code-block"><span class="comment"># —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è get_course_students</span>
<span class="decorator">@app.get</span>(<span class="string">"/courses/{course_id}/students/raw"</span>)</div>

            <div class="form-group">
                <label>–í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ:</label>
                <textarea class="code-textarea"></textarea>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" id="task-course-students">
                <label for="task-course-students">–≠–Ω–¥–ø–æ–∏–Ω—Ç get_course_students –≤—ã–ø–æ–ª–Ω–µ–Ω</label>
            </div>
        </div>

        <div class="section">
            <h2>üìä –í—ã–≤–æ–¥—ã –ø–æ –∑–∞–Ω—è—Ç–∏—é</h2>

            <div class="form-group">
                <label>–ù–∞ –¥–∞–Ω–Ω–æ–º –∑–∞–Ω—è—Ç–∏–∏ –º—ã –∏–∑—É—á–∏–ª–∏:</label>
                <textarea rows="3">–ü–µ—Ä–µ—á–∏—Å–ª–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–º—ã...</textarea>
            </div>

            <div class="form-group">
                <label>–ß—Ç–æ –Ω–æ–≤–æ–≥–æ —É–∑–Ω–∞–ª(–∞):</label>
                <textarea rows="3">–û–ø–∏—à–∏—Ç–µ –Ω–æ–≤—ã–µ –∑–Ω–∞–Ω–∏—è...</textarea>
            </div>

            <div class="form-group">
                <label>–ß—Ç–æ –±—ã–ª–æ —Ç—Ä—É–¥–Ω–æ –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è:</label>
                <textarea rows="3">–û–ø–∏—à–∏—Ç–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏...</textarea>
            </div>
        </div>

        <button class="save-btn" onclick="saveToPDF()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ PDF</button>
    </div>

    <script>
        function loadFromStorage() {
            document.getElementById('student-name').value = localStorage.getItem('student-name') || '';
            document.getElementById('group').value = localStorage.getItem('group') || '';
            document.getElementById('date').value = localStorage.getItem('date') || new Date().toISOString().split('T')[0];
            
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                if (localStorage.getItem(checkbox.id) === 'true') checkbox.checked = true;
            });
            
            document.querySelectorAll('textarea').forEach((textarea, index) => {
                const saved = localStorage.getItem('textarea-' + index);
                if (saved) textarea.value = saved;
            });
        }
        
        function saveToStorage() {
            localStorage.setItem('student-name', document.getElementById('student-name').value);
            localStorage.setItem('group', document.getElementById('group').value);
            localStorage.setItem('date', document.getElementById('date').value);
            
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                localStorage.setItem(checkbox.id, checkbox.checked);
            });
            
            document.querySelectorAll('textarea').forEach((textarea, index) => {
                localStorage.setItem('textarea-' + index, textarea.value);
            });
        }
        
        loadFromStorage();

        document.getElementById('student-name').addEventListener('input', saveToStorage);
        document.getElementById('group').addEventListener('input', saveToStorage);
        document.getElementById('date').addEventListener('change', saveToStorage);
        
        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', saveToStorage);
        });

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        function highlightPython(code) {
            let result = code
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            
            result = result.replace(/(#.*$)/gm, '###COMMENT###$1###/COMMENT###');
            result = result.replace(/(['"`])((?:\\.|(?!\1)[^\\\r\n])*?)\1/g, '###STRING###$&###/STRING###');
            result = result.replace(/\b(from|import|def|class|return|if|else|elif|for|while|try|except|finally|with|as|and|or|not|in|is|True|False|None|async|await|raise|pass)\b/g, '###KEYWORD###$1###/KEYWORD###');
            result = result.replace(/\b(\d+)\b/g, '###NUMBER###$1###/NUMBER###');
            result = result.replace(/\b(Session|Contributor|Repository|Contribution|Mapped|select|func|text|ForeignKey|JSON|date|engine|Base|DeclarativeBase|create_engine|mapped_column|int|str|dict|list)\b/g, '###CLASS###$1###/CLASS###');
            result = result.replace(/\b([a-zA-Z_][a-zA-Z0-9_]*)(?=\s*\()/g, '###FUNCTION###$1###/FUNCTION###');
            
            result = result.replace(/###COMMENT###/g, '<span class="comment">');
            result = result.replace(/###\/COMMENT###/g, '</span>');
            result = result.replace(/###STRING###/g, '<span class="string">');
            result = result.replace(/###\/STRING###/g, '</span>');
            result = result.replace(/###KEYWORD###/g, '<span class="keyword">');
            result = result.replace(/###\/KEYWORD###/g, '</span>');
            result = result.replace(/###CLASS###/g, '<span class="class">');
            result = result.replace(/###\/CLASS###/g, '</span>');
            result = result.replace(/###FUNCTION###/g, '<span class="function">');
            result = result.replace(/###\/FUNCTION###/g, '</span>');
            result = result.replace(/###NUMBER###/g, '<span class="number">');
            result = result.replace(/###\/NUMBER###/g, '</span>');
            
            return result;
        }

        function highlightSQL(code) {
            let result = code
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            
            result = result.replace(/(--.*$)/gm, '###COMMENT###$1###/COMMENT###');
            result = result.replace(/(['"`])((?:\\.|(?!\1)[^\\\r\n])*?)\1/g, '###STRING###$&###/STRING###');
            result = result.replace(/\b(SELECT|FROM|WHERE|JOIN|LEFT|RIGHT|INNER|OUTER|ON|GROUP BY|ORDER BY|LIMIT|INSERT|UPDATE|DELETE|CREATE|ALTER|DROP|TABLE|VIEW|MATERIALIZED|PROCEDURE|FUNCTION|RETURNS|LANGUAGE|AS|CALL|CASE|WHEN|THEN|ELSE|END|AND|OR|NOT|IN|IS|NULL|DEFAULT|PRIMARY KEY|FOREIGN KEY|REFERENCES)\b/gi, '###KEYWORD###$&###/KEYWORD###');
            result = result.replace(/\b(\d+\.?\d*)\b/g, '###NUMBER###$1###/NUMBER###');
            result = result.replace(/\b(INT|VARCHAR|TEXT|REAL|NUMERIC|BIGINT|FLOAT|DATETIME|DATE|BOOLEAN)\b/gi, '###CLASS###$&###/CLASS###');
            
            result = result.replace(/###COMMENT###/g, '<span class="comment">');
            result = result.replace(/###\/COMMENT###/g, '</span>');
            result = result.replace(/###STRING###/g, '<span class="string">');
            result = result.replace(/###\/STRING###/g, '</span>');
            result = result.replace(/###KEYWORD###/g, '<span class="keyword">');
            result = result.replace(/###\/KEYWORD###/g, '</span>');
            result = result.replace(/###CLASS###/g, '<span class="class">');
            result = result.replace(/###\/CLASS###/g, '</span>');
            result = result.replace(/###NUMBER###/g, '<span class="number">');
            result = result.replace(/###\/NUMBER###/g, '</span>');
            
            return result;
        }

        document.querySelectorAll('.code-textarea').forEach(textarea => {
            const wrapper = document.createElement('div');
            wrapper.style.position = 'relative';
            textarea.parentNode.insertBefore(wrapper, textarea);
            wrapper.appendChild(textarea);

            const preview = document.createElement('div');
            preview.className = 'code-block';
            preview.style.display = 'none';
            preview.style.cursor = 'pointer';
            wrapper.appendChild(preview);

            textarea.addEventListener('input', function() {
                autoResize(this);
                saveToStorage();
            });

            textarea.addEventListener('blur', () => {
                saveToStorage();
                setTimeout(() => {
                    if (textarea.value.trim()) {
                        const code = textarea.value;
                        if (code.includes('SELECT') || code.includes('CREATE') || code.includes('CALL')) {
                            preview.innerHTML = highlightSQL(code);
                        } else {
                            preview.innerHTML = highlightPython(code);
                        }
                        preview.style.display = 'block';
                        textarea.style.display = 'none';
                    }
                }, 200);
            });

            preview.addEventListener('click', () => {
                preview.style.display = 'none';
                textarea.style.display = 'block';
                textarea.focus();
            });
            
            if (textarea.value.trim()) {
                const code = textarea.value;
                if (code.includes('SELECT') || code.includes('CREATE') || code.includes('CALL')) {
                    preview.innerHTML = highlightSQL(code);
                } else {
                    preview.innerHTML = highlightPython(code);
                }
                preview.style.display = 'block';
                textarea.style.display = 'none';
            }

            autoResize(textarea);
        });

        document.querySelectorAll('textarea:not(.code-textarea)').forEach(textarea => {
            textarea.addEventListener('input', function() {
                autoResize(this);
                saveToStorage();
            });
            autoResize(textarea);
        });

        function saveToPDF() {
            const studentName = document.getElementById('student-name').value || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
            const group = document.getElementById('group').value || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
            const date = document.getElementById('date').value || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
            
            const originalTitle = document.title;
            document.title = `PostgreSQL_Lab_${studentName}_${group}_${date}`;
            
            window.print();
            
            setTimeout(() => {
                document.title = originalTitle;
            }, 1000);
        }
    </script>
</body>
</html>
