# –ë—Ä–æ–∫–µ—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π: Redis, RabbitMQ, Kafka
## Python + FastAPI

---

## –°–ª–∞–π–¥ 1: –í–≤–µ–¥–µ–Ω–∏–µ

### –ß—Ç–æ —Ç–∞–∫–æ–µ –±—Ä–æ–∫–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π?

**–ë—Ä–æ–∫–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π** ‚Äî –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ –ü–û –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –æ–±–º–µ–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –º–µ–∂–¥—É —Å–µ—Ä–≤–∏—Å–∞–º–∏

**–ó–∞—á–µ–º –Ω—É–∂–Ω—ã:**
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–∞—á
- –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
- –û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å
- –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

## –°–ª–∞–π–¥ 2: –ú–Ω–æ–≥–æ–æ–±—Ä–∞–∑–∏–µ –±—Ä–æ–∫–µ—Ä–æ–≤

![img\brockers-vs.gif](./img/brockers-vs.gif)
---

## –°–ª–∞–π–¥ 3: –°—Ñ–µ—Ä—ã –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –±—Ä–æ–∫–µ—Ä–æ–≤

| –°—Ñ–µ—Ä–∞ | –ó–∞–¥–∞—á–∏ | –ü—Ä–∏–º–µ—Ä—ã (–†–§) |
|-------|--------|--------|
| **E-commerce** | –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫–∞–∑–æ–≤<br>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –¥–æ—Å—Ç–∞–≤–∫–µ<br>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤ | Ozon, Wildberries, –Ø–Ω–¥–µ–∫—Å.–ú–∞—Ä–∫–µ—Ç |
| **–§–∏–Ω—Ç–µ—Ö** | –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π<br>Fraud detection<br>–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è | –°–±–µ—Ä–±–∞–Ω–∫, –¢–∏–Ω—å–∫–æ—Ñ—Ñ, –ê–ª—å—Ñ–∞-–ë–∞–Ω–∫ |
| **–°–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏** | –õ–µ–Ω—Ç–∞ –Ω–æ–≤–æ—Å—Ç–µ–π<br>Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è<br>–û–±—Ä–∞–±–æ—Ç–∫–∞ –º–µ–¥–∏–∞ | VK, –û–¥–Ω–æ–∫–ª–∞—Å—Å–Ω–∏–∫–∏, Telegram |
| **IoT** | –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö —Å –¥–∞—Ç—á–∏–∫–æ–≤<br>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —É—Å—Ç—Ä–æ–π—Å—Ç–≤<br>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ | –Ø–Ω–¥–µ–∫—Å.–î–æ–º, –†–æ—Å—Ç–µ–ª–µ–∫–æ–º IoT |
| **–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã** | –ú–µ–∂—Å–µ—Ä–≤–∏—Å–Ω–∞—è –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è<br>Event-driven –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞<br>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ | –Ø–Ω–¥–µ–∫—Å, Avito, Mail.ru |

---

## –°–ª–∞–π–¥ 4: –ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Ö—Ä–∞–Ω–∏–ª–∏—â

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ –¥–∏—Å–∫–æ–≤—ã–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞

| –•—Ä–∞–Ω–∏–ª–∏—â–µ | –ó–∞–ø–∏—Å–µ–π/—Å–µ–∫ | –ó–∞–¥–µ—Ä–∂–∫–∞ | –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ |
|-----------|-------------|----------|-------------|
| **PostgreSQL** | 5,000-15,000 | 10-50ms | ACID, –∏–Ω–¥–µ–∫—Å—ã, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ |
| **MySQL** | 10,000-20,000 | 5-30ms | –ë—ã—Å—Ç—Ä–µ–µ –Ω–∞ –ø—Ä–æ—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö |
| **MS SQL** | 8,000-18,000 | 8-40ms | –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –ø–æ–¥ Windows |
| **MongoDB** | 20,000-50,000 | 2-10ms | NoSQL, –±–µ–∑ —Å—Ö–µ–º—ã |
| **JSON —Ñ–∞–π–ª—ã** | 50,000-100,000 | 1-5ms | –ë–µ–∑ –≥–∞—Ä–∞–Ω—Ç–∏–π, —Ä–∏—Å–∫ –ø–æ—Ç–µ—Ä–∏ |

**–ü—Ä–æ–±–ª–µ–º–∞:** –í—Å–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã —Å–∫–æ—Ä–æ—Å—Ç—å—é –¥–∏—Å–∫–∞

**–†–µ—à–µ–Ω–∏–µ:** –ë—Ä–æ–∫–µ—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π (in-memory) - **100,000-1,000,000+ –∑–∞–ø–∏—Å–µ–π/—Å–µ–∫**

---
## —Å–ª–∞–π–¥ 5

![](./img/vs_brockers_2.gif)




## –°–ª–∞–π–¥ 6: –ü—Ä–æ–±–ª–µ–º—ã –±–µ–∑ –±—Ä–æ–∫–µ—Ä–æ–≤

```python
# –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ - –ø–ª–æ—Ö–æ
@app.post("/order")
def create_order(order: Order):
    save_to_db(order)           # 100ms
    send_email(order)           # 2000ms
    update_inventory(order)     # 500ms
    notify_warehouse(order)     # 300ms
    return {"status": "ok"}     # –ö–ª–∏–µ–Ω—Ç –∂–¥–µ—Ç 2900ms!
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- –î–æ–ª–≥–∏–π –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ—Ç–æ–∫–∞
- –°–ª–æ–∂–Ω–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å

---

## –°–ª–∞–π–¥ 7: –†–µ—à–µ–Ω–∏–µ —Å –±—Ä–æ–∫–µ—Ä–æ–º

```python
# –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ - —Ö–æ—Ä–æ—à–æ
@app.post("/order")
async def create_order(order: Order):
    save_to_db(order)                    # 100ms
    await queue.send("email", order)     # 5ms
    await queue.send("inventory", order) # 5ms
    await queue.send("warehouse", order) # 5ms
    return {"status": "ok"}              # –ö–ª–∏–µ–Ω—Ç –∂–¥–µ—Ç 115ms!
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ë—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç
- –ù–µ–∑–∞–≤–∏—Å–∏–º–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
- –õ–µ–≥–∫–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å

---

## –°–ª–∞–π–¥ 8: –û—Å–Ω–æ–≤–Ω—ã–µ –±—Ä–æ–∫–µ—Ä—ã

| –ë—Ä–æ–∫–µ—Ä | –¢–∏–ø | –°–∫–æ—Ä–æ—Å—Ç—å | –°–ª–æ–∂–Ω–æ—Å—Ç—å | Use Case |
|--------|-----|----------|-----------|----------|
| **Redis** | In-memory | –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è | –ù–∏–∑–∫–∞—è | –ö—ç—à, –æ—á–µ—Ä–µ–¥–∏, pub/sub |
| **RabbitMQ** | Message Queue | –°—Ä–µ–¥–Ω—è—è | –°—Ä–µ–¥–Ω—è—è | –ó–∞–¥–∞—á–∏, –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è |
| **Kafka** | Event Stream | –í—ã—Å–æ–∫–∞—è | –í—ã—Å–æ–∫–∞—è | –õ–æ–≥–∏, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞, —Å–æ–±—ã—Ç–∏—è |

---

## –°–ª–∞–π–¥ 9: Redis - –û–±–∑–æ—Ä

**Redis** (Remote Dictionary Server) - in-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –•—Ä–∞–Ω–µ–Ω–∏–µ –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä –¥–∞–Ω–Ω—ã—Ö (—Å—Ç—Ä–æ–∫–∏, —Å–ø–∏—Å–∫–∏, –º–Ω–æ–∂–µ—Å—Ç–≤–∞, —Ö—ç—à–∏)
- Pub/Sub –º–æ–¥–µ–ª—å
- –ü—Ä–æ—Å—Ç—ã–µ –æ—á–µ—Ä–µ–¥–∏

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- –°—á–µ—Ç—á–∏–∫–∏, —Ä–µ–π—Ç–∏–Ω–≥–∏
- –ü—Ä–æ—Å—Ç—ã–µ –æ—á–µ—Ä–µ–¥–∏ –∑–∞–¥–∞—á
- Real-time –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

---

## –°–ª–∞–π–¥ 10: Redis - –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
# Docker
docker run -d -p 6379:6379 redis:latest

# Python –±–∏–±–ª–∏–æ—Ç–µ–∫–∞
pip install redis
```

```python
import redis

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
r = redis.Redis(host='localhost', port=6379, decode_responses=True)

# –ü—Ä–æ–≤–µ—Ä–∫–∞
r.ping()  # True
```

---

## –°–ª–∞–π–¥ 11: Redis - –ë–∞–∑–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

```python
import redis

r = redis.Redis(decode_responses=True)

# –°—Ç—Ä–æ–∫–∏
r.set('user:1:name', 'Alice')
r.get('user:1:name')  # 'Alice'

# –°—á–µ—Ç—á–∏–∫–∏
r.incr('page:views')  # 1
r.incr('page:views')  # 2

# –°–ø–∏—Å–∫–∏ (–æ—á–µ—Ä–µ–¥–∏)
r.lpush('tasks', 'task1')
r.lpush('tasks', 'task2')
r.rpop('tasks')  # 'task1'

# –•—ç—à–∏
r.hset('user:1', mapping={'name': 'Alice', 'age': 30})
r.hgetall('user:1')  # {'name': 'Alice', 'age': '30'}
```

---

## –°–ª–∞–π–¥ 12: Redis Pub/Sub

```python
import redis

r = redis.Redis()

# Publisher
def publish_message():
    r.publish('notifications', 'New order received!')

# Subscriber
def subscribe_messages():
    pubsub = r.pubsub()
    pubsub.subscribe('notifications')
    
    for message in pubsub.listen():
        if message['type'] == 'message':
            print(f"Received: {message['data']}")
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å:** –°–æ–æ–±—â–µ–Ω–∏—è –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è, –µ—Å–ª–∏ –Ω–µ—Ç –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤

---

## –°–ª–∞–π–¥ 13: Redis + FastAPI - –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

```python
from fastapi import FastAPI
import redis
import json

app = FastAPI()
r = redis.Redis(decode_responses=True)

@app.get("/products/{product_id}")
async def get_product(product_id: int):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
    cached = r.get(f"product:{product_id}")
    if cached:
        return json.loads(cached)
    
    # –ó–∞–ø—Ä–æ—Å –∫ –ë–î
    product = db.get_product(product_id)
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à –Ω–∞ 1 —á–∞—Å
    r.setex(f"product:{product_id}", 3600, json.dumps(product))
    
    return product
```

---

## –°–ª–∞–π–¥ 14: Redis + FastAPI - –û—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á

```python
from fastapi import FastAPI, BackgroundTasks
import redis

app = FastAPI()
r = redis.Redis()

@app.post("/send-email")
async def send_email(email: str, message: str):
    # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á—É –≤ –æ—á–µ—Ä–µ–¥—å
    task = {"email": email, "message": message}
    r.lpush("email_queue", json.dumps(task))
    return {"status": "queued"}

# Worker
def process_emails():
    while True:
        task = r.brpop("email_queue", timeout=5)
        if task:
            data = json.loads(task[1])
            send_email_smtp(data['email'], data['message'])
```

---

## –°–ª–∞–π–¥ 15: RabbitMQ - –û–±–∑–æ—Ä

**RabbitMQ** - –±—Ä–æ–∫–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ AMQP


![](./img/rabbitmq.webp)


## –°–ª–∞–π–¥ 16: RabbitMQ 
**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ì–∞—Ä–∞–Ω—Ç–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
- –ì–∏–±–∫–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è (exchanges, queues, bindings)
- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (acknowledgments)
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏–π

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –∑–∞–¥–∞—á–∏
- –°–ª–æ–∂–Ω–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è
- –ù—É–∂–Ω–∞ –≥–∞—Ä–∞–Ω—Ç–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏

---

## –°–ª–∞–π–¥ 17: RabbitMQ - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

Direct
Fanout 
Topic
```
Producer ‚Üí Exchange ‚Üí Queue ‚Üí Consumer
              ‚Üì
           Binding
```

## –°–ª–∞–π–¥ 18: 

![](./img/rabbit.gif)



**–¢–∏–ø—ã Exchange:**
- **Direct** - —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ routing key
- **Fanout** - –≤—Å–µ–º –æ—á–µ—Ä–µ–¥—è–º
- **Topic** - –ø–æ —à–∞–±–ª–æ–Ω—É (*.error, logs.*)
- **Headers** - –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º

---

## —Å–ª–∞–π–¥ 17

![](./img/rabbitmq.gif)


## –°–ª–∞–π–¥ 22: RabbitMQ - –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
# Docker
docker run -d -p 5672:5672 -p 15672:15672 rabbitmq:management

# Python –±–∏–±–ª–∏–æ—Ç–µ–∫–∞
pip install pika
```

```python
import pika

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
connection = pika.BlockingConnection(
    pika.ConnectionParameters('localhost')
)
channel = connection.channel()

# –°–æ–∑–¥–∞–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏
channel.queue_declare(queue='tasks', durable=True)
```

---

## –°–ª–∞–π–¥ 23: RabbitMQ - Producer

```python
import pika
import json

connection = pika.BlockingConnection(
    pika.ConnectionParameters('localhost')
)
channel = connection.channel()

# –û–±—ä—è–≤–ª—è–µ–º –æ—á–µ—Ä–µ–¥—å
channel.queue_declare(queue='tasks', durable=True)

# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
message = {"task": "send_email", "to": "user@example.com"}
channel.basic_publish(
    exchange='',
    routing_key='tasks',
    body=json.dumps(message),
    properties=pika.BasicProperties(
        delivery_mode=2,  # –°–æ—Ö—Ä–∞–Ω—è—Ç—å –Ω–∞ –¥–∏—Å–∫
    )
)

connection.close()
```

---

## –°–ª–∞–π–¥ 24: RabbitMQ - Consumer

```python
import pika
import json

connection = pika.BlockingConnection(
    pika.ConnectionParameters('localhost')
)
channel = connection.channel()
channel.queue_declare(queue='tasks', durable=True)

def callback(ch, method, properties, body):
    message = json.loads(body)
    print(f"Processing: {message}")
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–∞—á–∏
    process_task(message)
    
    # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
    ch.basic_ack(delivery_tag=method.delivery_tag)

channel.basic_qos(prefetch_count=1)
channel.basic_consume(queue='tasks', on_message_callback=callback)

print('Waiting for messages...')
channel.start_consuming()
```

---

## –°–ª–∞–π–¥ 25: RabbitMQ + FastAPI

```python
from fastapi import FastAPI
import pika
import json

app = FastAPI()

def get_channel():
    connection = pika.BlockingConnection(
        pika.ConnectionParameters('localhost')
    )
    return connection.channel()

@app.post("/tasks")
async def create_task(task_type: str, data: dict):
    channel = get_channel()
    channel.queue_declare(queue='tasks', durable=True)
    
    message = {"type": task_type, "data": data}
    channel.basic_publish(
        exchange='',
        routing_key='tasks',
        body=json.dumps(message),
        properties=pika.BasicProperties(delivery_mode=2)
    )
    
    return {"status": "queued", "task": message}
```

---

## –°–ª–∞–π–¥ 26: RabbitMQ - Topic Exchange

```python
# Producer
channel.exchange_declare(exchange='logs', exchange_type='topic')

# –û—Ç–ø—Ä–∞–≤–∫–∞ —Å routing key
channel.basic_publish(
    exchange='logs',
    routing_key='error.payment',
    body='Payment failed'
)

# Consumer 1 - –≤—Å–µ –æ—à–∏–±–∫–∏
channel.queue_bind(exchange='logs', queue='errors', routing_key='error.*')

# Consumer 2 - –≤—Å–µ –ª–æ–≥–∏ –ø–ª–∞—Ç–µ–∂–µ–π
channel.queue_bind(exchange='logs', queue='payments', routing_key='*.payment')
```

---

## –°–ª–∞–π–¥ 23: Kafka - –û–±–∑–æ—Ä

**Apache Kafka** - —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –ø–æ—Ç–æ–∫–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –í—ã—Å–æ–∫–∞—è –ø—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å (–º–∏–ª–ª–∏–æ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π/—Å–µ–∫)
- –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π (retention)
- –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
- –†–µ–ø–ª–∏–∫–∞—Ü–∏—è

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π
- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- Event Sourcing
- –ë–æ–ª—å—à–∏–µ –æ–±—ä–µ–º—ã –¥–∞–Ω–Ω—ã—Ö

---

## –°–ª–∞–π–¥ 24: Kafka - –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ

![](./img/kafka_cases.gif)

## –°–ª–∞–π–¥ 25: Kafka - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞


![](./img/kafka.gif)


```
Producer ‚Üí Topic (Partition 0, 1, 2) ‚Üí Consumer Group
                                          ‚Üì
                                    Consumer 1, 2, 3
```

**–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è:**
- **Topic** - –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
- **Partition** - —É–ø–æ—Ä—è–¥–æ—á–µ–Ω–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- **Offset** - –ø–æ–∑–∏—Ü–∏—è –≤ –ø–∞—Ä—Ç–∏—Ü–∏–∏
- **Consumer Group** - –≥—Ä—É–ø–ø–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π

---

## –°–ª–∞–π–¥ 30: Kafka - –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
# Docker Compose
version: '3'
services:
  zookeeper:
    image: confluentinc/cp-zookeeper:latest
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
  
  kafka:
    image: confluentinc/cp-kafka:latest
    ports:
      - "9092:9092"
    environment:
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092

# Python
pip install kafka-python
```

---

## –°–ª–∞–π–¥ 31: Kafka - Producer

```python
from kafka import KafkaProducer
import json

producer = KafkaProducer(
    bootstrap_servers=['localhost:9092'],
    value_serializer=lambda v: json.dumps(v).encode('utf-8')
)

# –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
event = {
    "user_id": 123,
    "action": "purchase",
    "amount": 99.99
}

future = producer.send('user-events', value=event)
result = future.get(timeout=10)

print(f"Sent to partition {result.partition}, offset {result.offset}")

producer.close()
```

---

## –°–ª–∞–π–¥ 32: Kafka - Consumer

```python
from kafka import KafkaConsumer
import json

consumer = KafkaConsumer(
    'user-events',
    bootstrap_servers=['localhost:9092'],
    auto_offset_reset='earliest',
    group_id='analytics-group',
    value_deserializer=lambda m: json.loads(m.decode('utf-8'))
)

for message in consumer:
    event = message.value
    print(f"Partition: {message.partition}, Offset: {message.offset}")
    print(f"Event: {event}")
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è
    process_event(event)
```

---

## –°–ª–∞–π–¥ 33: Kafka + FastAPI - Producer

```python
from fastapi import FastAPI
from kafka import KafkaProducer
import json

app = FastAPI()

producer = KafkaProducer(
    bootstrap_servers=['localhost:9092'],
    value_serializer=lambda v: json.dumps(v).encode('utf-8')
)

@app.post("/events")
async def send_event(event_type: str, data: dict):
    event = {
        "type": event_type,
        "data": data,
        "timestamp": datetime.now().isoformat()
    }
    
    future = producer.send('events', value=event)
    result = future.get(timeout=10)
    
    return {
        "status": "sent",
        "partition": result.partition,
        "offset": result.offset
    }
```

---

## –°–ª–∞–π–¥ 34: Kafka + FastAPI - Consumer

```python
from kafka import KafkaConsumer
import json
import asyncio

consumer = KafkaConsumer(
    'events',
    bootstrap_servers=['localhost:9092'],
    group_id='processor-group',
    value_deserializer=lambda m: json.loads(m.decode('utf-8'))
)

async def process_events():
    for message in consumer:
        event = message.value
        
        if event['type'] == 'order':
            await process_order(event['data'])
        elif event['type'] == 'payment':
            await process_payment(event['data'])

# –ó–∞–ø—É—Å–∫ –≤ —Ñ–æ–Ω–µ
asyncio.create_task(process_events())
```

---

## –°–ª–∞–π–¥ 31: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –±—Ä–æ–∫–µ—Ä–æ–≤

| –ö—Ä–∏—Ç–µ—Ä–∏–π | Redis | RabbitMQ | Kafka |
|----------|-------|----------|-------|
| **–°–∫–æ—Ä–æ—Å—Ç—å** | 100k+ msg/s | 20k msg/s | 1M+ msg/s |
| **–ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** | –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ | –î–∞ | –î–∞ |
| **–ì–∞—Ä–∞–Ω—Ç–∏–∏** | At most once | At least once | Exactly once |
| **–°–ª–æ–∂–Ω–æ—Å—Ç—å** | –ù–∏–∑–∫–∞—è | –°—Ä–µ–¥–Ω—è—è | –í—ã—Å–æ–∫–∞—è |
| **–•—Ä–∞–Ω–µ–Ω–∏–µ** | RAM | Disk | Disk |
| **–ü–æ—Ä—è–¥–æ–∫** | –ù–µ—Ç | –î–∞ | –î–∞ (–≤ –ø–∞—Ä—Ç–∏—Ü–∏–∏) |

---

## –°–ª–∞–π–¥ 32: –í—ã–±–æ—Ä –±—Ä–æ–∫–µ—Ä–∞

**Redis:**
- –ü—Ä–æ—Å—Ç—ã–µ –∑–∞–¥–∞—á–∏
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- Pub/Sub –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–∞—è –ø–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö

**RabbitMQ:**
- –ó–∞–¥–∞—á–∏ —Å –≥–∞—Ä–∞–Ω—Ç–∏–µ–π –¥–æ—Å—Ç–∞–≤–∫–∏
- –°–ª–æ–∂–Ω–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∑–∞–¥–∞—á
- –°—Ä–µ–¥–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏

**Kafka:**
- –ë–æ–ª—å—à–∏–µ –æ–±—ä–µ–º—ã –¥–∞–Ω–Ω—ã—Ö
- Event Sourcing
- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## –°–ª–∞–π–¥ 33: Celery –∏ –±—Ä–æ–∫–µ—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π
### –ó–∞—á–µ–º –∫—Ä–æ–ª–∏–∫—É –∏ —Ä–µ–¥–∏—Å–∫–µ –Ω—É–∂–µ–Ω —Å–µ–ª—å–¥–µ—Ä–µ–π? ü•ïüê∞

**Celery** - —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ—á–µ—Ä–µ–¥–µ–π –∑–∞–¥–∞—á –¥–ª—è Python

```python
# –ë–µ–∑ Celery - —Ä—É—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –±—Ä–æ–∫–µ—Ä–æ–º
import pika

connection = pika.BlockingConnection(...)
channel = connection.channel()
channel.queue_declare(queue='tasks')
channel.basic_publish(exchange='', routing_key='tasks', body='task_data')
# –ù—É–∂–Ω–æ —Å–∞–º–æ–º—É: —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è, retry, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥, worker'—ã
```

```python
# –° Celery - –≤—Å—ë –∏–∑ –∫–æ—Ä–æ–±–∫–∏
from celery import Celery

app = Celery('tasks', broker='redis://localhost:6379/0')

@app.task(retry_backoff=True, max_retries=3)
def send_email(to, subject, body):
    # –ü—Ä–æ—Å—Ç–æ –ø–∏—à–µ–º –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É
    smtp.send(to, subject, body)

# –í—ã–∑–æ–≤
send_email.delay('user@example.com', 'Hello', 'World')
```

---

## –°–ª–∞–π–¥ 34: –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ Celery

**–ß—Ç–æ –¥–∞—ë—Ç Celery –∏–∑ –∫–æ—Ä–æ–±–∫–∏:**
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è/–¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è
- ‚úÖ Retry —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (Flower)
- ‚úÖ –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏ (Celery Beat)
- ‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∑–∞–¥–∞—á
- ‚úÖ Routing –∏ —Ü–µ–ø–æ—á–∫–∏ –∑–∞–¥–∞—á

**Celery + Redis = üöÄ**
- Redis –∫–∞–∫ –±—Ä–æ–∫–µ—Ä (–±—ã—Å—Ç—Ä–æ)
- Redis –∫–∞–∫ backend —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- –ü—Ä–æ—Å—Ç–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
- –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –∑–∞–¥–∞—á

**Celery + RabbitMQ = üõ°Ô∏è**
- –ì–∞—Ä–∞–Ω—Ç–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏
- –°–ª–æ–∂–Ω–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è
- Enterprise-ready
- –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –∑–∞–¥–∞—á–∏



## –°–ª–∞–π–¥ 34: Celery + Redis/RabbitMQ

```python
# celery_app.py
from celery import Celery

# Redis –∫–∞–∫ –±—Ä–æ–∫–µ—Ä
app = Celery('tasks', broker='redis://localhost:6379/0')

# –ò–ª–∏ RabbitMQ
# app = Celery('tasks', broker='amqp://localhost')

@app.task
def send_email(to: str, subject: str, body: str):
    # –û—Ç–ø—Ä–∞–≤–∫–∞ email
    smtp.send(to, subject, body)
    return f"Email sent to {to}"

# FastAPI
from fastapi import FastAPI
from celery_app import send_email

app = FastAPI()

@app.post("/send-email")
async def queue_email(to: str, subject: str, body: str):
    task = send_email.delay(to, subject, body)
    return {"task_id": task.id, "status": "queued"}
```

---

## –°–ª–∞–π–¥ 35: –ü–∞—Ç—Ç–µ—Ä–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

**1. Task Queue (–û—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á)**
```python
# –û—Ç–ª–æ–∂–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
queue.send("process_video", video_id)
```

**2. Pub/Sub (–ò–∑–¥–∞—Ç–µ–ª—å-–ø–æ–¥–ø–∏—Å—á–∏–∫)**
```python
# –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
pubsub.publish("user.registered", user_data)
```

**3. Event Sourcing**
```python
# –ò—Å—Ç–æ—Ä–∏—è —Å–æ–±—ã—Ç–∏–π
kafka.send("events", {"type": "order.created", "data": order})
```

**4. Request-Reply**
```python
# RPC —á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥–∏
response = queue.call("calculate", data)
```

---

## –°–ª–∞–π–¥ 36: Best Practices

**1. –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**
```python
# –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ–π
def process_order(order_id):
    if already_processed(order_id):
        return
    # –û–±—Ä–∞–±–æ—Ç–∫–∞
```

**2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**
```python
@app.task(bind=True, max_retries=3)
def task(self, data):
    try:
        process(data)
    except Exception as exc:
        raise self.retry(exc=exc, countdown=60)
```

**3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**
```python
# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –º–µ—Ç—Ä–∏–∫–∏
logger.info(f"Processing message {msg_id}")
metrics.increment("messages.processed")
```

---

## –°–ª–∞–π–¥ 37 –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–ß—Ç–æ –∏–∑—É—á–∏–ª–∏:**
- Redis - –±—ã—Å—Ç—Ä—ã–π in-memory –±—Ä–æ–∫–µ—Ä
- RabbitMQ - –Ω–∞–¥–µ–∂–Ω–∞—è –æ—á–µ—Ä–µ–¥—å —Å–æ–æ–±—â–µ–Ω–∏–π
- Kafka - –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –ø–æ—Ç–æ–∫–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å FastAPI

**–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:**
- –í—ã–±–æ—Ä –±—Ä–æ–∫–µ—Ä–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∑–∞–¥–∞—á–∏
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å —É–ª—É—á—à–∞–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- –í–∞–∂–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:**
- Celery –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

---

---

## –†–µ—Å—É—Ä—Å—ã

- Redis: https://redis.io/docs/
- RabbitMQ: https://www.rabbitmq.com/tutorials/
- Kafka: https://kafka.apache.org/documentation/
- Celery: https://docs.celeryq.dev/
- FastAPI: https://fastapi.tiangolo.com/

**GitHub –ø—Ä–∏–º–µ—Ä—ã:**
- https://github.com/celery/celery
- https://github.com/dpkp/kafka-python
- https://github.com/pika/pika
