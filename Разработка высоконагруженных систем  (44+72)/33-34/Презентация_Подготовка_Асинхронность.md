# ‚ö° –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å –∏ WebSocket: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ GraphQL Subscriptions

**–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞:** –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –≤—ã—Å–æ–∫–æ–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º  
**–¢–µ–º–∞:** –°–æ–∫–µ—Ç—ã, –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å, asyncio, aiohttp  
**–¶–µ–ª—å:** –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–π —Ä–∞–±–æ—Ç–µ "GraphQL Subscriptions —Å WebSocket –∏ Redis"

---

## –°–ª–∞–π–¥ 1: –¢–∏—Ç—É–ª—å–Ω—ã–π

# ‚ö° –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å –∏ WebSocket

## –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–π —Ä–∞–±–æ—Ç–µ

**GraphQL Subscriptions —Å WebSocket –∏ Redis**

---

## –°–ª–∞–π–¥ 2: –ü–ª–∞–Ω –∑–∞–Ω—è—Ç–∏—è

# üìã –ü–ª–∞–Ω –∑–∞–Ω—è—Ç–∏—è

1. üîå **–°–æ–∫–µ—Ç—ã** - –æ—Å–Ω–æ–≤—ã —Å–µ—Ç–µ–≤–æ–≥–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è
2. ‚ö° **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å** - –ø–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ
3. üêç **asyncio** - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π Python
4. üåê **aiohttp** - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π HTTP –∫–ª–∏–µ–Ω—Ç/—Å–µ—Ä–≤–µ—Ä
5. üîÑ **AsyncIterator** - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –∏—Ç–µ—Ä–∞—Ç–æ—Ä—ã
6. üéØ **asyncio.gather** - –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
7. üí° **–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã**

---

## –°–ª–∞–π–¥ 3: –ß—Ç–æ —Ç–∞–∫–æ–µ —Å–æ–∫–µ—Ç—ã?

# üîå –ß—Ç–æ —Ç–∞–∫–æ–µ —Å–æ–∫–µ—Ç—ã?

**–°–æ–∫–µ—Ç** = –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Å–µ—Ç–µ–≤–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è

```
–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (Python)
       ‚Üì
    –°–æ–∫–µ—Ç—ã (API)
       ‚Üì
   TCP/UDP (–û–°)
       ‚Üì
    IP (–û–°)
       ‚Üì
   –°–µ—Ç–µ–≤–∞—è –∫–∞—Ä—Ç–∞
```

**–ê–Ω–∞–ª–æ–≥–∏—è:** –°–æ–∫–µ—Ç = —Ç–µ–ª–µ—Ñ–æ–Ω–Ω–∞—è —Ä–æ–∑–µ—Ç–∫–∞ –¥–ª—è –ø—Ä–æ–≥—Ä–∞–º–º

---

## –°–ª–∞–π–¥ 4: –ó–∞—á–µ–º –Ω—É–∂–Ω—ã —Å–æ–∫–µ—Ç—ã?

# –ó–∞—á–µ–º –Ω—É–∂–Ω—ã —Å–æ–∫–µ—Ç—ã?

‚úÖ **–ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø** –∫ —Å–µ—Ç–µ–≤–æ–º—É —Å—Ç–µ–∫—É –û–°  
‚úÖ **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –Ω–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã**  
‚úÖ **–ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å** –Ω–∞–¥ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º  
‚úÖ **–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π API** –¥–ª—è –≤—Å–µ—Ö —è–∑—ã–∫–æ–≤/–û–°  

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
- HTTP-—Å–µ—Ä–≤–µ—Ä—ã (FastAPI, Flask –ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º)
- WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- TCP/UDP –∫–ª–∏–µ–Ω—Ç—ã –∏ —Å–µ—Ä–≤–µ—Ä—ã
- –ù–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è —Ä–∞–±–æ—Ç–∞ —Å —Å–µ—Ç—å—é

---

## –°–ª–∞–π–¥ 5: –ö–æ—Ä—É—Ç–∏–Ω—ã (Coroutines)

# üéØ –ö–æ—Ä—É—Ç–∏–Ω—ã (Coroutines)

**–ö–æ—Ä—É—Ç–∏–Ω–∞** = —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –º–æ–∂–µ—Ç –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ

```python
# –û–±—ã—á–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
def normal_function():
    return "Hello"

# –ö–æ—Ä—É—Ç–∏–Ω–∞ (async —Ñ—É–Ω–∫—Ü–∏—è)
async def coroutine_function():
    await asyncio.sleep(1)  # –ü—Ä–∏–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
    return "Hello"
```

**–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:**
- `async def` - –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–æ—Ä—É—Ç–∏–Ω—É
- `await` - –ø—Ä–∏–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –∂–¥–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
- `asyncio.run()` - –∑–∞–ø—É—Å–∫–∞–µ—Ç –∫–æ—Ä—É—Ç–∏–Ω—É –≤ Event Loop

---

## –°–ª–∞–π–¥ 6: async/await —Å–∏–Ω—Ç–∞–∫—Å–∏—Å

# async/await —Å–∏–Ω—Ç–∞–∫—Å–∏—Å

```python
import asyncio

# –ö–æ—Ä—É—Ç–∏–Ω–∞ 1
async def fetch_data(url):
    await asyncio.sleep(1)  # –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞
    return f"Data from {url}"

# –ö–æ—Ä—É—Ç–∏–Ω–∞ 2
async def main():
    # await - –∂–¥–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    result = await fetch_data("http://api.com")
    print(result)

# –ó–∞–ø—É—Å–∫
asyncio.run(main())
```

**–í–∞–∂–Ω–æ:**
- `await` –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ `async def`
- `await` –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤–µ—Å—å –ø–æ—Ç–æ–∫, —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â—É—é –∫–æ—Ä—É—Ç–∏–Ω—É

---

## –°–ª–∞–π–¥ 7: asyncio - –æ—Å–Ω–æ–≤—ã

# üêç asyncio - –æ—Å–Ω–æ–≤—ã

**asyncio** = –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –≤ Python

```python
import asyncio

# –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
async def my_task():
    print("–í—ã–ø–æ–ª–Ω—è—é –∑–∞–¥–∞—á—É...")
    await asyncio.sleep(1)
    return "–ì–æ—Ç–æ–≤–æ!"

# –ó–∞–ø—É—Å–∫
result = asyncio.run(my_task())
```

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- `asyncio.run()` - –∑–∞–ø—É—Å–∫ Event Loop
- `asyncio.sleep()` - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
- `asyncio.gather()` - –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
- `asyncio.create_task()` - —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏

---

## –°–ª–∞–π–¥ 8: asyncio.sleep vs time.sleep

# asyncio.sleep vs time.sleep

```python
import asyncio
import time

# ‚ùå –ë–õ–û–ö–ò–†–£–ï–¢ –≤–µ—Å—å –ø–æ—Ç–æ–∫
def blocking_sleep():
    time.sleep(1)  # –í—Å–µ –∂–¥—É—Ç!

# ‚úÖ –ù–ï –±–ª–æ–∫–∏—Ä—É–µ—Ç, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ –¥—Ä—É–≥–∏–µ –∑–∞–¥–∞—á–∏
async def non_blocking_sleep():
    await asyncio.sleep(1)  # Event Loop —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –¥—Ä—É–≥–∏–º–∏ –∑–∞–¥–∞—á–∞–º–∏
```

**–†–∞–∑–Ω–∏—Ü–∞:**

```python
# –° time.sleep - –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ (2 —Å–µ–∫—É–Ω–¥—ã)
async def bad():
    time.sleep(1)
    time.sleep(1)

# –° asyncio.sleep - –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ (1 —Å–µ–∫—É–Ω–¥–∞)
async def good():
    await asyncio.gather(
        asyncio.sleep(1),
        asyncio.sleep(1)
    )
```

---

## –°–ª–∞–π–¥ 9: asyncio.gather - –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ

# üéØ asyncio.gather - –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ

**gather** = –∑–∞–ø—É—Å–∫–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–æ—Ä—É—Ç–∏–Ω –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ

```python
import asyncio

async def fetch_user(id):
    await asyncio.sleep(0.5)  # –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ –∫ –ë–î
    return f"User {id}"

async def main():
    # ‚ùå –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ (1.5 —Å–µ–∫—É–Ω–¥—ã)
    user1 = await fetch_user(1)
    user2 = await fetch_user(2)
    user3 = await fetch_user(3)
    
    # ‚úÖ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ (0.5 —Å–µ–∫—É–Ω–¥—ã)
    users = await asyncio.gather(
        fetch_user(1),
        fetch_user(2),
        fetch_user(3)
    )
    # users = ["User 1", "User 2", "User 3"]
```

---

## –°–ª–∞–π–¥ 10: asyncio.gather - –ø—Ä–∏–º–µ—Ä

# asyncio.gather - –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä

```python
import asyncio
import aiohttp

async def fetch_url(session, url):
    async with session.get(url) as response:
        return await response.text()

async def main():
    urls = [
        "http://api1.com",
        "http://api2.com",
        "http://api3.com"
    ]
    
    async with aiohttp.ClientSession() as session:
        # –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ!
        results = await asyncio.gather(
            *[fetch_url(session, url) for url in urls]
        )
    
    print(results)  # –í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≥–æ—Ç–æ–≤—ã

asyncio.run(main())
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ:** 3 –∑–∞–ø—Ä–æ—Å–∞ –∑–∞ –≤—Ä–µ–º—è 1 –∑–∞–ø—Ä–æ—Å–∞!

---

## –°–ª–∞–π–¥ 11: AsyncIterator - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –∏—Ç–µ—Ä–∞—Ç–æ—Ä—ã

# üîÑ AsyncIterator - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –∏—Ç–µ—Ä–∞—Ç–æ—Ä—ã

**AsyncIterator** = –∏—Ç–µ—Ä–∞—Ç–æ—Ä, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–±–æ—Ç–∞–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ

```python
from typing import AsyncIterator

# –û–±—ã—á–Ω—ã–π –∏—Ç–µ—Ä–∞—Ç–æ—Ä (–±–ª–æ–∫–∏—Ä—É—é—â–∏–π)
def normal_iterator():
    for i in range(10):
        yield i  # –ë–ª–æ–∫–∏—Ä—É–µ—Ç

# –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∏—Ç–µ—Ä–∞—Ç–æ—Ä (–Ω–µ –±–ª–æ–∫–∏—Ä—É—é—â–∏–π)
async def async_iterator() -> AsyncIterator[int]:
    for i in range(10):
        await asyncio.sleep(0.1)  # –ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º Event Loop!
        yield i

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
async def main():
    async for value in async_iterator():
        print(value)  # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ –º–µ—Ä–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è
```

---

## –°–ª–∞–π–¥ 12: AsyncIterator –≤ GraphQL Subscriptions

# AsyncIterator –≤ GraphQL Subscriptions

**GraphQL Subscriptions –∏—Å–ø–æ–ª—å–∑—É—é—Ç AsyncIterator!**

```python
from typing import AsyncIterator
import strawberry

@strawberry.type
class Subscription:
    @strawberry.subscription
    async def message_added(self) -> AsyncIterator[MessageType]:
        # –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –∫–∞–Ω–∞–ª
        async for message_data in pubsub.subscribe("messages"):
            # yield –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—É —á–µ—Ä–µ–∑ WebSocket
            yield MessageType(**message_data)
```

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. –ö–ª–∏–µ–Ω—Ç –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ WebSocket
2. `async for` –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –∏–∑ pub/sub
3. `yield` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–∞–∂–¥–æ–µ —Å–æ–±—ã—Ç–∏–µ –∫–ª–∏–µ–Ω—Ç—É
4. Event Loop –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è!

---

## –°–ª–∞–π–¥ 13: aiohttp - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π HTTP

# üåê aiohttp - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π HTTP

**aiohttp** = –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è HTTP –∫–ª–∏–µ–Ω—Ç–∞ –∏ —Å–µ—Ä–≤–µ—Ä–∞

```python
import aiohttp
import asyncio

# HTTP –ö–ª–∏–µ–Ω—Ç
async def fetch_data():
    async with aiohttp.ClientSession() as session:
        async with session.get('http://api.com/data') as response:
            data = await response.json()
            return data

# HTTP –°–µ—Ä–≤–µ—Ä
from aiohttp import web

async def handler(request):
    return web.Response(text="Hello, aiohttp!")

app = web.Application()
app.router.add_get('/', handler)
web.run_app(app, port=8080)
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:** –ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç Event Loop!

---

## –°–ª–∞–π–¥ 14: aiohttp vs requests

# aiohttp vs requests

```python
# ‚ùå requests - –±–ª–æ–∫–∏—Ä—É—é—â–∏–π
import requests

def blocking_requests():
    response1 = requests.get('http://api1.com')  # ‚è∏Ô∏è –ñ–¥–µ–º
    response2 = requests.get('http://api2.com')  # ‚è∏Ô∏è –ñ–¥–µ–º
    response3 = requests.get('http://api3.com')  # ‚è∏Ô∏è –ñ–¥–µ–º
    # –í—Ä–µ–º—è: 3 —Å–µ–∫—É–Ω–¥—ã

# ‚úÖ aiohttp - –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–π
import aiohttp

async def non_blocking_requests():
    async with aiohttp.ClientSession() as session:
        results = await asyncio.gather(
            session.get('http://api1.com'),
            session.get('http://api2.com'),
            session.get('http://api3.com')
        )
    # –í—Ä–µ–º—è: 1 —Å–µ–∫—É–Ω–¥–∞ (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ!)
```

---

## –°–ª–∞–π–¥ 15: aiohttp WebSocket —Å–µ—Ä–≤–µ—Ä

# aiohttp WebSocket —Å–µ—Ä–≤–µ—Ä

**WebSocket** = –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–ª—è real-time –æ–±—â–µ–Ω–∏—è

```python
from aiohttp import web

async def websocket_handler(request):
    ws = web.WebSocketResponse()
    await ws.prepare(request)  # –ü–æ–¥–Ω–∏–º–∞–µ–º WebSocket
    
    async for msg in ws:
        if msg.type == web.MsgType.text:
            # –ü–æ–ª—É—á–∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
            await ws.send_str(f"Echo: {msg.data}")
        elif msg.type == web.MsgType.error:
            break
    
    return ws

app = web.Application()
app.router.add_get('/ws', websocket_handler)
web.run_app(app, port=8080)
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** GraphQL Subscriptions —Ä–∞–±–æ—Ç–∞—é—Ç —á–µ—Ä–µ–∑ WebSocket!

---

## –°–ª–∞–π–¥ 16: WebSocket –∫–ª–∏–µ–Ω—Ç (aiohttp)

# WebSocket –∫–ª–∏–µ–Ω—Ç (aiohttp)

```python
import aiohttp
import asyncio

async def websocket_client():
    async with aiohttp.ClientSession() as session:
        async with session.ws_connect('ws://localhost:8080/ws') as ws:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            await ws.send_str("Hello, Server!")
            
            # –ü–æ–ª—É—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
            async for msg in ws:
                if msg.type == aiohttp.WSMsgType.TEXT:
                    print(f"–ü–æ–ª—É—á–µ–Ω–æ: {msg.data}")
                elif msg.type == aiohttp.WSMsgType.ERROR:
                    break

asyncio.run(websocket_client())
```

**–í–∞–∂–Ω–æ:** `async for` –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—É—á–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏!

---

## –°–ª–∞–π–¥ 17: Pub/Sub –ø–∞—Ç—Ç–µ—Ä–Ω

# üì¢ Pub/Sub –ø–∞—Ç—Ç–µ—Ä–Ω

**Pub/Sub (Publish/Subscribe)** = –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ —Å–æ–±—ã—Ç–∏–π

```
Publisher (–ò–∑–¥–∞—Ç–µ–ª—å)          Subscribers (–ü–æ–¥–ø–∏—Å—á–∏–∫–∏)
     ‚îÇ                              ‚îÇ
     ‚îÇ  publish("messages", data)   ‚îÇ
     ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
     ‚îÇ                              ‚îÇ
     ‚îÇ                              ‚îú‚îÄ‚Üí –ö–ª–∏–µ–Ω—Ç 1 –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ
     ‚îÇ                              ‚îÇ
     ‚îÇ                              ‚îú‚îÄ‚Üí –ö–ª–∏–µ–Ω—Ç 2 –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ
     ‚îÇ                              ‚îÇ
     ‚îÇ                              ‚îî‚îÄ‚Üí –ö–ª–∏–µ–Ω—Ç 3 –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ
```

**–í GraphQL Subscriptions:**
- –ú—É—Ç–∞—Ü–∏—è = Publisher (–ø—É–±–ª–∏–∫—É–µ—Ç —Å–æ–±—ã—Ç–∏–µ)
- Subscription = Subscriber (–ø–æ–ª—É—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è)

---

## –°–ª–∞–π–¥ 18: Pub/Sub —Å AsyncIterator

# Pub/Sub —Å AsyncIterator

```python
import asyncio
from typing import AsyncIterator

class PubSubManager:
    def __init__(self):
        self.subscribers = {}
    
    async def subscribe(self, channel: str) -> AsyncIterator[dict]:
        queue = asyncio.Queue()
        self.subscribers.setdefault(channel, []).append(queue)
        
        try:
            while True:
                # async for –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –∏–∑ –æ—á–µ—Ä–µ–¥–∏
                message = await queue.get()
                yield message  # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å—á–∏–∫—É
        finally:
            # –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏
            self.subscribers[channel].remove(queue)
    
    async def publish(self, channel: str, message: dict):
        for queue in self.subscribers.get(channel, []):
            await queue.put(message)  # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ–º –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º
```

---

## –°–ª–∞–π–¥ 19: –ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä: Pub/Sub + AsyncIterator

# –ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä: Pub/Sub + AsyncIterator

```python
import asyncio
from typing import AsyncIterator

pubsub = PubSubManager()

# –ü–æ–¥–ø–∏—Å—á–∏–∫ (GraphQL Subscription)
async def subscriber():
    async for event in pubsub.subscribe("messages"):
        print(f"–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ: {event}")

# –ò–∑–¥–∞—Ç–µ–ª—å (GraphQL Mutation)
async def publisher():
    await asyncio.sleep(1)
    await pubsub.publish("messages", {"id": 1, "text": "Hello!"})

# –ó–∞–ø—É—Å–∫–∞–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
async def main():
    await asyncio.gather(
        subscriber(),  # –ñ–¥–µ—Ç —Å–æ–±—ã—Ç–∏—è
        publisher()    # –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏–µ
    )

asyncio.run(main())
# –í—ã–≤–æ–¥: –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ: {'id': 1, 'text': 'Hello!'}
```

---

## –°–ª–∞–π–¥ 20: asyncio.Queue - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—á–µ—Ä–µ–¥—å

# asyncio.Queue - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—á–µ—Ä–µ–¥—å

**Queue** = –æ—á–µ—Ä–µ–¥—å –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –∫–æ—Ä—É—Ç–∏–Ω–∞–º–∏

```python
import asyncio

async def producer(queue):
    for i in range(5):
        await queue.put(f"Item {i}")
        await asyncio.sleep(0.5)
    await queue.put(None)  # –°–∏–≥–Ω–∞–ª –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

async def consumer(queue):
    while True:
        item = await queue.get()
        if item is None:
            break
        print(f"–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {item}")

async def main():
    queue = asyncio.Queue()
    await asyncio.gather(
        producer(queue),
        consumer(queue)
    )

asyncio.run(main())
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –í Pub/Sub –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ —Å–æ–±—ã—Ç–∏–π!

---

## –°–ª–∞–π–¥ 21: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ async –∫–æ–¥–µ

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ async –∫–æ–¥–µ

```python
import asyncio

async def risky_task():
    await asyncio.sleep(1)
    raise ValueError("–û—à–∏–±–∫–∞!")

# ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
async def main():
    try:
        await risky_task()
    except ValueError as e:
        print(f"–ü–æ–π–º–∞–ª–∏ –æ—à–∏–±–∫—É: {e}")

# ‚úÖ –í asyncio.gather
async def main():
    results = await asyncio.gather(
        task1(),
        task2(),
        return_exceptions=True  # –ù–µ –ø—Ä–µ—Ä—ã–≤–∞—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–µ
    )
    for result in results:
        if isinstance(result, Exception):
            print(f"–û—à–∏–±–∫–∞: {result}")
        else:
            print(f"–£—Å–ø–µ—Ö: {result}")
```

---

## –°–ª–∞–π–¥ 22: –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä: WebSocket —Å–µ—Ä–≤–µ—Ä

# –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä: WebSocket —Å–µ—Ä–≤–µ—Ä

```python
from aiohttp import web
import asyncio

pubsub = PubSubManager()

async def websocket_handler(request):
    ws = web.WebSocketResponse()
    await ws.prepare(request)
    
    # –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –∫–∞–Ω–∞–ª —á–µ—Ä–µ–∑ AsyncIterator
    async for event in pubsub.subscribe("messages"):
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –∫–ª–∏–µ–Ω—Ç—É —á–µ—Ä–µ–∑ WebSocket
        await ws.send_json(event)
    
    return ws

async def create_message():
    # –ò–º–∏—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
    await asyncio.sleep(2)
    await pubsub.publish("messages", {
        "id": 1,
        "text": "–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!"
    })

app = web.Application()
app.router.add_get('/ws', websocket_handler)

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ñ–æ–Ω–µ
asyncio.create_task(create_message())

web.run_app(app, port=8080)
```

---

## –°–ª–∞–π–¥ 23: –°–≤—è–∑—å —Å GraphQL Subscriptions

# –°–≤—è–∑—å —Å GraphQL Subscriptions

**–ö–∞–∫ –≤—Å–µ —ç—Ç–æ —Å–≤—è–∑–∞–Ω–æ:**

```python
# 1. Pub/Sub –º–µ–Ω–µ–¥–∂–µ—Ä (asyncio.Queue)
pubsub = PubSubManager()

# 2. GraphQL Subscription (AsyncIterator)
@strawberry.subscription
async def message_added(self) -> AsyncIterator[MessageType]:
    async for message_data in pubsub.subscribe("messages"):
        yield MessageType(**message_data)

# 3. GraphQL Mutation (Publisher)
@strawberry.mutation
async def create_message(self, text: str):
    new_message = await create_in_db(text)
    # –ü—É–±–ª–∏–∫—É–µ–º —Å–æ–±—ã—Ç–∏–µ
    await pubsub.publish("messages", new_message.to_dict())
    return new_message

# 4. WebSocket (aiohttp/FastAPI)
# GraphQL Subscriptions —Ä–∞–±–æ—Ç–∞—é—Ç —á–µ—Ä–µ–∑ WebSocket!
```

---

## –°–ª–∞–π–¥ 24: –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã

# üéØ –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã

‚úÖ **asyncio** - –æ—Å–Ω–æ–≤–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ Python  
‚úÖ **async/await** - —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –¥–ª—è –∫–æ—Ä—É—Ç–∏–Ω  
‚úÖ **AsyncIterator** - –¥–ª—è –ø–æ—Ç–æ–∫–æ–≤–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö  
‚úÖ **asyncio.gather** - –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ  
‚úÖ **aiohttp** - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π HTTP/WebSocket  
‚úÖ **asyncio.Queue** - –ø–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –∫–æ—Ä—É—Ç–∏–Ω–∞–º–∏  
‚úÖ **Pub/Sub** - –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è —Å–æ–±—ã—Ç–∏–π  
‚úÖ **WebSocket** - real-time —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ  

**–í GraphQL Subscriptions:**
- Subscription = AsyncIterator
- WebSocket = —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç
- Pub/Sub = –º–µ—Ö–∞–Ω–∏–∑–º —Å–æ–±—ã—Ç–∏–π

---

## –°–ª–∞–π–¥ 25: –ß—Ç–æ –¥–∞–ª—å—à–µ?

# üöÄ –ß—Ç–æ –¥–∞–ª—å—à–µ?

**–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞:**
1. –°–æ–∑–¥–∞–¥–∏–º Pub/Sub –º–µ–Ω–µ–¥–∂–µ—Ä —Å `asyncio.Queue`
2. –†–µ–∞–ª–∏–∑—É–µ–º GraphQL Subscriptions —Å `AsyncIterator`
3. –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ–º WebSocket —á–µ—Ä–µ–∑ FastAPI/Strawberry
4. –î–æ–±–∞–≤–∏–º Redis –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è

**–ü–æ–º–Ω–∏—Ç–µ:**
- `async def` - –∫–æ—Ä—É—Ç–∏–Ω–∞
- `await` - –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç Event Loop
- `async for` - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∏—Ç–µ—Ä–∞—Ü–∏—è
- `asyncio.gather()` - –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
- `yield` –≤ AsyncIterator - –æ—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç—É

**–£–¥–∞—á–∏ –≤ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–π —Ä–∞–±–æ—Ç–µ! üéâ**

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è asyncio](https://docs.python.org/3/library/asyncio.html)
- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è aiohttp](https://docs.aiohttp.org/)
- [AsyncIterator –≤ Python](https://docs.python.org/3/library/typing.html#typing.AsyncIterator)
- [WebSocket –ø—Ä–æ—Ç–æ–∫–æ–ª](https://developer.mozilla.org/ru/docs/Web/API/WebSockets_API)

