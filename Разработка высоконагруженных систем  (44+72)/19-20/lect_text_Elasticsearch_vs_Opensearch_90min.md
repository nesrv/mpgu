# Текст лекции: Elasticsearch vs OpenSearch (90 минут)

## Вступление (5 мин)

Привет! Сегодня разберем два поисковых движка, которые как два брата-близнеца — внешне похожи, но характеры разные. Elasticsearch и OpenSearch. Это как выбирать между iPhone и Android — оба звонят, но философия разная.

Представьте: у вас петабайты логов, миллионы документов, и вам нужно найти иголку в стоге сена за миллисекунды. Обычная SQL-база тут сдохнет как хомяк на беговой дорожке. Вот тут и нужны эти монстры.

**Кто юзает в РФ?** Сбер, Тинькофф, Яндекс — все на Elasticsearch сидят. МТС, Ростелеком, Госуслуги — мигрируют на OpenSearch. Почему? Сейчас разберем.

---

## Блок 1: История и драма (10 мин)

### Elasticsearch — как все начиналось

2010 год. Парень по имени Shay Banon пилит поисковик для своей жены, которая учится на повара. Ей нужно искать рецепты. Он берет Apache Lucene (это как движок от Ferrari — мощный, но сложный), оборачивает его в REST API и делает распределенным. Получается Elasticsearch.

**Ассоциация:** Lucene — это как двигатель V12. Сам по себе крутой, но чтобы ездить, нужна машина. Elasticsearch — это та самая машина.

2012 — основывает компанию Elastic NV. Делает ELK Stack (Elasticsearch + Logstash + Kibana). Это как Apple экосистема — все работает вместе, красиво, но с подвохом.

2018 — IPO на NYSE. Бабки текут рекой. Все счастливы.

### 2021 — развод века

**Драма!** Elastic меняет лицензию с Apache 2.0 на SSPL (Server Side Public License). Это как если бы GitHub вдруг сказал: "Хотите хостить наш код в облаке? Платите!"

**Почему?** AWS делал бабки на Elasticsearch, не отдавая ничего Elastic. Представьте: вы пишете опенсорс, а Amazon берет ваш код, запускает как сервис и зарабатывает миллиарды. Вы — ноль. Обидно, да?

**Ответ AWS:** "Ок, мы форкнем последнюю Apache 2.0 версию (7.10.2) и сделаем свой проект". Так родился OpenSearch.

**Ассоциация:** Это как развод родителей. Дети (пользователи) теперь выбирают, с кем жить.

---

## Блок 2: Лицензии — кто кого (5 мин)

### Elasticsearch — двойная лицензия

- **SSPL** — "хочешь хостить как сервис? Открывай весь свой код!"
- **Elastic License 2.0** — можно юзать, но не продавать как сервис
- **X-Pack** — крутые фичи (ML, Security) — платно (раньше, сейчас часть бесплатна)

**Ассоциация:** Freemium модель. Базовая версия бесплатна, но за крутые плюшки — плати.

### OpenSearch — полностью открыт

- **Apache 2.0** — делай что хочешь, хоть продавай
- Все фичи бесплатны
- AWS поддерживает

**Ассоциация:** Как Linux. Свободен как птица.

**Вывод:** Если вы стартап или госструктура (импортозамещение) — OpenSearch. Если нужна коммерческая поддержка и готовы платить — Elasticsearch.

---

## Блок 3: Архитектура — как это работает (15 мин)

### Общая база — Apache Lucene

Оба стоят на Lucene. Это как два небоскреба на одном фундаменте.

**Что такое Lucene?** Библиотека для полнотекстового поиска. Умеет:
- Разбивать текст на токены (слова)
- Строить инвертированный индекс (слово → список документов)
- Ранжировать по релевантности (BM25 алгоритм)

**Ассоциация:** Инвертированный индекс — это как индекс в конце учебника. Вместо "страница → слова" у нас "слово → страницы".

### Кластер — распределенная система

**Узлы (Nodes):**
- **Master** — мозг кластера, управляет всем (как CEO)
- **Data** — хранят данные (как склад)
- **Coordinating** — роутер запросов (как диспетчер)
- **Ingest** — предобработка данных (как ETL)
- **ML** — машинное обучение (в Elasticsearch платно, в OpenSearch бесплатно)

**Ассоциация:** Кластер — это как муравейник. Каждый муравей (нода) делает свою работу, но вместе — сила.

### Индексы и шарды

**Индекс** — это как таблица в SQL. Коллекция документов.

**Шард** — кусок индекса. Представьте: у вас 1 TB данных. Один сервер не потянет. Делим на 10 шардов по 100 GB. Каждый шард — на своем сервере.

**Primary shard** — оригинал. **Replica shard** — копия (для отказоустойчивости).

**Ассоциация:** Шарды — это как RAID массив. Данные разбиты, но работают как единое целое.

**Оптимально:** 20-50 GB на шард. Больше — медленно, меньше — оверхед.

### RESTful API

Все через HTTP. Никаких драйверов, протоколов. Просто JSON.

```bash
# Создать документ
POST /articles/_doc/1
{"title": "Hello", "content": "World"}

# Найти
GET /articles/_search
{"query": {"match": {"title": "Hello"}}}
```

**Ассоциация:** Как работать с любым веб-сервисом. Curl и вперед.

---

## Блок 4: Поиск — магия Lucene (15 мин)

### Full-text search

Не просто `LIKE '%слово%'`. Это умный поиск с анализом текста.

**Процесс:**
1. **Токенизация** — "Я бежал по улице" → ["Я", "бежал", "по", "улице"]
2. **Lowercase** — ["я", "бежал", "по", "улице"]
3. **Стоп-слова** — убираем "я", "по" → ["бежал", "улице"]
4. **Стемминг** — корни слов → ["беж", "улиц"]

Теперь "бежал", "бежит", "бегу" — найдут одно и то же!

**Ассоциация:** Как Google поиск. Вы пишете "купить айфон", он находит "покупка iPhone".

### Query DSL — язык запросов

```json
{
  "query": {
    "bool": {
      "must": [{"match": {"title": "search"}}],      // AND (влияет на score)
      "filter": [{"range": {"date": {"gte": "2024"}}}], // AND (не влияет на score, кэшируется)
      "should": [{"match": {"tags": "hot"}}],        // OR (бонус к score)
      "must_not": [{"term": {"status": "draft"}}]    // NOT
    }
  }
}
```

**Ассоциация:** 
- **must** — обязательно (как WHERE в SQL)
- **filter** — обязательно, но без влияния на релевантность (быстрее)
- **should** — желательно (как бонусные баллы)
- **must_not** — исключить

### Fuzzy search — поиск с опечатками

```json
{"query": {"fuzzy": {"title": {"value": "databse", "fuzziness": 2}}}}
```

Найдет "database" даже если вы написали "databse". Расстояние Левенштейна — сколько символов нужно изменить.

**Ассоциация:** Как T9 в телефоне. Понимает, что вы хотели сказать.

### Highlighting — подсветка

```json
{"highlight": {"fields": {"content": {}}}}
```

Вернет: "...найден <em>поисковый</em> запрос..."

**Ассоциация:** Как Ctrl+F в браузере. Желтая подсветка.

---

## Блок 5: Агрегации — аналитика на лету (10 мин)

### Metrics — считаем цифры

```json
{"aggs": {"avg_price": {"avg": {"field": "price"}}}}
```

Вернет средний price. Как `SELECT AVG(price)` в SQL.

**Типы:** avg, sum, min, max, stats (все сразу), percentiles

### Bucket — группировка

```json
{"aggs": {"by_category": {"terms": {"field": "category"}}}}
```

Как `GROUP BY category`. Вернет топ категорий с количеством.

**Типы:**
- **terms** — группировка по значению (TOP-N)
- **date_histogram** — по времени (по дням, часам)
- **range** — по диапазонам (0-100, 100-200)

### Pipeline — агрегации над агрегациями

```json
{"aggs": {
  "sales_per_month": {"date_histogram": {"field": "date", "interval": "month"}},
  "cumulative_sales": {"cumulative_sum": {"buckets_path": "sales_per_month"}}
}}
```

Считаем продажи по месяцам, потом накопительный итог.

**Ассоциация:** Как Excel pivot tables. Группируй, считай, анализируй.

---

## Блок 6: Elasticsearch vs OpenSearch — различия (15 мин)

### Уникальные фичи Elasticsearch

**ECS (Elastic Common Schema)** — стандарт полей для логов. Все логи в одном формате.

**Canvas** — рисуй красивые презентации из данных. Как PowerPoint + данные.

**Elastic APM** — мониторинг производительности приложений. Видишь, где тормозит код.

**SIEM** — Security Information and Event Management. Ловит хакеров.

**Ассоциация:** Elasticsearch — это Apple. Закрытая экосистема, но все работает из коробки.

### Уникальные фичи OpenSearch

**Anomaly Detection (бесплатно!)** — ML находит аномалии в данных. В Elasticsearch — платно.

**Trace Analytics** — распределенная трассировка. Видишь путь запроса через микросервисы.

**PPL (Piped Processing Language)** — SQL-подобный язык. Проще чем Query DSL.

```sql
source=logs | where status=500 | stats count() by host
```

**AWS интеграция** — работает с S3, Lambda, CloudWatch из коробки.

**Ассоциация:** OpenSearch — это Android. Открытый, гибкий, интегрируется со всем.

### Machine Learning

**Elasticsearch:**
- ML в X-Pack — платно (раньше, сейчас базовое бесплатно)
- Anomaly detection, forecasting

**OpenSearch:**
- ML Commons — полностью бесплатно
- k-NN search — поиск похожих векторов (для AI/ML)

**Пример:** У вас embeddings от GPT. Хотите найти похожие тексты. k-NN в OpenSearch — идеально.

### Security

**Elasticsearch:**
- До 7.11 — платно
- С 7.11 — базовая безопасность бесплатна
- RBAC, TLS, SSO

**OpenSearch:**
- Всегда бесплатно
- Fine-grained access control — права на уровне документов/полей
- Audit logging — кто что делал

**Ассоциация:** OpenSearch тут щедрее. Как Linux vs Windows — в Linux все бесплатно.

---

## Блок 7: Производительность и масштабирование (10 мин)

### Индексация

**Факторы скорости:**
- **Размер шардов** — 20-50 GB оптимально
- **Refresh interval** — по умолчанию 1s (данные видны через секунду). Увеличь до 30s — индексация быстрее
- **Bulk requests** — пакетная загрузка 1000-5000 документов за раз

**Ассоциация:** Индексация — это как загрузка фоток в Instagram. По одной — медленно, пачкой — быстро.

**Бенчмарки:** Elasticsearch vs OpenSearch — различия <5%. Практически одинаковы.

### Поиск

**Скорость:** Миллисекунды на простые запросы.

**Зависит от:**
- RAM (больше = больше кэша)
- CPU (больше ядер = больше параллелизма)
- Количество шардов (больше шардов = больше параллелизма, но оверхед)

**Кэши:**
- **Query cache** — кэширует результаты запросов
- **Field data cache** — кэширует данные полей для сортировки/агрегаций
- **Request cache** — кэширует целые ответы

**Ассоциация:** Кэш — это как оперативка. Чем больше, тем быстрее.

### Масштабирование

**Горизонтальное:** Добавляй ноды — получай больше мощности. Линейно.

**Реальные цифры:**
- Кластеры до 1000+ нод
- Петабайты данных
- Миллиарды документов

**Cross-cluster search** — поиск по нескольким кластерам сразу. Как федеративный поиск.

**Ассоциация:** Масштабирование — как Lego. Добавляй блоки, строй больше.

---

## Блок 8: Экосистема (5 мин)

### Elasticsearch Stack

**Logstash** — ETL для логов. Собирает, парсит, отправляет.

**Beats** — легковесные агенты. Filebeat (логи), Metricbeat (метрики), Packetbeat (сеть).

**Kibana** — веб-интерфейс. Дашборды, графики, визуализации.

**Elastic Cloud** — managed сервис. Платишь, не паришься.

**Ассоциация:** Как Apple экосистема. iPhone + MacBook + AirPods — все работает вместе.

### OpenSearch Stack

**Data Prepper** — аналог Logstash.

**Fluent Bit** — легковесный сборщик логов.

**OpenSearch Dashboards** — форк Kibana. Полностью бесплатный.

**AWS OpenSearch Service** — managed сервис от Amazon.

**Ассоциация:** Как Android экосистема. Открытая, гибкая, много вариантов.

---

## Блок 9: Use Cases — когда что использовать (10 мин)

### Логирование

**Сценарий:** У вас 100 серверов, каждый пишет логи. Нужно централизованно собирать, искать, анализировать.

**Решение:** ELK/OpenSearch Stack.

**Пример:** Ищем ошибки 500 за последний час:
```json
{"query": {"bool": {
  "must": [{"match": {"level": "ERROR"}}, {"term": {"status": 500}}],
  "filter": [{"range": {"timestamp": {"gte": "now-1h"}}}]
}}}
```

**Retention policies** — автоматически удаляй старые логи (>30 дней).

**Ассоциация:** Как черный ящик самолета. Все записывается, потом анализируешь.

### E-commerce поиск

**Сценарий:** Интернет-магазин. Миллионы товаров. Нужен быстрый поиск с фильтрами.

**Решение:** Elasticsearch/OpenSearch.

**Фичи:**
- Полнотекстовый поиск ("красные кроссовки")
- Фильтры (цена, бренд, размер)
- Autocomplete (подсказки при вводе)
- Faceted search (фильтры по категориям)
- Ранжирование (популярные товары выше)

**Ассоциация:** Как поиск на Ozon/Wildberries.

### Аналитика в реальном времени

**Сценарий:** Дашборд с метриками. Обновляется каждую секунду.

**Решение:** Агрегации Elasticsearch/OpenSearch.

**Пример:** Количество заказов по часам:
```json
{"aggs": {"orders_per_hour": {"date_histogram": {"field": "created_at", "interval": "hour"}}}}
```

**Ассоциация:** Как Google Analytics. Видишь статистику в реальном времени.

### SIEM — безопасность

**Сценарий:** Ловим хакеров. Анализируем логи на подозрительную активность.

**Решение:** Elasticsearch SIEM (более зрелое) или OpenSearch Security Analytics.

**Пример:** Ищем брутфорс (много неудачных логинов):
```json
{"aggs": {"failed_logins": {"terms": {"field": "username"}, "aggs": {"count": {"value_count": {"field": "status"}}}}}}
```

**Ассоциация:** Как антивирус. Ищет паттерны атак.

---

## Блок 10: Миграция и выбор (5 мин)

### Миграция Elasticsearch → OpenSearch

**Процесс:**
1. **Snapshot** — делаешь бэкап индексов
2. **Развертываешь OpenSearch** — ставишь кластер
3. **Restore** — восстанавливаешь из snapshot
4. **Обновляешь клиенты** — меняешь URL
5. **Тестируешь** — проверяешь, что все работает

**Совместимость:** OpenSearch совместим с Elasticsearch 7.x API. Миграция безболезненная.

**Ассоциация:** Как переезд из одной квартиры в другую. Упаковал вещи, перевез, распаковал.

### Когда выбрать Elasticsearch

✅ Нужна коммерческая поддержка  
✅ Используете Elastic Cloud  
✅ Нужны специфичные фичи (Canvas, Elastic APM)  
✅ Уже на Elastic Stack  
✅ Зрелая SIEM платформа  

**Ассоциация:** Как купить iPhone. Дорого, но работает из коробки.

### Когда выбрать OpenSearch

✅ Важна открытая лицензия (импортозамещение)  
✅ Инфраструктура на AWS  
✅ Нужны все фичи бесплатно  
✅ Хотите избежать vendor lock-in  
✅ Community-driven развитие  

**Ассоциация:** Как купить Android. Дешевле, гибче, открытее.

---

## Заключение (5 мин)

### Выводы

**Технически:** Очень похожи. Общий корень (Lucene), одинаковая архитектура.

**Лицензия:** OpenSearch полностью открыт (Apache 2.0), Elasticsearch — SSPL (ограничения).

**Экосистема:** Elasticsearch более зрелая (10+ лет), OpenSearch активно развивается (с 2021).

**Стоимость:** OpenSearch потенциально дешевле (все бесплатно), Elasticsearch — платные фичи.

**Выбор:** Зависит от ваших требований, инфраструктуры, бюджета.

### Практические советы

1. **Начинайте с малого** — один индекс, один шард, потом масштабируйте
2. **Мониторьте** — следите за CPU, RAM, disk I/O
3. **Оптимизируйте запросы** — используйте filter вместо must где можно
4. **Настраивайте маппинги** — правильные типы полей = быстрый поиск
5. **Тестируйте на реальных данных** — синтетика не покажет реальную картину

### Ресурсы

- Elasticsearch: elastic.co/guide
- OpenSearch: opensearch.org/docs
- Lucene: lucene.apache.org
- Бенчмарки: opensearch.org/benchmarks

**Оба — отличные решения для поиска и аналитики. Выбирайте по своим потребностям!**

---

## Вопросы? (5 мин)

Время для вопросов. Спрашивайте, не стесняйтесь!
