

OpenSearch — это распределенная поисковая и аналитическая система, поддерживающая различные сценарии использования, от реализации поисковой строки на веб-сайте до анализа данных безопасности для обнаружения угроз. Термин «распределенная» означает, что OpenSearch можно запускать на нескольких компьютерах. «Поиск и аналитика» означает, что вы можете искать и анализировать свои данные после их загрузки в OpenSearch. Независимо от типа ваших данных, вы можете хранить и анализировать их с помощью OpenSearch.

Документ
Документ — это единица, хранящая информацию (текст или структурированные данные). В OpenSearch документы хранятся в формате JSON .

Документ можно рассматривать несколькими способами:

В базе данных студентов один документ может представлять одного студента.
При поиске информации OpenSearch выдает документы, связанные с вашим запросом.
Документ представляет собой строку в традиционной базе данных.
Например, в школьной базе данных документ может представлять одного ученика и содержать следующие данные.

ИДЕНТИФИКАТОР	Имя	Средний балл	Год окончания обучения
1	Джон Доу	3.89	2022
Вот как выглядит этот документ в формате JSON:

{
  "name": "John Doe",
  "gpa": 3.89,
  "grad_year": 2022
}
Вы узнаете о том, как присваиваются идентификаторы документам при индексировании документов .

Индекс
Индекс — это набор документов.

Индекс можно рассматривать в нескольких смыслах:

В базе данных студентов индекс представляет всех студентов, содержащихся в этой базе данных.
При поиске информации вы запрашиваете данные, содержащиеся в индексе.
Индекс представляет собой таблицу базы данных в традиционной базе данных.
Например, в школьной базе данных индекс может содержать информацию обо всех учениках школы.

ИДЕНТИФИКАТОР	Имя	Средний балл	Год окончания обучения
1	Джон Доу	3.89	2022
2	Джонатан Пауэрс	3.85	2025
3	Джейн Доу	3.52	2024
…	 	 	 
Кластеры и узлы
OpenSearch разработан как распределенная поисковая система, то есть она может работать на одном или нескольких узлах — серверах, которые хранят ваши данные и обрабатывают поисковые запросы. Кластер OpenSearch — это набор узлов.

OpenSearch можно запустить локально на ноутбуке — системные требования минимальны — но вы также можете масштабировать один кластер до сотен мощных машин в центре обработки данных.

В одноузловом кластере, например, развернутом на ноутбуке, одна машина должна выполнять все задачи: управлять состоянием кластера, индексировать и искать данные, а также выполнять любую предварительную обработку данных перед индексированием. Однако по мере роста кластера можно разделить обязанности. Узлы с быстрыми дисками и большим объемом оперативной памяти могут хорошо справляться с индексированием и поиском данных, в то время как узел с достаточной вычислительной мощностью и небольшим диском может управлять состоянием кластера.

В каждом кластере есть избранный узел- менеджер кластера , который координирует операции на уровне кластера, такие как создание индекса. Узлы взаимодействуют друг с другом, поэтому, если ваш запрос направляется на узел, этот узел отправляет запросы другим узлам, собирает ответы от этих узлов и возвращает окончательный ответ.

Для получения дополнительной информации о других типах узлов см. раздел «Формирование кластера» .

Осколки
OpenSearch разделяет индексы на сегменты . Каждый сегмент хранит подмножество всех документов в индексе, как показано на следующем изображении.

![alt text](image.png)

Шарды используются для равномерного распределения данных между узлами кластера. Например, индекс размером 400 ГБ может быть слишком большим для обработки любым отдельным узлом в вашем кластере, но, разделив его на 10 шардов по 40 ГБ каждый, OpenSearch может распределить шарды по 10 узлам и управлять каждым шардом индивидуально. Рассмотрим кластер с двумя индексами: индексом 1 и индексом 2. Индекс 1 разделен на 2 шарда, а индекс 2 — на 4 шарда. Шарды распределены между узлами 1 и 2, как показано на следующем изображении.

![alt text](image-1.png)


Несмотря на то, что каждый шард является частью индекса OpenSearch, на самом деле это полноценный индекс Lucene. Эта деталь важна, поскольку каждый экземпляр Lucene — это запущенный процесс, потребляющий ресурсы процессора и памяти. Большее количество шардов не обязательно лучше. Например, разделение индекса размером 400 ГБ на 1000 шардов создаст излишнюю нагрузку на кластер. Хорошее эмпирическое правило — ограничивать размер шардов 10–50 ГБ.

Основные и реплицированные осколки
В OpenSearch сегмент может быть либо первичным (исходным), либо репликой ( копией). По умолчанию OpenSearch создает реплику для каждого первичного сегмента. Таким образом, если вы разделите свой индекс на 10 сегментов, OpenSearch создаст 10 реплик. Например, рассмотрим кластер, описанный в предыдущем разделе. Если вы добавите по 1 реплике для каждого сегмента каждого индекса в кластере, ваш кластер будет содержать в общей сложности 2 сегмента и 2 реплики для индекса 1 и 4 сегмента и 4 реплики для индекса 2, как показано на следующем изображении.

![alt text](image-2.png)


Эти реплики шардов действуют как резервные копии в случае сбоя узла — OpenSearch распределяет реплики шардов по разным узлам, отличным от соответствующих им основных шардов, — но они также повышают скорость обработки поисковых запросов кластером. Для ресурсоемких поисковых задач можно указать более одной реплики на каждый индекс.

Инвертированный индекс
Индекс OpenSearch использует структуру данных, называемую инвертированным индексом . Инвертированный индекс сопоставляет слова с документами, в которых они встречаются. Например, рассмотрим индекс, содержащий следующие два документа:

Документ 1: «Красота в глазах смотрящего»
Документ 2: «Красавица и чудовище»
Инвертированный индекс для такого индекса сопоставляет слова с документами, в которых они встречаются:

Слово	Документ
красота	1, 2
является	1
в	1
тот	1, 2
глаз	1
из	1
наблюдатель	1
и	2
зверь	2
Помимо идентификатора документа, OpenSearch сохраняет позицию слова в документе для выполнения фразовых запросов, где слова должны располагаться рядом друг с другом.

Релевантность
При поиске документа OpenSearch сопоставляет слова в запросе со словами в документе. Например, если вы выполните поиск в индексе, описанном в предыдущем разделе, по слову beauty, OpenSearch вернет документы 1 и 2. Каждому документу присваивается оценка релевантности , которая показывает, насколько хорошо документ соответствует запросу.

Отдельные слова в поисковом запросе называются поисковыми терминами . Каждый поисковый термин оценивается по следующим правилам:

Поисковый запрос, который встречается в документе чаще, как правило, получает более высокий балл. Документ о собаках, в котором это слово встречается dogмного раз, скорее всего, будет более релевантным, чем документ, в котором оно встречается dogреже. Это компонент частоты встречаемости термина в оценке.

Поисковый запрос, встречающийся в большем количестве документов, как правило, получает более низкий балл. Запрос с использованием терминов blueдолжен axolotlотдавать предпочтение документам, содержащим axolotlслово «», а не, вероятно, более распространенному слову «» blue. Это обратная составляющая частоты встречаемости документа в оценке.

Совпадение с более длинным документом, как правило, оценивается ниже, чем совпадение с более коротким документом. Документ, содержащий полный словарь, будет соответствовать любому слову, но не будет иметь большого отношения к какому-либо конкретному слову. Это соответствует компоненту нормализации длины при оценке.

OpenSearch использует алгоритм ранжирования BM25 для вычисления показателей релевантности документов, а затем возвращает результаты, отсортированные по релевантности. Для получения дополнительной информации см. Okapi BM25 .

