# üöÄ –®–ø–∞—Ä–≥–∞–ª–∫–∞ SQLAlchemy 2.x

## üì¶ –ë–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

```python
from sqlalchemy import create_engine, select, func, update, cast, String
from sqlalchemy.orm import Session, DeclarativeBase, Mapped, mapped_column

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–≤–∏–∂–∫–∞
engine = create_engine("postgresql://user:pass@localhost/db")

# –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –º–æ–¥–µ–ª–µ–π
class Base(DeclarativeBase):
    pass
```

## üîç 1. –ü—Ä–æ—Å—Ç—ã–µ –∑–∞–ø—Ä–æ—Å—ã (SELECT)

### 1.1 –í—ã–±—Ä–∞—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏
```python
with Session(engine) as session:
    stmt = select(Model)
    results = session.execute(stmt).scalars().all()
```

### 1.2 –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è (WHERE)
```python
stmt = select(Model).where(Model.field > 500)
stmt = select(Model).where(Model.name == "value")
```

### 1.3 –ê–≥—Ä–µ–≥–∞—Ü–∏—è (COUNT, SUM, AVG, MAX, MIN)
```python
# COUNT
stmt = select(func.count(Model.id))
count = session.execute(stmt).scalar()

# SUM
stmt = select(func.sum(Model.amount))

# AVG
stmt = select(func.avg(Model.value))

# MAX/MIN
stmt = select(func.max(Model.stars))
```

### 1.4 –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏ –ª–∏–º–∏—Ç
```python
stmt = select(Model).order_by(Model.stars.desc()).limit(1)
stmt = select(Model).order_by(Model.name.asc())
```

## üîó 2. JOIN –∏ —Å–≤—è–∑–∏

### 2.1 INNER JOIN
```python
stmt = (
    select(Model1.field, Model2.field)
    .join(Model2)  # –ü–æ ForeignKey
    .where(Model1.id == 1)
)
```

### 2.2 JOIN —Å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π
```python
stmt = (
    select(
        Model1.name,
        func.sum(Model2.count).label("total")
    )
    .join(Model2)
    .group_by(Model1.id)
)
```

### 2.3 –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ JOIN
```python
stmt = (
    select(Model1.name, Model2.name, Model3.name)
    .select_from(Model1)
    .join(Model2)
    .join(Model3)
    .where(Model3.status == "active")
)
```

## üìä 3. JSON –ø–æ–ª—è (PostgreSQL)

### 3.1 –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ JSON
```python
# –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ JSON
stmt = select(Model).where(
    cast(Model.metadata['language'], String) == 'Python'
)
```

### 3.2 –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ JSON –ø–æ–ª—é
```python
stmt = (
    select(
        cast(Model.metadata['language'], String).label('lang'),
        func.count().label('count')
    )
    .group_by(cast(Model.metadata['language'], String))
)
```

### 3.3 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ JSON
```python
new_data = {"language": "Python", "tags": ["web", "api"]}
stmt = (
    update(Model)
    .where(Model.name == "project")
    .values(metadata=new_data)
)
session.execute(stmt)
session.commit()
```

## üéØ 4. –ü–æ–¥–∑–∞–ø—Ä–æ—Å—ã (Subqueries)

### 4.1 –ü–æ–¥–∑–∞–ø—Ä–æ—Å –≤ FROM
```python
subq = (
    select(
        Model.user_id,
        func.sum(Model.count).label('total')
    )
    .group_by(Model.user_id)
    .subquery()
)

stmt = (
    select(User.name, subq.c.total)
    .join(subq, User.id == subq.c.user_id)
    .order_by(subq.c.total.desc())
)
```

### 4.2 –ü–æ–¥–∑–∞–ø—Ä–æ—Å –≤ WHERE
```python
avg_subq = select(func.avg(Model.value))

stmt = select(Model).where(Model.value > avg_subq)
```

## ü™ü 5. Window —Ñ—É–Ω–∫—Ü–∏–∏

### 5.1 RANK()
```python
stmt = (
    select(
        Model.name,
        func.sum(Model.count).label('total'),
        func.rank().over(
            order_by=func.sum(Model.count).desc()
        ).label('rank')
    )
    .group_by(Model.id, Model.name)
)
```

### 5.2 ROW_NUMBER()
```python
stmt = select(
    Model.name,
    func.row_number().over(
        partition_by=Model.category,
        order_by=Model.date.desc()
    ).label('row_num')
)
```

## üìù 6. CTE (Common Table Expressions)

```python
# –°–æ–∑–¥–∞–Ω–∏–µ CTE
avg_cte = (
    select(func.avg(Model.value).label('avg_val'))
    .cte('avg_values')
)

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CTE
stmt = (
    select(Model.name, Model.value)
    .where(Model.value > select(avg_cte.c.avg_val))
)
```

## ‚úèÔ∏è 7. UPDATE –∏ DELETE

### 7.1 UPDATE
```python
stmt = (
    update(Model)
    .where(Model.id == 1)
    .values(name="New Name", status="active")
)
session.execute(stmt)
session.commit()
```

### 7.2 DELETE
```python
from sqlalchemy import delete

stmt = delete(Model).where(Model.status == "inactive")
session.execute(stmt)
session.commit()
```

## üîß 8. –ü–æ–ª–µ–∑–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

### 8.1 DISTINCT
```python
stmt = select(Model.category).distinct()
```

### 8.2 HAVING
```python
stmt = (
    select(Model.category, func.count())
    .group_by(Model.category)
    .having(func.count() > 5)
)
```

### 8.3 CASE (—É—Å–ª–æ–≤–∏—è)
```python
from sqlalchemy import case

stmt = select(
    Model.name,
    case(
        (Model.value > 100, "high"),
        (Model.value > 50, "medium"),
        else_="low"
    ).label('level')
)
```

## üìÖ 9. –†–∞–±–æ—Ç–∞ —Å –¥–∞—Ç–∞–º–∏

```python
from datetime import date, datetime

# –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –¥–∞—Ç–µ
stmt = select(Model).where(Model.created_at >= date(2025, 1, 1))

# –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –≥–æ–¥–∞
stmt = select(func.extract('year', Model.created_at))

# –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞
stmt = select(func.current_date())
```

## üí° 10. –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

### 10.1 –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä
```python
with Session(engine) as session:
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π close()
    stmt = select(Model)
    results = session.execute(stmt).scalars().all()
```

### 10.2 –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
```python
# –û–¥–∏–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç
result = session.execute(stmt).scalar()  # –û–¥–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ
result = session.execute(stmt).scalar_one()  # –û—à–∏–±–∫–∞ –µ—Å–ª–∏ –Ω–µ—Ç

# –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞
result = session.execute(stmt).first()

# –í—Å–µ —Å—Ç—Ä–æ–∫–∏
results = session.execute(stmt).all()

# –¢–æ–ª—å–∫–æ ORM –æ–±—ä–µ–∫—Ç—ã
results = session.execute(stmt).scalars().all()
```

### 10.3 –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
```python
with Session(engine) as session:
    try:
        session.add(obj1)
        session.add(obj2)
        session.commit()
    except:
        session.rollback()
        raise
```

## üéì –®–ø–∞—Ä–≥–∞–ª–∫–∞ –ø–æ –∑–∞–¥–∞–Ω–∏—è–º

| –ó–∞–¥–∞–Ω–∏–µ | –ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ |
|---------|------------------|
| 1.1 | `select()`, `.scalars()` |
| 1.2 | `.where()`, —É—Å–ª–æ–≤–∏—è |
| 1.3 | `.where()`, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è |
| 1.4 | `func.count()` |
| 1.5 | `.order_by()`, `.limit()` |
| 2.1 | `.join()`, `func.sum()`, `.group_by()` |
| 2.2 | `cast()`, JSON –ø–æ–ª—è |
| 2.3 | `.select_from()`, –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ JOIN |
| 2.4 | JSON, `.group_by()` |
| 2.5 | `.distinct()`, –¥–∞—Ç—ã |
| 3.1 | `.subquery()`, –ø–æ–¥–∑–∞–ø—Ä–æ—Å—ã |
| 3.2 | `func.rank().over()`, window —Ñ—É–Ω–∫—Ü–∏–∏ |
| 3.3 | `.cte()`, CTE |
| 3.4 | `update()`, JSON |
| 3.5 | –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∑–∞–ø—Ä–æ—Å, `.having()` |
